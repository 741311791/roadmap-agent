# æ•°æ®åº“ä¼šè¯ä½¿ç”¨è§„èŒƒ

> **åˆ›å»ºæ—¶é—´**: 2025-12-31  
> **é€‚ç”¨èŒƒå›´**: åç«¯æ‰€æœ‰æ•°æ®åº“äº¤äº’ä»£ç   
> **ç›®æ ‡**: ç»Ÿä¸€ä¼šè¯åˆ›å»ºæ¨¡å¼ï¼Œé¿å…è¿æ¥æ³„æ¼å’Œäº‹åŠ¡æ··ä¹±

---

## ğŸ“‹ æ ¸å¿ƒåŸåˆ™

### 1. Repository å±‚ä¸è‡ªåŠ¨ Commit

**âŒ é”™è¯¯ç¤ºä¾‹**:
```python
async def save_roadmap(self, roadmap_id: str, data: dict):
    # ...æ•°æ®æ“ä½œ...
    await self.session.commit()  # âŒ Repository ä¸åº”è¯¥ commit
    return result
```

**âœ… æ­£ç¡®ç¤ºä¾‹**:
```python
async def save_roadmap(self, roadmap_id: str, data: dict):
    # ...æ•°æ®æ“ä½œ...
    await self.session.flush()  # âœ… åª flushï¼Œä¸ commit
    await self.session.refresh(result)
    return result
    # ç”±è°ƒç”¨è€…å†³å®šä½•æ—¶ commit
```

**åŸå› **:
- Repository å±‚åªè´Ÿè´£æ•°æ®è®¿é—®é€»è¾‘ï¼Œä¸æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ
- å…è®¸è·¨ Repository çš„åŸå­æ€§æ“ä½œ
- å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°
- ç®€åŒ–å›æ»šé€»è¾‘

---

## ğŸ¯ åœºæ™¯åˆ†ç±»ä¸æœ€ä½³å®è·µ

### åœºæ™¯ 1: FastAPI è¯·æ±‚å¤„ç†ï¼ˆæ¨èï¼šä¾èµ–æ³¨å…¥ï¼‰

**ä½¿ç”¨å‡½æ•°**: `get_db()`

**ç‰¹ç‚¹**:
- è‡ªåŠ¨å¤„ç† commit/rollback
- å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»š
- è¯·æ±‚ç»“æŸæ—¶è‡ªåŠ¨å…³é—­è¿æ¥

**ç¤ºä¾‹**:
```python
from app.db.session import get_db

@router.post("/roadmaps")
async def create_roadmap(
    request: CreateRoadmapRequest,
    db: AsyncSession = Depends(get_db),
):
    repo = RoadmapRepository(db)
    
    # æ‰§è¡Œå¤šä¸ª Repository æ“ä½œ
    roadmap = await repo.save_roadmap_metadata(...)
    await repo.save_tutorials_batch(...)
    
    # âœ… ä¸éœ€è¦æ‰‹åŠ¨ commitï¼Œget_db() ä¼šè‡ªåŠ¨å¤„ç†
    return {"roadmap_id": roadmap.roadmap_id}
```

---

### åœºæ™¯ 2: Celery åå°ä»»åŠ¡ï¼ˆæ¨èï¼šå¸¦é‡è¯•æœºåˆ¶ï¼‰

**ä½¿ç”¨å‡½æ•°**: `safe_session_with_retry()`

**ç‰¹ç‚¹**:
- è‡ªåŠ¨é‡è¯•è¿æ¥å¤±è´¥ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
- éœ€è¦æ‰‹åŠ¨ commit
- é€‚åˆé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡

**ç¤ºä¾‹**:
```python
from app.db.session import safe_session_with_retry

@celery_app.task
async def generate_content_task(task_id: str, roadmap_id: str):
    async with safe_session_with_retry() as session:
        repo = RoadmapRepository(session)
        
        # æ‰§è¡Œæ•°æ®åº“æ“ä½œ
        await repo.update_task_status(task_id, "processing", "content_generation")
        
        # âœ… å¿…é¡»æ‰‹åŠ¨ commit
        await session.commit()
```

---

### åœºæ™¯ 3: å·¥ä½œæµç¼–æ’å™¨ï¼ˆæ¨èï¼šæ‰‹åŠ¨ç®¡ç†ï¼‰

**ä½¿ç”¨å‡½æ•°**: `AsyncSessionLocal()`

**ç‰¹ç‚¹**:
- å®Œå…¨æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ
- é€‚åˆå¤æ‚çš„å¤šæ­¥éª¤æ“ä½œ
- éœ€è¦æ‰‹åŠ¨ commit å’Œ rollback

**ç¤ºä¾‹**:
```python
from app.db.session import AsyncSessionLocal

async def workflow_step(self, task_id: str):
    async with AsyncSessionLocal() as session:
        repo = RoadmapRepository(session)
        
        try:
            # ç¬¬ä¸€æ­¥ï¼šä¿å­˜æ„å›¾åˆ†æç»“æœ
            await repo.save_intent_analysis_metadata(...)
            
            # ç¬¬äºŒæ­¥ï¼šåˆ›å»ºè·¯çº¿å›¾
            await repo.save_roadmap_metadata(...)
            
            # ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°ä»»åŠ¡çŠ¶æ€
            await repo.update_task_status(...)
            
            # âœ… æ‰€æœ‰æ“ä½œæˆåŠŸåç»Ÿä¸€ commit
            await session.commit()
            
        except Exception as e:
            # âŒ å‡ºé”™æ—¶å›æ»š
            await session.rollback()
            raise
```

---

### åœºæ™¯ 4: ç‹¬ç«‹æœåŠ¡ï¼ˆæ¨èï¼šå¸¦é‡è¯•ï¼‰

**ä½¿ç”¨å‡½æ•°**: `safe_session_with_retry()`

**ç‰¹ç‚¹**:
- ä¸å½±å“ä¸»æµç¨‹çš„ç‹¬ç«‹æ“ä½œ
- ä¾‹å¦‚ï¼šå°é¢å›¾ç”Ÿæˆã€é€šçŸ¥å‘é€ç­‰
- éœ€è¦æ‰‹åŠ¨ commit

**ç¤ºä¾‹**:
```python
from app.db.session import safe_session_with_retry

async def generate_cover_image(roadmap_id: str):
    """ç”Ÿæˆå°é¢å›¾ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼Œå¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼‰"""
    async with safe_session_with_retry() as session:
        repo = RoadmapRepository(session)
        
        # ç”Ÿæˆå¹¶ä¿å­˜å°é¢å›¾
        cover_url = await _generate_image(roadmap_id)
        await repo.update_roadmap_cover(roadmap_id, cover_url)
        
        # âœ… æ‰‹åŠ¨ commit
        await session.commit()
```

---

## ğŸš« åæ¨¡å¼ä¸é¿å…

### åæ¨¡å¼ 1: æ··åˆä½¿ç”¨å¤šç§ä¼šè¯åˆ›å»ºæ–¹å¼

**âŒ é”™è¯¯ç¤ºä¾‹**:
```python
# æ–‡ä»¶ A
async with AsyncSessionLocal() as session:
    ...

# æ–‡ä»¶ Bï¼ˆç›¸åŒåœºæ™¯ï¼‰
async with safe_session() as session:
    ...
```

**âœ… æ­£ç¡®åšæ³•**: åŒä¸€åœºæ™¯ä½¿ç”¨ç›¸åŒçš„ä¼šè¯åˆ›å»ºæ–¹å¼ã€‚

---

### åæ¨¡å¼ 2: åµŒå¥—ä¼šè¯

**âŒ é”™è¯¯ç¤ºä¾‹**:
```python
async with safe_session_with_retry() as session1:
    repo1 = RoadmapRepository(session1)
    
    # âŒ åœ¨å†…éƒ¨åˆåˆ›å»ºäº†æ–°ä¼šè¯
    async with safe_session_with_retry() as session2:
        repo2 = RoadmapRepository(session2)
        await repo2.do_something()
        await session2.commit()
    
    await repo1.do_something()
    await session1.commit()
```

**âœ… æ­£ç¡®åšæ³•**: ä½¿ç”¨åŒä¸€ä¸ªä¼šè¯å®Œæˆæ‰€æœ‰æ“ä½œã€‚

---

### åæ¨¡å¼ 3: å¿˜è®° commit

**âŒ é”™è¯¯ç¤ºä¾‹**:
```python
async with safe_session_with_retry() as session:
    repo = RoadmapRepository(session)
    await repo.save_roadmap_metadata(...)
    # âŒ å¿˜è®° commitï¼Œæ•°æ®ä¸ä¼šä¿å­˜
```

**âœ… æ­£ç¡®åšæ³•**: ä½¿ç”¨éœ€è¦æ‰‹åŠ¨ commit çš„ä¼šè¯æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨ `await session.commit()`ã€‚

---

## ğŸ“Š ä¼šè¯åˆ›å»ºæ–¹å¼å¯¹æ¯”è¡¨

| åˆ›å»ºæ–¹å¼ | ä½¿ç”¨åœºæ™¯ | è‡ªåŠ¨ Commit | é‡è¯•æœºåˆ¶ | é”™è¯¯å¤„ç† |
|---------|---------|------------|---------|---------|
| `get_db()` | FastAPI ç«¯ç‚¹ | âœ… æ˜¯ | âŒ å¦ | è‡ªåŠ¨å›æ»š |
| `safe_session_with_retry()` | Celery ä»»åŠ¡ | âŒ å¦ï¼ˆéœ€æ‰‹åŠ¨ï¼‰ | âœ… æ˜¯ï¼ˆ3æ¬¡ï¼‰ | æ‰‹åŠ¨å¤„ç† |
| `AsyncSessionLocal()` | å·¥ä½œæµç¼–æ’ | âŒ å¦ï¼ˆéœ€æ‰‹åŠ¨ï¼‰ | âŒ å¦ | æ‰‹åŠ¨å¤„ç† |
| `safe_session()` | ç®€å•åœºæ™¯ | âŒ å¦ï¼ˆéœ€æ‰‹åŠ¨ï¼‰ | âŒ å¦ | æ‰‹åŠ¨å¤„ç† |

---

## ğŸ” ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•

åœ¨ä»£ç å®¡æŸ¥æ—¶ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹å‡ ç‚¹ï¼š

- [ ] Repository æ–¹æ³•å†…æ²¡æœ‰ `await self.session.commit()`
- [ ] Repository æ–¹æ³•åªä½¿ç”¨ `await self.session.flush()` å’Œ `await self.session.refresh()`
- [ ] FastAPI ç«¯ç‚¹ä½¿ç”¨ `Depends(get_db)`
- [ ] Celery ä»»åŠ¡ä½¿ç”¨ `safe_session_with_retry()`ï¼Œä¸”æœ‰ `await session.commit()`
- [ ] å·¥ä½œæµç¼–æ’å™¨ä½¿ç”¨ `AsyncSessionLocal()`ï¼Œä¸”æœ‰å®Œæ•´çš„ try/except/commit/rollback
- [ ] æ²¡æœ‰åµŒå¥—ä¼šè¯
- [ ] æ‰€æœ‰æ‰‹åŠ¨ç®¡ç†çš„ä¼šè¯éƒ½æœ‰ commit æˆ–æ˜ç¡®è¯´æ˜ä¸ºä»€ä¹ˆä¸éœ€è¦ commit

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–è®¡åˆ’](./DB_OPTIMIZATION_PLAN.md)
- [SQLAlchemy 2.0 äº‹åŠ¡ç®¡ç†](https://docs.sqlalchemy.org/en/20/orm/session_transaction.html)
- [è¿æ¥æ± é…ç½®æŒ‡å—](https://docs.sqlalchemy.org/en/20/core/pooling.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-12-31  
**ç»´æŠ¤è€…**: Backend Team

