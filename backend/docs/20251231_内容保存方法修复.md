# Celery 内容保存方法修复

**问题发现时间**：2025-12-31 00:31:59  
**修复状态**：✅ 已修复

## 问题描述

Celery Worker 在内容生成任务中报错，无法保存 Tutorial、Resources 和 Quiz 数据：

```
[2025-12-31 00:31:59,037] tutorial_save_failed: 'RoadmapRepository' object has no attribute 'save_tutorial'
[2025-12-31 00:31:59,037] resources_save_failed: 'RoadmapRepository' object has no attribute 'save_resources'
[2025-12-31 00:31:59,038] quiz_save_failed: 'RoadmapRepository' object has no attribute 'save_quiz'
```

## 问题根因

在 `backend/app/tasks/concept_generator.py` 中，代码错误地使用了 `RoadmapRepository` 来保存三种内容类型的数据，但调用的方法名不存在：

| 错误调用 | 存在性 |
|---------|--------|
| `RoadmapRepository.save_tutorial()` | ❌ 不存在 |
| `RoadmapRepository.save_resources()` | ❌ 不存在 |
| `RoadmapRepository.save_quiz()` | ❌ 不存在 |

## 正确的 Repository 架构

项目中存在专门的 Repository 类，每个类负责特定类型的元数据：

| Repository 类 | 保存方法 | 用途 |
|--------------|---------|------|
| `TutorialRepository` | `save_tutorial()` | 保存教程元数据 |
| `ResourceRepository` | `save_resource_recommendation()` | 保存资源推荐元数据 |
| `QuizRepository` | `save_quiz()` | 保存测验元数据 |

## 修复内容

### 修复文件：`backend/app/tasks/concept_generator.py`

**修复前代码**（第 221-278 行）：

```python
from app.db.repositories.roadmap_repo import RoadmapRepository

async with safe_session_with_retry() as session:
    repo = RoadmapRepository(session)
    
    # 保存教程
    if tutorial:
        await repo.save_tutorial(...)  # ❌ 方法不存在
    
    # 保存资源
    if resource:
        await repo.save_resources(...)  # ❌ 方法不存在
    
    # 保存测验
    if quiz:
        await repo.save_quiz(...)  # ❌ 方法不存在
```

**修复后代码**：

```python
async with safe_session_with_retry() as session:
    # 保存教程 - 使用专门的 TutorialRepository
    if tutorial:
        from app.db.repositories.tutorial_repo import TutorialRepository
        tutorial_repo = TutorialRepository(session)
        await tutorial_repo.save_tutorial(
            tutorial_output=tutorial,
            roadmap_id=roadmap_id,
        )
    
    # 保存资源 - 使用专门的 ResourceRepository
    if resource:
        from app.db.repositories.resource_repo import ResourceRepository
        resource_repo = ResourceRepository(session)
        await resource_repo.save_resource_recommendation(
            resource_output=resource,
            roadmap_id=roadmap_id,
        )
    
    # 保存测验 - 使用专门的 QuizRepository
    if quiz:
        from app.db.repositories.quiz_repo import QuizRepository
        quiz_repo = QuizRepository(session)
        await quiz_repo.save_quiz(
            quiz_output=quiz,
            roadmap_id=roadmap_id,
        )
    
    await session.commit()
```

## 代码一致性

修复后的代码与项目中其他地方保持一致：

- ✅ `backend/app/tasks/content_retry_tasks.py` 已使用正确的 Repository
- ✅ `backend/app/tasks/content_generation_tasks.py` 使用批量保存方法
- ✅ 遵循单一职责原则（每个 Repository 管理一种元数据）

## 验证步骤

1. **检查语法**：
   ```bash
   # 已通过 linter 检查，无错误
   ```

2. **重启 Celery Worker**：
   ```bash
   cd backend
   uv run celery -A app.core.celery_app worker \
       --loglevel=info \
       --queues=content_generation \
       --concurrency=8 \
       --pool=prefork \
       --hostname=content@%h \
       --max-tasks-per-child=50
   ```

3. **观察日志**：
   - 应该看到 `tutorial_saved`、`resources_saved`、`quiz_saved` 日志
   - 不应再出现 `'RoadmapRepository' object has no attribute` 错误

## 影响范围

- ✅ **内容生成任务**：现在可以正确保存 Tutorial、Resources 和 Quiz 数据
- ✅ **数据库完整性**：确保生成的内容元数据被正确持久化
- ✅ **用户体验**：前端可以正确获取和显示生成的内容

## 技术总结

### 问题原因

1. **Repository 使用错误**：使用了错误的 Repository 类
2. **方法名不匹配**：调用了不存在的方法
3. **职责混淆**：`RoadmapRepository` 主要管理路线图元数据，不负责具体内容的保存

### 修复原则

1. **使用正确的 Repository**：每种内容类型使用对应的专门 Repository
2. **遵循单一职责**：让每个 Repository 只负责一种元数据的管理
3. **保持代码一致性**：与项目其他部分的实现保持一致

### 预防措施

1. **代码审查**：在修改 Repository 调用时，检查方法是否存在
2. **单元测试**：为 Repository 层添加测试，确保方法签名正确
3. **IDE 支持**：利用类型提示和 IDE 的自动补全功能避免此类错误

## 相关文件

- ✅ 已修复：`backend/app/tasks/concept_generator.py`
- ✅ 已验证：`backend/app/tasks/content_retry_tasks.py`（使用正确）
- ✅ 已验证：`backend/app/tasks/content_generation_tasks.py`（使用批量方法）
- ✅ Repository 实现：
  - `backend/app/db/repositories/tutorial_repo.py`
  - `backend/app/db/repositories/resource_repo.py`
  - `backend/app/db/repositories/quiz_repo.py`

## 状态

✅ **已完成修复**  
⏳ **等待重启 Celery Worker 验证**

