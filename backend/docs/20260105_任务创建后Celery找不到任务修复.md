# ä»»åŠ¡åˆ›å»ºå Celery Worker æ‰¾ä¸åˆ°ä»»åŠ¡ä¿®å¤

**é—®é¢˜**: è·¯çº¿å›¾ç”Ÿæˆä»»åŠ¡åˆ›å»ºåï¼ŒCelery Worker æŠ¥é”™ "Task not found in database after X retries"  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åˆ›å»ºè·¯çº¿å›¾ç”Ÿæˆä»»åŠ¡åï¼ŒCelery Worker åœ¨å¯åŠ¨æ—¶æ— æ³•åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°åˆšåˆ›å»ºçš„ä»»åŠ¡è®°å½•ï¼Œå³ä½¿ä»»åŠ¡è®°å½•ç¡®å®å­˜åœ¨äºæ•°æ®åº“ä¸­ã€‚

**é”™è¯¯ä¿¡æ¯**:
```
Task be3b19a0-ffea-47ce-b747-76fd57796750 not found in database after 5 retries
```

**å…³é”®è§‚å¯Ÿ**:
- ä»»åŠ¡è®°å½•**ç¡®å®å­˜åœ¨**äºæ•°æ®åº“ä¸­ï¼ˆé€šè¿‡ç›´æ¥æŸ¥è¯¢éªŒè¯ï¼‰
- Celery Worker åœ¨ 5 æ¬¡é‡è¯•åä»ç„¶æ‰¾ä¸åˆ°
- é—®é¢˜åå¤å‡ºç°ï¼Œä¸æ˜¯å¶å‘

---

## ğŸ” æ ¹å› åˆ†æ

### 1. `repo_factory.create_session()` å®ç°é—®é¢˜

åŸå®ç°ä½¿ç”¨ `async for session in get_db()` æ¥è·å– sessionï¼š

```python
@asynccontextmanager
async def create_session(self):
    async for session in get_db():
        try:
            yield session
        finally:
            pass
```

è¿™ç§å®ç°è™½ç„¶èƒ½å·¥ä½œï¼Œä½†åœ¨ä¸ `get_db()` ç”Ÿæˆå™¨äº¤äº’æ—¶ï¼Œäº‹åŠ¡è¾¹ç•Œä¸å¤Ÿæ¸…æ™°ã€‚

### 2. äº‹åŠ¡æäº¤ä¸ä»»åŠ¡åˆ†å‘æ—¶åºé—®é¢˜

åœ¨ `generation.py` ä¸­ï¼š
1. åˆ›å»ºä»»åŠ¡å¹¶ commit
2. ç«‹å³åˆ†å‘ Celery ä»»åŠ¡
3. Celery Worker å¼€å§‹æ‰§è¡Œï¼ŒæŸ¥è¯¢ä»»åŠ¡

é—®é¢˜åœ¨äºï¼šè™½ç„¶ commit è¢«è°ƒç”¨ï¼Œä½†åœ¨é«˜å¹¶å‘æˆ–æ•°æ®åº“è¿æ¥æ± å¤ç”¨çš„æƒ…å†µä¸‹ï¼Œåˆšæäº¤çš„æ•°æ®å¯èƒ½åœ¨å¦ä¸€ä¸ªè¿æ¥ä¸­çŸ­æš‚ä¸å¯è§ã€‚

### 3. é‡è¯•æœºåˆ¶ä¸å¤Ÿå¥å£®

åŸé‡è¯•é€»è¾‘ï¼š
- æœ€å¤š 5 æ¬¡é‡è¯•
- ç­‰å¾…æ—¶é—´ï¼š100ms, 200ms, 300ms, 400msï¼ˆæ€»è®¡çº¦ 1 ç§’ï¼‰

è¿™ä¸ªç­‰å¾…æ—¶é—´åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸å¤Ÿã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. é‡æ„ `repo_factory.create_session()`

æ”¹ç”¨ `safe_session_with_retry()` ç›´æ¥ç®¡ç† sessionï¼Œé¿å…ç”Ÿæˆå™¨äº¤äº’ï¼š

```python
@asynccontextmanager
async def create_session(self):
    from app.db.session import safe_session_with_retry
    
    async with safe_session_with_retry() as session:
        yield session
```

### 2. åœ¨åˆ†å‘ Celery ä»»åŠ¡å‰éªŒè¯æŒä¹…åŒ–

åœ¨ `generation.py` ä¸­å¢åŠ éªŒè¯æ­¥éª¤ï¼š

```python
# ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä»»åŠ¡å¹¶ commit
async with repo_factory.create_session() as session:
    await task_repo.create_task(...)
    await session.commit()

# ç¬¬äºŒæ­¥ï¼šéªŒè¯ä»»åŠ¡å·²æŒä¹…åŒ–ï¼ˆä½¿ç”¨æ–°çš„ sessionï¼‰
max_verify_retries = 5
for attempt in range(max_verify_retries):
    async with repo_factory.create_session() as session:
        task = await task_repo.get_by_task_id(task_id)
        if task:
            break
    await asyncio.sleep(0.05 * (attempt + 1))

if not task:
    raise HTTPException(500, "ä»»åŠ¡åˆ›å»ºå¤±è´¥ï¼šæ•°æ®åº“æŒä¹…åŒ–éªŒè¯å¤±è´¥")

# ç¬¬ä¸‰æ­¥ï¼šåˆ†å‘ Celery ä»»åŠ¡ï¼ˆæ­¤æ—¶ä»»åŠ¡å·²ç¡®è®¤å­˜åœ¨ï¼‰
celery_task = generate_roadmap.delay(...)
```

### 3. å¢å¼º Celery Worker é‡è¯•æœºåˆ¶

```python
max_retries = 10  # 5 â†’ 10
for attempt in range(max_retries):
    # ...æŸ¥è¯¢ä»»åŠ¡...
    if not task:
        base_wait = 0.2 * (attempt + 1)  # 200ms èµ·æ­¥ï¼ˆåŸ 100msï¼‰
        jitter = random.uniform(0, 0.1)  # éšæœºæŠ–åŠ¨
        await asyncio.sleep(base_wait + jitter)
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `app/db/repository_factory.py` | é‡æ„ `create_session()` ä½¿ç”¨ `safe_session_with_retry()` |
| `app/api/v1/endpoints/generation.py` | æ·»åŠ ä»»åŠ¡æŒä¹…åŒ–éªŒè¯é€»è¾‘ |
| `app/tasks/roadmap_generation_tasks.py` | å¢å¼ºé‡è¯•æœºåˆ¶ï¼ˆ10 æ¬¡é‡è¯•ï¼Œæ›´é•¿ç­‰å¾…æ—¶é—´ï¼‰ |

---

## ğŸ§ª éªŒè¯æ–¹æ³•

1. åˆ›å»ºè·¯çº¿å›¾ç”Ÿæˆä»»åŠ¡
2. è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤ï¼š
   - `task_created_and_committed` - ä»»åŠ¡åˆ›å»ºæˆåŠŸ
   - `task_persistence_verified` - æŒä¹…åŒ–éªŒè¯é€šè¿‡
   - `celery_task_dispatched` - Celery ä»»åŠ¡åˆ†å‘æˆåŠŸ
   - `task_record_found` - Worker æ‰¾åˆ°ä»»åŠ¡è®°å½•

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

- âœ… æ¶ˆé™¤ "Task not found in database" é”™è¯¯
- âœ… åœ¨åˆ†å‘ Celery ä»»åŠ¡å‰ç¡®ä¿æ•°æ®å·²æŒä¹…åŒ–
- âœ… æ›´å¥å£®çš„é‡è¯•æœºåˆ¶åº”å¯¹ç½‘ç»œå»¶è¿Ÿ
- âœ… è¯¦ç»†çš„æ—¥å¿—å¸®åŠ©è°ƒè¯•æœªæ¥å¯èƒ½çš„é—®é¢˜

