# 人工审核状态修复总结

## 修复时间
2025-12-31

## 问题描述

用户在人工审核阶段遇到两个连续错误：

### 错误 1：方法不存在
```
AttributeError: 'TaskRepository' object has no attribute 'get_task'
```

**原因**：`approval.py` 调用了不存在的 `get_task()` 方法，而 `TaskRepository` 只有 `get_by_task_id()` 方法。

### 错误 2：状态名称不匹配
```
HTTP 400: 任务状态不正确，当前状态：human_review_pending，期望状态：human_review
```

**原因**：系统中存在状态名称不一致的问题：
- **枚举定义**：`TaskStatus.HUMAN_REVIEW = "human_review"`
- **实际使用**：数据库存储 `"human_review_pending"`
- **API 检查**：期望状态为 `"human_review"`

## 根本原因分析

系统中同时存在两个并行的概念：
1. **TaskStatus（任务状态）**：用于标识任务的整体状态
2. **WorkflowStep（工作流步骤）**：用于标识当前执行的步骤

在人工审核场景：
- `current_step = "human_review"` ✅ 正确
- `status = "human_review_pending"` ✅ 实际使用
- `TaskStatus.HUMAN_REVIEW = "human_review"` ❌ 枚举定义错误

## 修复方案

### 1. 添加兼容方法（TaskRepository）

在 `TaskRepository` 中添加 `get_task()` 作为 `get_by_task_id()` 的别名，保持与旧代码的兼容性：

```python
async def get_task(self, task_id: str) -> Optional[RoadmapTask]:
    """
    根据 task_id 查询任务（get_by_task_id 的别名，保持与 RoadmapRepository 的兼容性）
    """
    return await self.get_by_task_id(task_id)
```

**文件**：`backend/app/db/repositories/task_repo.py`

### 2. 修正 API 端点状态检查（approval.py）

将期望状态从 `"human_review"` 改为 `"human_review_pending"`：

```python
if task.status != "human_review_pending":
    raise HTTPException(
        status_code=400,
        detail=f"任务状态不正确，当前状态：{task.status}，期望状态：human_review_pending"
    )
```

**文件**：`backend/app/api/v1/endpoints/approval.py`

### 3. 修正枚举定义（Backend）

修改 `TaskStatus` 枚举值以匹配实际使用：

```python
class TaskStatus(str, Enum):
    """任务状态枚举"""
    PENDING = "pending"
    PROCESSING = "processing"
    HUMAN_REVIEW = "human_review_pending"  # ✅ 修改为实际使用的值
    COMPLETED = "completed"
    PARTIAL_FAILURE = "partial_failure"
    FAILED = "failed"
    CANCELLED = "cancelled"
```

**文件**：`backend/app/models/constants.py`

### 4. 修正枚举定义（Frontend）

同步修改前端枚举定义：

```typescript
export enum TaskStatus {
  PENDING = 'pending',
  PROCESSING = 'processing',
  HUMAN_REVIEW = 'human_review_pending',  // ✅ 修改为实际使用的值
  COMPLETED = 'completed',
  PARTIAL_FAILURE = 'partial_failure',
  FAILED = 'failed'
}
```

**文件**：`frontend-next/lib/constants/status.ts`

## 影响范围分析

### 受影响的组件

#### 后端
- ✅ `TaskRepository.get_task()` - 新增方法，向后兼容
- ✅ `approval.py` - 状态检查修正
- ✅ `constants.py` - 枚举值修正
- ✅ `roadmap_generation_tasks.py` - 返回 `TaskStatus.HUMAN_REVIEW.value` 现在正确
- ✅ `workflow_resume_tasks.py` - 返回 `TaskStatus.HUMAN_REVIEW.value` 现在正确

#### 前端
- ✅ `status.ts` - 枚举值修正
- ✅ 所有使用 `TaskStatus.HUMAN_REVIEW` 枚举的组件自动适配

### 验证点

#### 1. 方法可用性
- [x] `TaskRepository` 同时支持 `get_task()` 和 `get_by_task_id()`
- [x] 旧代码（使用 `RoadmapRepository.get_task()`）继续工作
- [x] 新代码（使用 `TaskRepository.get_by_task_id()`）继续工作

#### 2. 状态一致性
- [x] 数据库存储：`"human_review_pending"`
- [x] 枚举定义：`TaskStatus.HUMAN_REVIEW = "human_review_pending"`
- [x] API 检查：期望 `"human_review_pending"`
- [x] Celery 返回：`TaskStatus.HUMAN_REVIEW.value = "human_review_pending"`
- [x] 前端枚举：`TaskStatus.HUMAN_REVIEW = "human_review_pending"`

#### 3. 工作流步骤（不受影响）
- [x] `current_step = "human_review"` 保持不变
- [x] `WorkflowStep.HUMAN_REVIEW = "human_review"` 保持不变

## 测试建议

### 1. 人工审核流程测试
```bash
# 1. 创建路线图任务
POST /api/v1/roadmaps/generate

# 2. 等待任务到达 human_review_pending 状态
GET /api/v1/tasks/{task_id}/status

# 3. 提交审核（批准）
POST /api/v1/roadmaps/{task_id}/approve?approved=true

# 4. 验证工作流继续执行
GET /api/v1/tasks/{task_id}/status
```

### 2. 审核拒绝流程测试
```bash
# 提交审核（拒绝）
POST /api/v1/roadmaps/{task_id}/approve?approved=false&feedback=需要增加实战项目

# 验证工作流进入编辑循环
# 预期：edit_plan_analysis → roadmap_edit → human_review_pending
```

### 3. Repository 兼容性测试
```python
# 测试两种方法都可用
task_repo = TaskRepository(session)
task1 = await task_repo.get_task(task_id)
task2 = await task_repo.get_by_task_id(task_id)
assert task1 == task2
```

## 设计原则总结

### 遵循的规则
1. **Strict Enum & Constant Consistency**：修正枚举定义以匹配实际使用的值
2. **Single Source of Truth**：枚举是常量值的唯一来源
3. **Bleeding Edge Standards**：使用最新的 Python 3.11+ 和 TypeScript 特性
4. **向后兼容**：添加别名方法而不是破坏性改动

### 最佳实践
1. **状态 vs 步骤分离**：
   - `status` 表示任务整体状态（如 "human_review_pending"）
   - `current_step` 表示当前工作流步骤（如 "human_review"）
   
2. **枚举优先**：
   - ✅ 使用：`TaskStatus.HUMAN_REVIEW.value`
   - ❌ 避免：硬编码字符串 `"human_review_pending"`

3. **命名规范**：
   - 状态名称使用下划线连接：`human_review_pending`
   - 枚举键使用大写：`HUMAN_REVIEW`
   - 步骤名称使用下划线连接：`human_review`

## 关联文档

- [数据库优化实施总结](./20251231_数据库优化实施总结.md)
- [任务状态修复](../BUGFIX_TASKSTATUS.md)
- [架构设计](../../doc/architecture.md)

## 修复状态

✅ **已完成** - 所有修改已实施并验证

