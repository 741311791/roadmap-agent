# 重试任务导入错误修复

## 问题描述

**报错现象：**
前端路线图详情页发起教程重新生成时，后端返回 500 错误：

```
ImportError: cannot import name 'retry_tutorial_task' from 'app.tasks.content_generation_tasks'
```

**根本原因：**
在 `app/api/v1/endpoints/generation.py` 中，三个重试任务（`retry_tutorial_task`、`retry_resources_task`、`retry_quiz_task`）的导入路径错误。这些任务实际位于 `app.tasks.content_retry_tasks` 模块，但代码却从 `app.tasks.content_generation_tasks` 导入。

## 错误发生位置

### generation.py 中的错误导入

1. **Line 692** - `retry_tutorial` 端点：
```python
from app.tasks.content_generation_tasks import retry_tutorial_task  # ❌ 错误
```

2. **Line 789** - `retry_resources` 端点：
```python
from app.tasks.content_generation_tasks import retry_resources_task  # ❌ 错误
```

3. **Line 929** - `retry_quiz` 端点：
```python
from app.tasks.content_generation_tasks import retry_quiz_task  # ❌ 错误
```

### 正确的模块结构

```
app/tasks/
├── content_generation_tasks.py  # 批量内容生成任务
│   ├── generate_all_concepts_content
│   ├── generate_single_concept_content
│   └── retry_failed_content_task  ✅ (正确在这里)
│
└── content_retry_tasks.py       # 单个内容重试任务
    ├── retry_tutorial_task      ✅ (应从这里导入)
    ├── retry_resources_task     ✅ (应从这里导入)
    └── retry_quiz_task          ✅ (应从这里导入)
```

## 解决方案

### 修复导入路径

```python
# ✅ 修复后：从正确的模块导入
from app.tasks.content_retry_tasks import retry_tutorial_task
from app.tasks.content_retry_tasks import retry_resources_task
from app.tasks.content_retry_tasks import retry_quiz_task
```

## 修改文件

- `backend/app/api/v1/endpoints/generation.py`
  - Line 692: 修复 `retry_tutorial_task` 导入
  - Line 789: 修复 `retry_resources_task` 导入
  - Line 929: 修复 `retry_quiz_task` 导入

## 影响范围

### 受影响的功能
- ✅ 路线图详情页 - 教程重新生成
- ✅ 路线图详情页 - 资源推荐重新生成
- ✅ 路线图详情页 - 测验重新生成

### 相关 API 端点
- `POST /api/v1/roadmaps/{roadmap_id}/concepts/{concept_id}/tutorial/retry`
- `POST /api/v1/roadmaps/{roadmap_id}/concepts/{concept_id}/resources/retry`
- `POST /api/v1/roadmaps/{roadmap_id}/concepts/{concept_id}/quiz/retry`

## 测试验证

**验证步骤：**
1. 打开路线图详情页，选择任意已完成的 Concept
2. 点击"Regenerate Tutorial"按钮
3. 确认后端成功接收请求，不再报 ImportError
4. 验证 WebSocket 事件正常推送
5. 确认新内容生成成功

**预期结果：**
- ✅ 不再出现 ImportError
- ✅ Celery 任务正常提交并执行
- ✅ WebSocket 实时推送生成进度
- ✅ 新内容保存到数据库

## 历史背景

这个错误可能是在代码重构过程中产生的：
- 原本所有任务都在 `content_generation_tasks.py` 中
- 后来为了更好的模块化，将重试任务拆分到独立文件 `content_retry_tasks.py`
- 但在 `generation.py` 中的导入语句未同步更新

## 预防措施

**建议改进：**
1. 在模块顶部统一导入，避免局部导入：
```python
# 在文件开头统一导入
from app.tasks.content_retry_tasks import (
    retry_tutorial_task,
    retry_resources_task,
    retry_quiz_task,
)
```

2. 添加单元测试验证导入路径：
```python
def test_retry_tasks_import():
    from app.tasks.content_retry_tasks import retry_tutorial_task
    assert retry_tutorial_task is not None
```

3. 使用类型提示，让 IDE 在重构时自动更新导入：
```python
from app.tasks.content_retry_tasks import retry_tutorial_task
task: Callable = retry_tutorial_task
```

