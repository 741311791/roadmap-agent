# 数据库字段引用错误修复

**问题发现时间**：2025-12-31  
**修复状态**：✅ 已修复

## 问题描述

API 请求 `/api/v1/users/{user_id}/tasks` 返回 500 错误：

```
AttributeError: id
File "/Users/louie/Documents/Vibecoding/roadmap-agent/backend/app/db/repositories/roadmap_repo.py", line 320, in count_tasks_by_status
    func.count(RoadmapTask.id).label('count')
               ^^^^^^^^^^^^^^
```

## 问题根因

在 `RoadmapRepository.count_tasks_by_status()` 方法中，代码尝试访问 `RoadmapTask.id` 字段，但该表的主键实际上是 `task_id`，而不是 `id`。

### 数据模型定义

```python
class RoadmapTask(SQLModel, table=True):
    """路线图生成任务表"""
    __tablename__ = "roadmap_tasks"
    
    task_id: str = Field(primary_key=True)  # ✅ 主键是 task_id
    user_id: str = Field(index=True)
    status: str = Field(default="pending")
    # ... 其他字段
```

### 错误代码

```python
query = (
    select(
        RoadmapTask.status,
        func.count(RoadmapTask.id).label('count')  # ❌ RoadmapTask 没有 id 字段
    )
    .where(RoadmapTask.user_id == user_id)
    .group_by(RoadmapTask.status)
)
```

## 修复内容

### 修复文件：`backend/app/db/repositories/roadmap_repo.py`

**修复位置**：第 320 行

**修复前**：
```python
func.count(RoadmapTask.id).label('count')  # ❌
```

**修复后**：
```python
func.count(RoadmapTask.task_id).label('count')  # ✅
```

### 完整修复代码

```python
async def count_tasks_by_status(
    self,
    user_id: str,
    task_type: Optional[str] = None,
) -> dict[str, int]:
    """
    统计用户各状态任务数量（使用 SQL GROUP BY，避免全表加载）
    
    Args:
        user_id: 用户 ID
        task_type: 任务类型筛选（可选）
        
    Returns:
        状态到数量的映射，例如 {"pending": 5, "processing": 3, "completed": 10}
    """
    query = (
        select(
            RoadmapTask.status,
            func.count(RoadmapTask.task_id).label('count')  # ✅ 修复：使用 task_id
        )
        .where(RoadmapTask.user_id == user_id)
        .group_by(RoadmapTask.status)
    )
    
    if task_type:
        query = query.where(RoadmapTask.task_type == task_type)
    
    result = await self.session.execute(query)
    return dict(result.fetchall())
```

## 验证范围

### ✅ 已确认：其他模型正确

检查了其他使用 `func.count()` 的地方，确认正确：

| 模型 | 主键字段 | 使用情况 | 状态 |
|-----|---------|---------|------|
| `ExecutionLog` | `id` | `func.count(ExecutionLog.id)` | ✅ 正确 |
| `RoadmapTask` | `task_id` | `func.count(RoadmapTask.task_id)` | ✅ 已修复 |

### 代码位置检查

```bash
# 检查所有使用 RoadmapTask.id 的地方
grep -r "RoadmapTask\.id" backend/

# 结果：
# - backend/scripts/test_intent_analysis.py  # 测试脚本（不影响生产）
# - backend/docs/DB_OPTIMIZATION_PLAN.md     # 文档（不影响生产）
```

✅ 生产代码中已无错误引用

## 影响范围

### 修复前影响

- ❌ 用户无法获取任务列表（API 返回 500 错误）
- ❌ 前端无法显示任务统计信息
- ❌ 影响用户查看路线图生成状态

### 修复后效果

- ✅ API 正常返回任务列表和状态统计
- ✅ 前端可以正确显示任务信息
- ✅ 用户可以查看路线图生成进度

## 测试验证

### API 测试

**请求**：
```bash
GET /api/v1/users/{user_id}/tasks?task_type=creation&limit=50&offset=0
```

**预期响应**：
```json
{
  "items": [...],
  "total": 10,
  "limit": 50,
  "offset": 0,
  "status_counts": {
    "pending": 2,
    "processing": 1,
    "completed": 7
  }
}
```

**状态码**：`200 OK` ✅

### 数据库查询验证

修复后的 SQL 查询：
```sql
SELECT 
    status, 
    COUNT(task_id) AS count
FROM roadmap_tasks
WHERE user_id = 'xxx'
GROUP BY status;
```

✅ 查询正确，使用了实际存在的 `task_id` 字段

## 技术总结

### 问题原因

1. **字段名误用**：错误地使用了不存在的 `id` 字段
2. **表设计差异**：不同表的主键字段名不一致（`RoadmapTask` 使用 `task_id`，而 `ExecutionLog` 使用 `id`）
3. **缺少类型检查**：SQLModel 在运行时才会抛出 `AttributeError`

### 解决方案

1. **使用正确字段名**：使用 `task_id` 而不是 `id`
2. **统一主键命名**：未来新表建议统一使用 `id` 作为主键（但保持现有表结构不变，避免破坏性修改）

### 预防措施

1. **代码审查**：在编写 SQL 查询时，确认字段名是否存在
2. **单元测试**：为 Repository 层添加测试，覆盖统计类查询
3. **IDE 支持**：利用 SQLModel 的类型提示，IDE 可以提前发现字段不存在的问题
4. **统一规范**：制定数据库表设计规范，统一主键字段命名

## 相关问题

### 为什么 RoadmapTask 使用 task_id 而不是 id？

可能的原因：
1. **语义清晰**：`task_id` 明确表示这是任务的标识符
2. **历史遗留**：早期设计时的命名习惯
3. **避免冲突**：避免与某些框架或工具的 `id` 字段冲突

### 是否需要重构为统一的 id？

**建议**：**不需要**
- ✅ 当前命名已经稳定，修改成本高
- ✅ `task_id` 语义更清晰
- ✅ 只需在代码中正确使用即可
- ⚠️ 修改主键字段名会影响：
  - 所有引用该字段的代码
  - 数据库迁移脚本
  - 外键关联（如果有）
  - 现有数据

## 相关文件

- ✅ 已修复：`backend/app/db/repositories/roadmap_repo.py`（第 320 行）
- ✅ 已验证：`backend/app/models/database.py`（RoadmapTask 定义）
- ✅ 已验证：`backend/app/api/v1/endpoints/users.py`（调用方）

## 状态

✅ **已完成修复并验证**

