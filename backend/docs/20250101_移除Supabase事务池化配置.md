# 移除 Supabase Transaction Pooling 配置

## 修改概述

移除所有针对 Supabase pgbouncer 事务模式的特殊处理代码，恢复标准 PostgreSQL 连接配置。

## 修改原因

1. **降低复杂度**：Supabase Transaction Pooling 需要大量特殊处理代码
2. **提升性能**：启用预编译语句缓存可显著提升重复查询性能
3. **简化维护**：移除约 100 行复杂的事件处理代码

## 修改详情

### 1. session.py 修改

#### 移除内容

1. **checkout 事件中的 DEALLOCATE ALL 逻辑**
   - 移除了从连接池取出连接时清理预编译语句的代码
   - 保留了 Prometheus 指标和连接时间记录

2. **checkin 事件中的 DEALLOCATE ALL 逻辑**
   - 移除了连接归还时清理预编译语句的代码
   - 保留了连接持有时长统计

3. **禁用预编译语句缓存的配置**
   ```python
   # 移除：
   "statement_cache_size": 0,
   "prepared_statement_cache_size": 0,
   ```

#### 启用功能

1. **连接健康检查**
   ```python
   # 修改前
   pool_pre_ping=False,  # 禁用健康检查
   
   # 修改后
   pool_pre_ping=True,  # 启用健康检查
   ```

2. **预编译语句缓存**
   - asyncpg 默认启用预编译语句缓存
   - 可提升重复查询性能

#### 更新文档

- 更新了函数和事件处理器的文档注释
- 移除所有提及 "Supabase Transaction Mode"、"pgbouncer" 的说明

### 2. celery_session.py 修改

#### 移除内容

1. **禁用预编译语句缓存的配置**
   ```python
   # 移除：
   "statement_cache_size": 0,
   "prepared_statement_cache_size": 0,
   ```

2. **模块文档中的 Supabase 相关说明**

#### 保留内容

- NullPool 配置（Celery Worker 进程隔离所需）
- 其他应用级配置

## 数据库连接要求

使用 PostgreSQL 直连端口，确保 `.env` 配置正确：

```env
# Supabase 直连格式（端口 5432，非 6543）
DATABASE_URL=postgresql+asyncpg://user:pass@db.xxx.supabase.co:5432/postgres

# 或自托管 PostgreSQL
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/dbname
```

## 预期效果

### 性能提升

- **预编译语句缓存**：重复查询可复用已编译的查询计划
- **减少网络往返**：无需每次连接时执行 DEALLOCATE ALL

### 代码简化

- 移除约 100 行复杂的事件处理代码
- 移除 `await_only` 在同步上下文中执行异步代码的复杂性
- 更易维护和调试

### 可靠性提升

- `pool_pre_ping=True` 自动检测失效连接
- 标准 PostgreSQL 配置更稳定可靠

## 注意事项

1. **不再兼容 Supabase Transaction Pooling**
   - 如果使用 Supabase，必须使用直连端口（5432）或 Session Pooling
   - Transaction Pooling（端口 6543）将无法正常工作

2. **需要重启服务**
   - 修改后需要重启 FastAPI 和 Celery Worker
   - 确保所有进程使用新的连接配置

3. **连接数监控**
   - 预编译语句会占用少量内存
   - 正常情况下不会有明显影响

## 相关文档

- 20250101_Celery_Worker进程初始化修复.md
- 20251231_Railway连接池耗尽修复.md

