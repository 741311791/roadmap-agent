# 内容生成保存失败修复

**日期**: 2025-12-31  
**类型**: Bug 修复  
**影响范围**: 后端 - 内容生成与重试  
**严重程度**: 高

---

## 问题描述

用户重试失败任务时报错：

```
无法重试此任务：
- 没有失败的 Concept 内容
- Checkpoint 存在但任务已完成内容生成
```

**数据库状态**：
- Task 状态：`failed`
- 错误：`IntegrityError: duplicate key value violates unique constraint "tutorial_metadata_pkey"`
- `failed_concepts` 字段：`null`
- `framework_data`：所有教程/资源/测验 ID 都为空

---

## 根本原因

### 问题链条

```
内容生成成功 (30+ concepts)
    ↓
_save_content_results (Phase 1: 分批保存)
    ↓
第 N 批保存失败 (IntegrityError)
    ↓
异常抛出 → Phase 2 未执行 (framework_data 未更新)
            → Phase 3 未执行 (failed_concepts 未记录)
    ↓
重试失败 (无法检测失败内容)
```

### 核心问题

1. **保存阶段容错不足**：任何批次失败都会导致整个流程中断
2. **状态更新缺失**：`framework_data` 和 `failed_concepts` 未被更新
3. **重试逻辑缺陷**：依赖未更新的 `framework_data` 判断失败项

---

## 解决方案

### 1. 增强保存阶段容错 (`content_generation_tasks.py`)

**Phase 1 - 分批保存**：
```python
# 为每个批次添加 try-except
try:
    await repo.save_tutorials_batch(batch, roadmap_id)
    await session.commit()
except (IntegrityError, DBAPIError) as e:
    logger.error("tutorial_batch_save_failed", ...)
    # 记录失败的概念到 failed_concepts
    for concept_id in batch.keys():
        failed_concepts.append(concept_id)
    continue  # 继续下一批
```

**Phase 2/3 - 强制执行**：
```python
# Phase 2: 更新 framework_data（必须执行）
try:
    # 更新逻辑
except Exception as e:
    logger.error(...)
    # 不抛出异常，继续 Phase 3

# Phase 3: 更新 task 状态（必须执行）
try:
    await repo.update_task_status(...)
except Exception as e:
    logger.error(...)
    # 不抛出异常
```

### 2. 修复重试逻辑 (`retry.py`)

添加数据库查询 Fallback：

```python
if total_items == 0:
    # framework_data 未更新，查询数据库
    all_concept_ids = [...]  # 从 framework_data 提取
    
    completed_tutorials = await roadmap_repo.get_tutorials_by_roadmap(...)
    completed_concept_ids = {...}
    
    missing_concept_ids = set(all_concept_ids) - completed_concept_ids
    
    # 为缺失的概念构造重试任务
    items_to_retry["tutorial"] = [...]
```

### 3. 修复代码错误

- **UnboundLocalError** (`retry.py` L375)：删除重复的 `RoadmapRepository` 导入
- **IndentationError** (`retry_service.py` L160)：统一 if-elif-else 缩进

---

## 修复效果

| 场景 | 修复前 | 修复后 |
|-----|-------|-------|
| 保存阶段部分失败 | ❌ 整个任务失败 | ✅ 成功部分保存，失败部分记录 |
| `failed_concepts` | ❌ `null` | ✅ 准确记录失败的概念 ID |
| `framework_data` | ❌ 未更新 | ✅ 始终更新（标记成功/失败） |
| 重试识别 | ❌ 无法识别 | ✅ framework_data + 数据库查询 |

---

## 测试步骤

重试失败任务：

```bash
POST /api/v1/tasks/65ccbb13-7688-4f3a-bc37-76c3519c672a/retry?user_id=921f1fa4-a1e5-4e6d-9ea3-237be1d2d969&force_checkpoint=false
```

**预期日志**：
1. `no_failed_items_in_framework_checking_database`
2. `found_missing_concepts_in_database`
3. 列出缺失的概念并开始重新生成

---

## 相关文件

**修改**：
- `backend/app/tasks/content_generation_tasks.py` (394-610 行)
- `backend/app/api/v1/endpoints/retry.py` (374-458 行)
- `backend/app/services/retry_service.py` (148-216 行)

**参考**：
- `20251231_教程批量保存主键冲突修复.md` (UPSERT 机制)
- `20251231_并发控制机制分析.md` (并发背景)
