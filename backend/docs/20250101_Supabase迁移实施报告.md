# Supabase æ•°æ®åº“ç»Ÿä¸€è¿ç§» - å®æ–½å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¥æœŸ**: 2025-01-01  
**çŠ¶æ€**: âœ… æ‰€æœ‰ä»£ç ä¿®æ”¹å·²å®Œæˆï¼Œå¾…ç”¨æˆ·é…ç½®ç¯å¢ƒå˜é‡å¹¶æµ‹è¯•

---

## ğŸ“‹ å®æ–½æ¸…å•

### âœ… å·²å®Œæˆçš„ä¿®æ”¹

1. **ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶** (`backend/env.supabase.example`)
   - åˆ›å»º Supabase è¿æ¥é…ç½®æ¨¡æ¿
   - åŒ…å«æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡è¯´æ˜
   - æä¾›é…ç½®è·å–æŒ‡å¼•

2. **Settings é…ç½®ç®€åŒ–** (`backend/app/config/settings.py`)
   - ç§»é™¤ `DATABASE_URL` çš„å¤æ‚å‚æ•°ï¼ˆä¿æŒç®€æ´ï¼‰
   - ç®€åŒ– `CHECKPOINTER_DATABASE_URL`ï¼ˆç§»é™¤ keepalives å’Œ statement_timeoutï¼‰
   - æ·»åŠ è¯¦ç»†çš„ Supabase Transaction Mode è¯´æ˜æ³¨é‡Š

3. **SQLAlchemy å¼•æ“é…ç½®** (`backend/app/db/session.py`)
   - æ–°å¢ `statement_cache_size=0`ï¼ˆç¦ç”¨ asyncpg é¢„å¤„ç†è¯­å¥ç¼“å­˜ï¼‰
   - æ–°å¢ `max_cached_statement_lifetime=0`ï¼ˆç¦ç”¨ç¼“å­˜ç”Ÿå‘½å‘¨æœŸï¼‰
   - æ›´æ–°æ³¨é‡Šè¯´æ˜ Supabase ä¼˜åŒ–åŸå› 
   - ä¿ç•™ `pool_pre_ping` å’Œ `pool_recycle` ç”¨äºäº‘ç«¯è¿æ¥ç®¡ç†

4. **Checkpointer è¿æ¥æ± é…ç½®** (`backend/app/core/orchestrator_factory.py`)
   - ç¡®è®¤ `prepare_threshold=0` å·²é…ç½®ï¼ˆç¦ç”¨ psycopg é¢„å¤„ç†è¯­å¥ï¼‰
   - æ›´æ–°æ³¨é‡Šè¯´æ˜ Supabase Transaction Mode è¦æ±‚
   - ä¼˜åŒ–è¿æ¥æ± å‚æ•°è¯´æ˜

5. **æµ‹è¯•è„šæœ¬** (`backend/scripts/test_supabase_connection.py`)
   - åˆ›å»ºå®Œæ•´çš„è¿æ¥æµ‹è¯•å·¥å…·
   - æµ‹è¯• asyncpg ç›´è¿ï¼ˆç¦ç”¨é¢„å¤„ç†è¯­å¥ï¼‰
   - æµ‹è¯• SQLAlchemy å¼•æ“é…ç½®
   - æµ‹è¯•è¿æ¥æ± çŠ¶æ€
   - æµ‹è¯• Checkpointer è¿æ¥

6. **æ–‡æ¡£æ›´æ–°**
   - åˆ›å»º `backend/docs/20250101_Supabaseæ•°æ®åº“ç»Ÿä¸€è¿ç§».md`ï¼ˆå®Œæ•´è¿ç§»æŒ‡å—ï¼‰
   - å½’æ¡£ `backend/docs/20250101_è¿æ¥æ± è€—å°½ä¿®å¤å†å².md`ï¼ˆå†å²æ–¹æ¡ˆå‚è€ƒï¼‰
   - åˆ é™¤ `backend/POOL_EXHAUSTION_FIX.md`ï¼ˆå·²å½’æ¡£ï¼‰

7. **æ¸…ç† PgBouncer ç›¸å…³æ–‡ä»¶**
   - âœ… åˆ é™¤ PgBouncer é…ç½®æ–‡ä»¶ï¼ˆä¸å­˜åœ¨æˆ–å·²æ¸…ç†ï¼‰
   - âœ… åˆ é™¤ PgBouncer è„šæœ¬æ–‡ä»¶ï¼ˆä¸å­˜åœ¨æˆ–å·²æ¸…ç†ï¼‰

---

## ğŸ” æ ¸å¿ƒæŠ€æœ¯ä¿®æ”¹ç‚¹

### 1. ç¦ç”¨é¢„å¤„ç†è¯­å¥ç¼“å­˜ï¼ˆCriticalï¼‰

**asyncpg (SQLAlchemy)**:
```python
connect_args={
    "statement_cache_size": 0,              # å¿…é¡»è®¾ä¸º 0
    "max_cached_statement_lifetime": 0,     # å¿…é¡»è®¾ä¸º 0
}
```

**psycopg (LangGraph Checkpointer)**:
```python
kwargs={
    "prepare_threshold": 0,  # å¿…é¡»è®¾ä¸º 0
}
```

**åŸå› **:
- Supabase Transaction Mode æ¯æ¬¡å¯èƒ½è¿”å›ä¸åŒçš„åç«¯è¿æ¥
- é¢„å¤„ç†è¯­å¥ç»‘å®šåˆ°ç‰¹å®šè¿æ¥ï¼Œä¼šå¯¼è‡´ `prepared statement does not exist` é”™è¯¯

### 2. ç®€åŒ–è¿æ¥ URL

**ä¿®æ”¹å‰**:
```python
# åŒ…å«å¤§é‡å‚æ•°
f"postgresql://...?keepalives=1&keepalives_idle=30&..."
```

**ä¿®æ”¹å**:
```python
# ç®€æ´çš„ URLï¼Œç”± Supabase ç®¡ç†è¿æ¥
f"postgresql://...@host:6543/db"
```

### 3. ç«¯å£é…ç½®

- **å¿…é¡»ä½¿ç”¨ç«¯å£ 6543**ï¼ˆTransaction Modeï¼‰
- ä¸ä½¿ç”¨ç«¯å£ 5432ï¼ˆSession Modeï¼Œä¸æ”¯æŒæˆ‘ä»¬çš„ç”¨ä¾‹ï¼‰

---

## ğŸš€ ç”¨æˆ·ä¸‹ä¸€æ­¥æ“ä½œ

### 1. è·å– Supabase è¿æ¥ä¿¡æ¯

ç™»å½• [Supabase Dashboard](https://supabase.com/dashboard):
1. é€‰æ‹©é¡¹ç›®
2. è¿›å…¥ **Project Settings** > **Database**
3. æ‰¾åˆ° **Connection String** éƒ¨åˆ†
4. é€‰æ‹© **Transaction Mode**ï¼ˆç«¯å£ 6543ï¼‰
5. å¤åˆ¶è¿æ¥ä¿¡æ¯

### 2. é…ç½®æœ¬åœ°ç¯å¢ƒå˜é‡

åˆ›å»º `backend/.env` æ–‡ä»¶ï¼ˆå‚è€ƒ `backend/env.supabase.example`ï¼‰:

```bash
# æ ¸å¿ƒé…ç½®
POSTGRES_HOST=aws-0-us-east-1.pooler.supabase.com
POSTGRES_PORT=6543
POSTGRES_USER=postgres.your_project_id
POSTGRES_PASSWORD=your_password
POSTGRES_DB=postgres

DB_POOL_SIZE=5
DB_MAX_OVERFLOW=10

# å…¶ä»–å¿…éœ€é…ç½®ï¼ˆAPI Keys, S3, Redis ç­‰ï¼‰
# å‚è€ƒ env.supabase.example
```

### 3. è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
cd backend
python scripts/test_supabase_connection.py
```

**é¢„æœŸè¾“å‡º**:
```
ğŸ§ª Supabase è¿æ¥é…ç½®æµ‹è¯•
============================================================
âœ… é€šè¿‡ - asyncpg ç›´è¿
âœ… é€šè¿‡ - SQLAlchemy å¼•æ“
âœ… é€šè¿‡ - è¿æ¥æ± é…ç½®
âœ… é€šè¿‡ - Checkpointer è¿æ¥

æ€»è®¡: 4/4 æµ‹è¯•é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Supabase è¿æ¥é…ç½®æ­£ç¡®ã€‚
```

### 4. å¯åŠ¨åº”ç”¨

å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œå¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼š

```bash
# ç»ˆç«¯ 1: FastAPI
uv run uvicorn app.main:app --workers 4 --reload --host 0.0.0.0 --port 8000

# ç»ˆç«¯ 2: Celery logs
uv run celery -A app.core.celery_app worker \
    --loglevel=info --queues=logs --concurrency=4 \
    --pool=prefork --hostname=logs@%h --max-tasks-per-child=500

# ç»ˆç«¯ 3: Celery content_generation
uv run celery -A app.core.celery_app worker \
    --loglevel=info --queues=content_generation --concurrency=8 \
    --pool=prefork --hostname=content@%h --max-tasks-per-child=50

# ç»ˆç«¯ 4: Celery workflow
uv run celery -A app.core.celery_app worker \
    --queues=roadmap_workflow --concurrency=2 -n workflow@%h
```

### 5. Railway ç”Ÿäº§ç¯å¢ƒé…ç½®

åœ¨ Railway Dashboard é…ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
POSTGRES_HOST=aws-0-us-east-1.pooler.supabase.com
POSTGRES_PORT=6543
POSTGRES_USER=postgres.your_project_id
POSTGRES_PASSWORD=your_password
POSTGRES_DB=postgres
DB_POOL_SIZE=5
DB_MAX_OVERFLOW=10
```

---

## ğŸ“Š é¢„æœŸæ”¶ç›Šå¯¹æ¯”

| æŒ‡æ ‡ | è¿ç§»å‰ | è¿ç§»å |
|------|--------|--------|
| **æ•°æ®åº“ç¯å¢ƒ** | æœ¬åœ° PostgreSQL | Supabase äº‘ç«¯ |
| **åº”ç”¨è¿æ¥æ•°** | 84 (21Ã—4) | 315 (21Ã—15) |
| **çœŸå®è¿æ¥æ•°** | 84 | ~50 (Supabase ç®¡ç†) |
| **è¿æ¥è€—å°½é£é™©** | é«˜ (84/100=84%) | æ—  (Supabase æ± åŒ–) |
| **è¿ç»´å¤æ‚åº¦** | é«˜ï¼ˆç»´æŠ¤æœ¬åœ°æ•°æ®åº“ï¼‰ | ä½ï¼ˆäº‘ç«¯æ‰˜ç®¡ï¼‰ |
| **ç¯å¢ƒä¸€è‡´æ€§** | å·®ï¼ˆæœ¬åœ°â‰ ç”Ÿäº§ï¼‰ | å¥½ï¼ˆç»Ÿä¸€ Supabaseï¼‰ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### Linter è­¦å‘Šï¼ˆå¯å¿½ç•¥ï¼‰

ä»¥ä¸‹å¯¼å…¥è­¦å‘Šæ˜¯å› ä¸º IDE ç¯å¢ƒé—®é¢˜ï¼Œä¸å½±å“è¿è¡Œï¼š
- `pydantic`, `pydantic_settings`
- `structlog`
- `sqlalchemy`, `sqlmodel`
- `psycopg_pool`, `langgraph`

è¿™äº›åŒ…åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­éƒ½å·²æ­£ç¡®å®‰è£…ã€‚

### å›æ»šæ–¹æ¡ˆ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›é€€ï¼š

```bash
# 1. ä¿®æ”¹ç¯å¢ƒå˜é‡
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
DB_POOL_SIZE=2
DB_MAX_OVERFLOW=2

# 2. ä» Git æ¢å¤ä»£ç 
git checkout HEAD~1 -- backend/app/config/settings.py
git checkout HEAD~1 -- backend/app/db/session.py
git checkout HEAD~1 -- backend/app/core/orchestrator_factory.py
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- **è¿ç§»è¯¦ç»†æŒ‡å—**: `backend/docs/20250101_Supabaseæ•°æ®åº“ç»Ÿä¸€è¿ç§».md`
- **å†å²æ–¹æ¡ˆå½’æ¡£**: `backend/docs/20250101_è¿æ¥æ± è€—å°½ä¿®å¤å†å².md`
- **æµ‹è¯•è„šæœ¬**: `backend/scripts/test_supabase_connection.py`
- **ç¯å¢ƒå˜é‡æ¨¡æ¿**: `backend/env.supabase.example`

---

## âœ… å®Œæˆæ ‡å¿—

å½“ä»¥ä¸‹æ¡ä»¶éƒ½æ»¡è¶³æ—¶ï¼Œè¿ç§»å³ä¸ºæˆåŠŸï¼š

1. âœ… æœ¬åœ°æµ‹è¯•è„šæœ¬ 4/4 é€šè¿‡
2. â³ FastAPI å’Œ Celery æœåŠ¡æ­£å¸¸å¯åŠ¨
3. â³ èƒ½å¤Ÿåˆ›å»ºå’ŒæŸ¥è¯¢æ•°æ®
4. â³ Railway ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ
5. â³ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡

---

**å®æ–½äººå‘˜**: AI Assistant  
**å®¡æ ¸**: å¾…ç”¨æˆ·ç¡®è®¤  
**çŠ¶æ€**: ä»£ç ä¿®æ”¹å®Œæˆï¼Œç­‰å¾…ç¯å¢ƒé…ç½®å’Œæµ‹è¯•

