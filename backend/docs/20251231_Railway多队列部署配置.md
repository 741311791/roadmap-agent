# Railway 多队列 Celery 部署配置指南

**更新日期**: 2024-12-31  
**版本**: v2.0 - 三队列架构  
**影响范围**: 后端部署 - Celery Worker 配置

---

## 架构概览

### 队列划分

本项目采用**三队列架构**，根据任务特性隔离处理：

| 队列名称 | 用途 | 任务类型 | 特点 |
|---------|------|---------|------|
| `logs` | 日志写入 | `batch_write_logs` | 轻量级、快速、高并发 |
| `content_generation` | 内容生成 | `generate_roadmap_content`, `retry_*` | CPU 密集、LLM 调用、中等并发 |
| `roadmap_workflow` | 工作流编排 | `roadmap_generation.*`, `workflow_resume.*` | 长时间运行、状态机、低并发 |

### 服务组件

| 服务类型 | Railway 服务名称建议 | 必需 | 说明 |
|---------|-------------------|------|------|
| `api` | `roadmap-api` | ✅ | FastAPI 主服务 |
| `celery_logs` | `roadmap-celery-logs` | ✅ | 日志队列 Worker |
| `celery_content` | `roadmap-celery-content` | ✅ | 内容生成队列 Worker |
| `celery_workflow` | `roadmap-celery-workflow` | ✅ | 工作流队列 Worker |
| `flower` | `roadmap-flower` | 可选 | Celery 监控界面 |
| `tavily_quota_updater` | `roadmap-quota-updater` | 可选 | Tavily 配额更新（定时任务）|

---

## Railway 部署配置

### 1. 创建服务

在 Railway 项目中创建 **4 个独立服务**（共享代码仓库）：

```
Project: roadmap-agent
├── Service: roadmap-api (SERVICE_TYPE=api)
├── Service: roadmap-celery-logs (SERVICE_TYPE=celery_logs)
├── Service: roadmap-celery-content (SERVICE_TYPE=celery_content)
└── Service: roadmap-celery-workflow (SERVICE_TYPE=celery_workflow)
```

### 2. 环境变量配置

#### 共享环境变量（所有服务）

```bash
# 数据库
DATABASE_URL=postgresql+asyncpg://...
DATABASE_POOL_SIZE=20
DATABASE_MAX_OVERFLOW=10

# Redis
REDIS_URL=rediss://...

# LLM 配置
OPENAI_API_KEY=sk-...
OPENAI_BASE_URL=https://api.openai.com/v1
DEFAULT_LLM_MODEL=gpt-4o-mini

# Tavily API
TAVILY_API_KEY=tvly-...

# JWT 密钥
JWT_SECRET_KEY=...
```

#### API 服务专用

```bash
SERVICE_TYPE=api
PORT=8000
UVICORN_WORKERS=4

# 管理员账号
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=your-secure-password
ADMIN_USERNAME=admin
```

#### Celery Logs Worker

```bash
SERVICE_TYPE=celery_logs
CELERY_LOG_LEVEL=info
CELERY_LOGS_CONCURRENCY=4
```

**参数说明**:
- `CELERY_LOGS_CONCURRENCY=4`: 日志任务轻量，可高并发（建议 2-8）
- `--max-tasks-per-child=1000`: 处理 1000 个任务后重启进程
- `--time-limit=300`: 5 分钟硬超时（日志写入不应超时）

#### Celery Content Worker

```bash
SERVICE_TYPE=celery_content
CELERY_LOG_LEVEL=info
CELERY_CONTENT_CONCURRENCY=6
```

**参数说明**:
- `CELERY_CONTENT_CONCURRENCY=6`: 内容生成 CPU 密集，中等并发（建议 4-8）
- `--max-tasks-per-child=50`: 及时释放 LLM 客户端连接
- `--time-limit=1800`: 30 分钟硬超时（足够生成完整路线图内容）

#### Celery Workflow Worker（新增）

```bash
SERVICE_TYPE=celery_workflow
CELERY_LOG_LEVEL=info
CELERY_WORKFLOW_CONCURRENCY=4
```

**参数说明**:
- `CELERY_WORKFLOW_CONCURRENCY=4`: 长时间任务，避免过多并发（建议 2-6）
- `--max-tasks-per-child=100`: 定期重启，清理 LangGraph checkpoint 状态
- `--time-limit=3600`: 1 小时硬超时（完整路线图生成流程）

---

## 并发配置建议

### 资源等级对应关系

| Railway 套餐 | 推荐配置 | 说明 |
|-------------|---------|------|
| **Trial/Hobby** | logs=2, content=4, workflow=2 | 总计 8 并发，适合测试 |
| **Pro (512MB)** | logs=4, content=6, workflow=4 | 总计 14 并发，标准生产环境 |
| **Pro (1GB)** | logs=6, content=8, workflow=6 | 总计 20 并发，高负载环境 |

### 调优建议

#### 低内存环境（512MB）

```bash
# 降低并发，提高稳定性
CELERY_LOGS_CONCURRENCY=2
CELERY_CONTENT_CONCURRENCY=4
CELERY_WORKFLOW_CONCURRENCY=2

# 更激进的进程重启策略
--max-tasks-per-child=30  # content
--max-tasks-per-child=50  # workflow
```

#### 高负载环境（1GB+）

```bash
# 提高并发，充分利用资源
CELERY_LOGS_CONCURRENCY=8
CELERY_CONTENT_CONCURRENCY=12
CELERY_WORKFLOW_CONCURRENCY=6

# 适当放宽进程重启
--max-tasks-per-child=100  # content
--max-tasks-per-child=200  # workflow
```

---

## 关键优化参数解析

### 1. `--prefetch-multiplier=1`

**作用**: 每个 Worker 进程只预取 1 个任务

**为什么设置为 1**:
- ✅ 避免任务堆积在单个 Worker
- ✅ 提高负载均衡效率
- ✅ 确保 LangGraph checkpoint 隔离（workflow 队列）
- ✅ 减少内存占用

**不使用默认值 4 的原因**:
```
# 默认行为（prefetch=4）
Worker 1: [Task A, Task B, Task C, Task D] - 全部预取到内存
Worker 2: 空闲 ❌

# 优化后（prefetch=1）
Worker 1: [Task A] - 仅预取 1 个
Worker 2: [Task B] - 立即接收新任务 ✅
```

### 2. `--max-tasks-per-child`

**作用**: 每个 Worker 进程处理指定数量任务后重启

**不同队列的配置**:
- `logs=1000`: 日志任务轻量，可处理更多任务
- `content=50`: LLM 客户端需要定期释放，防止连接泄漏
- `workflow=100`: 清理 LangGraph 状态，防止 checkpoint 混淆

**为什么不设置为无限**:
- ❌ 长期运行导致内存泄漏
- ❌ LLM 客户端连接积累
- ❌ LangGraph checkpoint 状态混淆

### 3. `--time-limit` 和 `--soft-time-limit`

**两层超时机制**:
1. **Soft Limit**: 到达时发送 `SoftTimeLimitExceeded` 异常（可捕获）
2. **Hard Limit**: 到达时直接 `SIGKILL` 终止进程（不可捕获）

**不同队列的配置**:
```bash
# logs: 5 分钟（日志写入应该很快）
--time-limit=300 --soft-time-limit=270

# content: 30 分钟（足够生成完整路线图内容）
--time-limit=1800 --soft-time-limit=1680

# workflow: 1 小时（完整工作流包括多次 LLM 调用）
--time-limit=3600 --soft-time-limit=3480
```

**Soft Limit 留出缓冲时间**:
```
Soft = Hard - 2 分钟
```
让任务有机会优雅关闭（保存 checkpoint、清理资源）。

---

## 监控与排查

### 1. 使用 Flower 监控

部署 Flower 服务（可选）：

```bash
# Railway 环境变量
SERVICE_TYPE=flower
FLOWER_PORT=5555

# 访问地址
https://roadmap-flower.railway.app
```

**可查看的指标**:
- 每个队列的任务数量
- Worker 进程状态
- 任务成功/失败率
- 实时任务执行日志

### 2. 日志查看

#### Railway Dashboard

```
Services → roadmap-celery-workflow → Logs
```

**关键日志关键词**:
```bash
# 成功启动
"Starting Celery Worker for Roadmap Workflow Queue"

# 任务执行
"Task app.tasks.roadmap_generation_tasks.generate_roadmap[...]"

# 异常情况
"WARNING/ForkPoolWorker" - Worker 异常
"TimeLimitExceeded" - 任务超时
"Connection lost" - Redis/PostgreSQL 连接问题
```

### 3. 性能指标

#### 正常状态

```bash
# 查看 Worker 状态
celery -A app.core.celery_app inspect active

# 预期输出
{
  "workflow@hostname": [
    {"id": "task-123", "name": "generate_roadmap", ...}
  ]
}
```

#### 异常状态排查

| 现象 | 可能原因 | 解决方案 |
|------|---------|---------|
| 任务堆积 | 并发不足 | 提高 `CELERY_*_CONCURRENCY` |
| 频繁超时 | `time-limit` 太短 | 增加超时时间或优化任务逻辑 |
| 内存溢出 | `max-tasks-per-child` 太大 | 降低该值，更频繁重启进程 |
| Redis 连接失败 | 网络问题或配额限制 | 检查 `REDIS_URL` 和 Upstash 配额 |

---

## 部署检查清单

### 部署前

- [ ] 确认所有环境变量已配置
- [ ] 检查 `DATABASE_URL` 和 `REDIS_URL` 连接性
- [ ] 确认 LLM API Key 有效

### 部署后

- [ ] 确认 4 个服务全部启动成功
- [ ] API 服务健康检查通过（`GET /health`）
- [ ] 触发测试任务，观察日志
- [ ] 检查 Flower 监控界面（如已部署）

### 监控指标

- [ ] 任务成功率 > 95%
- [ ] 平均任务处理时间 < 超时时间的 50%
- [ ] Worker 重启频率正常（每天 < 10 次）
- [ ] 数据库连接池无泄漏警告

---

## 常见问题

### Q1: 为什么分成 3 个队列？

**A**: 任务隔离，避免互相影响：
- 日志任务轻量快速，不应被内容生成阻塞
- 内容生成 CPU 密集，不应被工作流编排阻塞
- 工作流长时间运行，需要独立资源

### Q2: 可以合并队列吗？

**A**: 不建议，原因：
- ❌ 日志任务可能被工作流任务长时间阻塞
- ❌ 内容生成和工作流任务共享连接池，容易冲突
- ❌ 无法针对不同任务类型优化参数（超时、并发）

### Q3: Railway 免费额度够用吗？

**A**: 取决于使用量：
- Trial: 适合开发测试（总计 500MB 内存）
- Pro: 生产环境需要（建议每个 Worker 512MB）

**成本估算**:
```
4 个服务 × 512MB = 2GB 总内存
Railway Pro: $5/月 + 计算使用量
```

### Q4: 如何扩展并发？

**A**: 两种方式：
1. **垂直扩展**: 提高 `CELERY_*_CONCURRENCY`（需要更多内存）
2. **水平扩展**: 部署多个相同服务（Railway 不支持自动扩展）

---

## 相关文件

- `backend/scripts/railway_entrypoint.sh` - 启动脚本
- `backend/app/core/celery_app.py` - Celery 配置
- `backend/docs/20251231_Celery任务优化与速率限制.md` - 任务优化文档
- `backend/docs/20251231_并发控制机制分析.md` - 并发架构分析

---

## 更新历史

- **2024-12-31**: 新增 `roadmap_workflow` 队列，优化启动参数
- 原始版本: 仅 `logs` 和 `content_generation` 两队列

