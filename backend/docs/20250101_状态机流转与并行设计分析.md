# çŠ¶æ€æœºæµè½¬ä¸å¹¶è¡Œè®¾è®¡åˆ†æ

> **åˆ†ææ—¥æœŸ**: 2026-01-01  
> **é—®é¢˜**: å†…å®¹ç”Ÿæˆçš„çŠ¶æ€æœºæµè½¬å®é™…è¿è¡Œé€»è¾‘å’Œå¹¶è¡Œè®¾è®¡æ¨¡å¼  
> **ä¼˜å…ˆçº§**: ğŸ“Š æ¶æ„ç†è§£

---

## ğŸ“‹ ç›®å½•

1. [LangGraph çŠ¶æ€æœºæ¶æ„](#langgraph-çŠ¶æ€æœºæ¶æ„)
2. [çŠ¶æ€å®šä¹‰ä¸ç®¡ç†](#çŠ¶æ€å®šä¹‰ä¸ç®¡ç†)
3. [èŠ‚ç‚¹æµè½¬è·¯å¾„](#èŠ‚ç‚¹æµè½¬è·¯å¾„)
4. [å¹¶è¡Œè®¾è®¡æ¨¡å¼](#å¹¶è¡Œè®¾è®¡æ¨¡å¼)
5. [Celery å¼‚æ­¥æ¶æ„](#celery-å¼‚æ­¥æ¶æ„)
6. [å®Œæ•´æ‰§è¡Œæ—¶åº](#å®Œæ•´æ‰§è¡Œæ—¶åº)

---

## ğŸ”· LangGraph çŠ¶æ€æœºæ¶æ„

### æ ¸å¿ƒç»„ä»¶å…³ç³»

```mermaid
graph TB
    subgraph "FastAPI è¿›ç¨‹"
        API[API Endpoint]
        Executor[WorkflowExecutor]
        Graph[CompiledStateGraph]
        Checkpointer[AsyncPostgresSaver]
    end
    
    subgraph "LangGraph æ ¸å¿ƒ"
        StateGraph[StateGraph Definition]
        Nodes[Node Runners]
        Router[WorkflowRouter]
        Brain[WorkflowBrain]
    end
    
    subgraph "Celery Worker è¿›ç¨‹"
        CeleryTask[Roadmap Generation Task]
        ContentTask[Content Generation Task]
    end
    
    API --> Executor
    Executor --> Graph
    Graph --> Nodes
    Nodes --> Brain
    Nodes --> Router
    Graph <--> Checkpointer
    
    Executor -->|dispatch| CeleryTask
    CeleryTask -->|execute| Graph
    Graph -->|dispatch| ContentTask
    
    classDef fastapi fill:#4CAF50,stroke:#2E7D32,color:#fff
    classDef langgraph fill:#2196F3,stroke:#1565C0,color:#fff
    classDef celery fill:#FF9800,stroke:#E65100,color:#fff
    
    class API,Executor,Graph,Checkpointer fastapi
    class StateGraph,Nodes,Router,Brain langgraph
    class CeleryTask,ContentTask celery
```

---

## ğŸ“Š çŠ¶æ€å®šä¹‰ä¸ç®¡ç†

### RoadmapState ç»“æ„

```python
# backend/app/core/orchestrator/base.py:40-94

class RoadmapState(TypedDict):
    """
    å·¥ä½œæµå…¨å±€çŠ¶æ€ï¼ˆLangGraph çŠ¶æ€å®¹å™¨ï¼‰
    
    ç‰¹ç‚¹:
    - TypedDict æä¾›ç±»å‹æ£€æŸ¥
    - Annotated é…åˆ reducer å‡½æ•°å®ç°çŠ¶æ€åˆå¹¶
    - æ‰€æœ‰èŠ‚ç‚¹å…±äº«åŒä¸€ä¸ªçŠ¶æ€å¯¹è±¡
    """
    
    # ============ è¾“å…¥æ•°æ® ============
    user_request: UserRequest        # ç”¨æˆ·åŸå§‹è¯·æ±‚
    task_id: str                     # ä»»åŠ¡è¿½è¸ª ID
    roadmap_id: str | None          # è·¯çº¿å›¾ ID (Intent é˜¶æ®µç”Ÿæˆ)
    
    # ============ ä¸­é—´äº§ç‰© ============
    intent_analysis: IntentAnalysisOutput | None
    roadmap_framework: RoadmapFramework | None
    validation_result: ValidationOutput | None
    
    # ============ å†…å®¹ç”Ÿæˆç»“æœ ============
    # ğŸ“Œ ä½¿ç”¨ merge_dicts reducer å®ç°å¢é‡æ›´æ–°
    tutorial_refs: Annotated[dict[str, TutorialGenerationOutput], merge_dicts]
    resource_refs: Annotated[dict[str, ResourceRecommendationOutput], merge_dicts]
    quiz_refs: Annotated[dict[str, QuizGenerationOutput], merge_dicts]
    
    # ğŸ“Œ ä½¿ç”¨ add reducer å®ç°åˆ—è¡¨è¿½åŠ 
    failed_concepts: Annotated[list[str], add]
    execution_history: Annotated[list[str], add]
    
    # ============ Celery å¼‚æ­¥çŠ¶æ€ ============
    content_generation_status: str | None  # "queued" | "completed"
    celery_task_id: str | None            # Celery Task ID
    
    # ============ æµç¨‹æ§åˆ¶ ============
    current_step: str                     # å½“å‰æ­¥éª¤æ ‡è¯†
    modification_count: int               # ä¿®æ”¹æ¬¡æ•°è®¡æ•°å™¨
    human_approved: bool                  # äººå·¥å®¡æ ¸ç»“æœ
    validation_round: int                 # éªŒè¯è½®æ¬¡
    
    # ============ äººå·¥å®¡æ ¸ç›¸å…³ ============
    user_feedback: str | None             # ç”¨æˆ·åé¦ˆæ–‡æœ¬
    edit_plan: EditPlan | None           # ç»“æ„åŒ–ä¿®æ”¹è®¡åˆ’
    review_feedback_id: str | None       # åé¦ˆè®°å½• ID
    edit_plan_record_id: str | None      # è®¡åˆ’è®°å½• ID
    edit_source: str | None              # "validation_failed" | "human_review"
```

**å…³é”®ç‰¹æ€§**:

1. **Reducer å‡½æ•°æœºåˆ¶**:
```python
def merge_dicts(left: dict, right: dict) -> dict:
    """
    å­—å…¸åˆå¹¶ reducer
    
    å·¥ä½œåŸç†:
    - LangGraph è°ƒç”¨æ—¶ä¼ å…¥æ—§å€¼ (left) å’Œæ–°å€¼ (right)
    - è¿”å›åˆå¹¶åçš„å­—å…¸
    - ç¡®ä¿çŠ¶æ€æ›´æ–°æ˜¯è¿½åŠ è€Œéè¦†ç›–
    """
    return {**left, **right}

# ä½¿ç”¨ç¤ºä¾‹:
# èŠ‚ç‚¹ A è¿”å›: {"tutorial_refs": {"concept_1": tutorial_1}}
# èŠ‚ç‚¹ B è¿”å›: {"tutorial_refs": {"concept_2": tutorial_2}}
# æœ€ç»ˆçŠ¶æ€: {"tutorial_refs": {"concept_1": tutorial_1, "concept_2": tutorial_2}}
```

2. **çŠ¶æ€æŒä¹…åŒ– (Checkpoint)**:
```python
# LangGraph è‡ªåŠ¨ç®¡ç†
config = {"configurable": {"thread_id": task_id}}
graph.invoke(initial_state, config)  # æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåè‡ªåŠ¨ checkpoint
```

---

## ğŸ”„ èŠ‚ç‚¹æµè½¬è·¯å¾„

### å®Œæ•´çŠ¶æ€æœºå›¾

```mermaid
graph TB
    START([START]) --> Intent[IntentAnalysisRunner]
    Intent --> Curriculum[CurriculumDesignRunner]
    Curriculum --> Validation{ValidationRunner}
    
    %% éªŒè¯é€šè¿‡
    Validation -->|âœ… é€šè¿‡| Review{ReviewRunner}
    
    %% éªŒè¯å¤±è´¥ï¼šè‡ªåŠ¨ä¿®å¤å¾ªç¯
    Validation -->|âŒ å¤±è´¥| ValidationEditPlan[ValidationEditPlanRunner<br/>ğŸ·ï¸ edit_source=validation_failed]
    ValidationEditPlan --> Editor1[EditorRunner]
    Editor1 -->|æ£€æŸ¥ edit_source| Validation
    
    %% ç”¨æˆ·å®¡æ ¸é€šè¿‡
    Review -->|âœ… æ‰¹å‡†| Content[ContentRunner]
    
    %% ç”¨æˆ·å®¡æ ¸æ‹’ç»ï¼šç›´æ¥è¿”å›å®¡æ ¸
    Review -->|âŒ æ‹’ç»| EditPlan[EditPlanRunner<br/>ğŸ·ï¸ edit_source=human_review]
    EditPlan --> Editor2[EditorRunner]
    Editor2 -->|æ£€æŸ¥ edit_source| Review
    
    Content --> END([END])
    
    classDef coreNode fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    classDef analyzerNode fill:#2196F3,stroke:#1565C0,stroke-width:3px,color:#fff
    classDef validationNode fill:#FF9800,stroke:#E65100,stroke-width:3px,color:#fff
    classDef editorNode fill:#9C27B0,stroke:#6A1B9A,stroke-width:3px,color:#fff
    classDef humanNode fill:#F44336,stroke:#C62828,stroke-width:3px,color:#fff
    
    class Intent,Curriculum,Content coreNode
    class ValidationEditPlan,EditPlan analyzerNode
    class Validation validationNode
    class Editor1,Editor2 editorNode
    class Review humanNode
```

### æ¡ä»¶è·¯ç”±é€»è¾‘

#### 1. éªŒè¯åè·¯ç”± (route_after_validation)

```python
# backend/app/core/orchestrator/routers.py:29-77

def route_after_validation(self, state: RoadmapState) -> str:
    """
    éªŒè¯åçš„è·¯ç”±å†³ç­–
    
    å†³ç­–æ ‘:
    â”Œâ”€ validation_result.is_valid?
    â”‚
    â”œâ”€ False (éªŒè¯å¤±è´¥)
    â”‚  â”œâ”€ modification_count < max_retry?
    â”‚  â”‚  â””â”€ Yes â†’ "validation_edit_plan_analysis"  # è‡ªåŠ¨ä¿®å¤
    â”‚  â”‚  â””â”€ No  â†’ "human_review" or "tutorial_generation"  # è¾¾åˆ°ä¸Šé™
    â”‚  
    â””â”€ True (éªŒè¯é€šè¿‡)
       â””â”€ skip_human_review?
          â”œâ”€ False â†’ "human_review"           # éœ€è¦äººå·¥å®¡æ ¸
          â””â”€ True  â†’ "tutorial_generation"    # è·³è¿‡å®¡æ ¸
    """
    validation_result = state.get("validation_result")
    modification_count = state.get("modification_count", 0)
    
    # éªŒè¯å¤±è´¥ + æœªè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
    if not validation_result.is_valid:
        if modification_count < self.config.max_framework_retry:
            return "validation_edit_plan_analysis"  # è¿›å…¥è‡ªåŠ¨ä¿®å¤å¾ªç¯
        else:
            # è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œç»§ç»­æµç¨‹
            pass
    
    # éªŒè¯é€šè¿‡ or è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
    if not self.config.skip_human_review:
        return "human_review"
    else:
        return "tutorial_generation"
```

**å…³é”®å‚æ•°**:
- `max_framework_retry`: é»˜è®¤ 3 æ¬¡
- `skip_human_review`: é»˜è®¤ False (å¯ç”¨äººå·¥å®¡æ ¸)

#### 2. äººå·¥å®¡æ ¸åè·¯ç”± (route_after_human_review)

```python
def route_after_human_review(self, state: RoadmapState) -> str:
    """
    äººå·¥å®¡æ ¸åçš„è·¯ç”±å†³ç­–
    
    å†³ç­–æ ‘:
    â”Œâ”€ human_approved?
    â”‚
    â”œâ”€ True (ç”¨æˆ·æ‰¹å‡†)
    â”‚  â””â”€ "approved" â†’ tutorial_generation
    â”‚
    â””â”€ False (ç”¨æˆ·æ‹’ç»)
       â””â”€ "modify" â†’ edit_plan_analysis â†’ roadmap_edit â†’ human_review
    """
    if state.get("human_approved", False):
        return "approved"  # è¿›å…¥å†…å®¹ç”Ÿæˆ
    else:
        return "modify"    # è¿›å…¥ä¿®æ”¹å¾ªç¯
```

#### 3. ç¼–è¾‘åè·¯ç”± (route_after_edit)

```python
def route_after_edit(self, state: RoadmapState) -> str:
    """
    è·¯çº¿å›¾ç¼–è¾‘åçš„è·¯ç”±å†³ç­–
    
    å†³ç­–ä¾æ®: edit_source æ ‡è®°
    
    å†³ç­–æ ‘:
    â”Œâ”€ edit_source?
    â”‚
    â”œâ”€ "validation_failed"
    â”‚  â””â”€ "structure_validation"  # è¿”å›éªŒè¯èŠ‚ç‚¹
    â”‚
    â””â”€ "human_review"
       â””â”€ "human_review"          # è¿”å›äººå·¥å®¡æ ¸èŠ‚ç‚¹
    """
    edit_source = state.get("edit_source")
    
    if edit_source == "validation_failed":
        return "structure_validation"
    elif edit_source == "human_review":
        return "human_review"
    else:
        # é»˜è®¤è¿”å›éªŒè¯
        return "structure_validation"
```

---

## âš¡ å¹¶è¡Œè®¾è®¡æ¨¡å¼

### ä¸¤é˜¶æ®µå¹¶è¡Œç­–ç•¥

| é˜¶æ®µ | æ‰§è¡Œæ¨¡å¼ | å¹¶è¡Œç²’åº¦ | æ§åˆ¶æœºåˆ¶ |
|-----|---------|---------|---------|
| **è·¯çº¿å›¾ç”Ÿæˆ** | ä¸²è¡Œ | æ— å¹¶è¡Œ | LangGraph é¡ºåºæ‰§è¡Œ |
| **å†…å®¹ç”Ÿæˆ** | å¹¶è¡Œ | Concept çº§åˆ« | AsyncIO + Semaphore |

---

### é˜¶æ®µ 1: è·¯çº¿å›¾ç”Ÿæˆ (ä¸²è¡Œ)

```python
# backend/app/core/orchestrator/builder.py:126-127

# å›ºå®šè¾¹: ä¸²è¡Œæ‰§è¡Œ
workflow.add_edge("intent_analysis", "curriculum_design")
workflow.add_edge("curriculum_design", "structure_validation")
```

**ä¸ºä»€ä¹ˆä¸²è¡Œ?**
- âœ… **ä¾èµ–å…³ç³»å¼º**: æ¯ä¸ªèŠ‚ç‚¹ä¾èµ–å‰ä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡º
- âœ… **LLM è°ƒç”¨é¡ºåº**: éœ€æ±‚åˆ†æ â†’ è¯¾ç¨‹è®¾è®¡ â†’ ç»“æ„éªŒè¯
- âœ… **çŠ¶æ€ä¸€è‡´æ€§**: é¿å…å¹¶å‘æ›´æ–°å¯¼è‡´çŠ¶æ€å†²çª

**æ—¶åºå›¾**:
```
æ—¶é—´è½´    Intent      Curriculum    Validation    Review
  |
  0s    [ åˆ†æéœ€æ±‚ ]
  |         â†“
 10s    [ å®Œæˆ ] --> [ è®¾è®¡è¯¾ç¨‹ ]
  |                      â†“
 30s                  [ å®Œæˆ ] --> [ éªŒè¯ç»“æ„ ]
  |                                    â†“
 35s                                [ å®Œæˆ ] --> [ äººå·¥å®¡æ ¸ ]
  |                                                  â†“
  âˆ                                               [ ç­‰å¾…ç”¨æˆ· ]
```

---

### é˜¶æ®µ 2: å†…å®¹ç”Ÿæˆ (å¹¶è¡Œ)

#### è§¦å‘æµç¨‹

```python
# backend/app/core/orchestrator/node_runners/content_runner.py:56-122

async def run(self, state: RoadmapState) -> dict:
    """
    ContentRunner åªè´Ÿè´£åˆ†å‘ Celery ä»»åŠ¡
    
    æ‰§è¡Œæµç¨‹:
    1. æå– roadmap_framework å’Œ preferences
    2. å‘é€ Celery ä»»åŠ¡åˆ° content_generation é˜Ÿåˆ—
    3. ç«‹å³è¿”å›ï¼ˆä¸ç­‰å¾…å†…å®¹ç”Ÿæˆå®Œæˆï¼‰
    """
    # å‘é€ Celery ä»»åŠ¡
    celery_task = generate_roadmap_content.delay(
        task_id=task_id,
        roadmap_id=roadmap_id,
        roadmap_framework_data=framework.model_dump(mode="json"),
        user_preferences_data=user_request.preferences.model_dump(mode="json"),
    )
    
    # è¿”å›çŠ¶æ€æ›´æ–°
    return {
        "content_generation_status": "queued",
        "celery_task_id": celery_task.id,
        "current_step": "content_generation_queued",
    }
```

**å…³é”®ç‰¹æ€§**:
- âœ… **éé˜»å¡**: ContentRunner ç«‹å³è¿”å›,ä¸ç­‰å¾…å†…å®¹ç”Ÿæˆå®Œæˆ
- âœ… **è¿›ç¨‹éš”ç¦»**: å†…å®¹ç”Ÿæˆåœ¨ç‹¬ç«‹çš„ Celery Worker è¿›ç¨‹ä¸­æ‰§è¡Œ
- âœ… **çŠ¶æ€è¿½è¸ª**: é€šè¿‡ `celery_task_id` è¿½è¸ªä»»åŠ¡çŠ¶æ€

---

#### Celery Worker å¹¶è¡Œæ‰§è¡Œ

```python
# backend/app/tasks/content_generation_tasks.py:324-416

async def _generate_content_parallel(
    task_id: str,
    roadmap_id: str,
    concepts: list[Concept],  # å‡è®¾ 30 ä¸ªæ¦‚å¿µ
    ...
) -> tuple[dict, dict, dict, list]:
    """
    å¹¶è¡Œç”Ÿæˆæ‰€æœ‰æ¦‚å¿µçš„å†…å®¹
    
    å¹¶è¡Œç­–ç•¥:
    1. æ¦‚å¿µé—´å¹¶è¡Œ: 30 ä¸ªæ¦‚å¿µåŒæ—¶ç”Ÿæˆ (AsyncIO)
    2. æ•°æ®åº“å†™å…¥ä¸²è¡ŒåŒ–: ä¿¡å·é‡é™åˆ¶æœ€å¤š 3 ä¸ªåŒæ—¶å†™å…¥
    3. å•æ¦‚å¿µå†…ä¸²è¡Œ: Tutorial â†’ Resource â†’ Quiz
    """
    
    # ğŸ”§ ä¿¡å·é‡: é™åˆ¶å¹¶å‘æ•°æ®åº“æ“ä½œæ•°é‡
    MAX_DB_CONCURRENT = 3
    db_semaphore = asyncio.Semaphore(MAX_DB_CONCURRENT)
    
    # ğŸ“Š å…±äº«çŠ¶æ€å®¹å™¨
    tutorial_refs: dict = {}
    resource_refs: dict = {}
    quiz_refs: dict = {}
    failed_concepts: list = []
    results_lock = asyncio.Lock()
    
    # ğŸš€ å¹¶å‘æ‰§è¡Œæ‰€æœ‰æ¦‚å¿µ
    tasks = [
        generate_single_concept(
            concept=concept,
            db_semaphore=db_semaphore,  # ä¼ é€’ä¿¡å·é‡
            tutorial_refs=tutorial_refs,
            resource_refs=resource_refs,
            quiz_refs=quiz_refs,
            failed_concepts=failed_concepts,
            results_lock=results_lock,
            ...
        )
        for concept in concepts  # 30 ä¸ªåç¨‹
    ]
    
    # âš¡ AsyncIO å¹¶å‘æ‰§è¡Œ
    await asyncio.gather(*tasks, return_exceptions=True)
    
    return tutorial_refs, resource_refs, quiz_refs, failed_concepts
```

---

#### å•æ¦‚å¿µç”Ÿæˆæµç¨‹

```python
# backend/app/tasks/concept_generator.py:24-362

async def generate_single_concept(
    concept: Concept,
    db_semaphore: asyncio.Semaphore,
    ...
) -> None:
    """
    ä¸ºå•ä¸ªæ¦‚å¿µä¸²è¡Œç”Ÿæˆå†…å®¹
    
    æ‰§è¡Œé¡ºåº:
    1. Tutorial Generation (æ•™ç¨‹ç”Ÿæˆ)
    2. Resource Recommendation (èµ„æºæ¨è)
    3. Quiz Generation (æµ‹éªŒç”Ÿæˆ)
    4. ç«‹å³å†™å…¥æ•°æ®åº“ (å—ä¿¡å·é‡ä¿æŠ¤)
    """
    
    # ==================== ä¸²è¡Œæ‰§è¡Œ ====================
    # 1ï¸âƒ£ ç”Ÿæˆæ•™ç¨‹
    tutorial_agent = agent_factory.create_tutorial_generator()
    tutorial = await tutorial_agent.execute(tutorial_input)
    
    # 2ï¸âƒ£ ç”Ÿæˆèµ„æº
    resource_agent = agent_factory.create_resource_recommender()
    resource = await resource_agent.execute(resource_input)
    
    # 3ï¸âƒ£ ç”Ÿæˆæµ‹éªŒ
    quiz_agent = agent_factory.create_quiz_generator()
    quiz = await quiz_agent.execute(quiz_input)
    
    # ==================== å†™å…¥æ•°æ®åº“ ====================
    # ğŸ”§ ä½¿ç”¨ä¿¡å·é‡é™åˆ¶å¹¶å‘æ•°æ®åº“è¿æ¥
    async with db_semaphore:  # â³ æœ€å¤š 3 ä¸ªåç¨‹åŒæ—¶æŒæœ‰
        async with safe_session_with_retry() as session:
            await tutorial_repo.save_tutorial(tutorial, roadmap_id)
            await resource_repo.save_resource_recommendation(resource, roadmap_id)
            await quiz_repo.save_quiz(quiz, roadmap_id)
            await session.commit()
```

---

### å¹¶è¡Œæ¨¡å‹å¯è§†åŒ–

```mermaid
graph TB
    subgraph "Celery Content Worker è¿›ç¨‹"
        MainTask[generate_roadmap_content<br/>ä¸»ä»»åŠ¡] --> Parallel[_generate_content_parallel<br/>å¹¶è¡Œåè°ƒå™¨]
        
        Parallel --> C1[Concept 1<br/>Tutorialâ†’Resourceâ†’Quiz]
        Parallel --> C2[Concept 2<br/>Tutorialâ†’Resourceâ†’Quiz]
        Parallel --> C3[Concept 3<br/>Tutorialâ†’Resourceâ†’Quiz]
        Parallel --> Cdot[...]
        Parallel --> C30[Concept 30<br/>Tutorialâ†’Resourceâ†’Quiz]
        
        C1 --> DBSem[æ•°æ®åº“ä¿¡å·é‡<br/>MAX=3]
        C2 --> DBSem
        C3 --> DBSem
        Cdot --> DBSem
        C30 --> DBSem
        
        DBSem --> DB[(PostgreSQL<br/>Supabase)]
    end
    
    subgraph "å¹¶å‘æ§åˆ¶"
        AsyncIO[AsyncIO Gather<br/>30 åç¨‹åŒæ—¶è¿è¡Œ]
        Sem[Semaphore<br/>æœ€å¤š 3 ä¸ªå†™æ•°æ®åº“]
    end
    
    Parallel -.ä½¿ç”¨.-> AsyncIO
    DBSem -.é™åˆ¶.-> Sem
    
    classDef taskNode fill:#4CAF50,stroke:#2E7D32,color:#fff
    classDef conceptNode fill:#2196F3,stroke:#1565C0,color:#fff
    classDef controlNode fill:#FF9800,stroke:#E65100,color:#fff
    classDef dbNode fill:#9C27B0,stroke:#6A1B9A,color:#fff
    
    class MainTask,Parallel taskNode
    class C1,C2,C3,Cdot,C30 conceptNode
    class AsyncIO,Sem,DBSem controlNode
    class DB dbNode
```

---

### å¹¶å‘æ€§èƒ½åˆ†æ

#### ç†è®ºæ—¶é—´æˆæœ¬

```python
# å‡è®¾å•ä¸ªæ¦‚å¿µç”Ÿæˆæ—¶é—´:
tutorial_time = 10s
resource_time = 5s
quiz_time = 3s
db_write_time = 2s

single_concept_time = 10 + 5 + 3 + 2 = 20s

# 30 ä¸ªæ¦‚å¿µ:
# é¡ºåºæ‰§è¡Œ: 30 Ã— 20 = 600s (10 åˆ†é’Ÿ)
# å®Œå…¨å¹¶è¡Œ: 20s (ç†æƒ³æƒ…å†µ)
# å®é™…å¹¶è¡Œ (ä¿¡å·é‡=3): 20s + (30-3) Ã— 2 / 3 = 20 + 18 = 38s
```

**å®é™…æƒ…å†µ**:
- âœ… **LLM è°ƒç”¨å¹¶è¡Œ**: 30 ä¸ªæ¦‚å¿µåŒæ—¶è°ƒç”¨ OpenAI/Anthropic API
- âš ï¸ **æ•°æ®åº“å†™å…¥ä¸²è¡ŒåŒ–**: ä¿¡å·é‡é™åˆ¶æœ€å¤š 3 ä¸ªåŒæ—¶å†™å…¥
- âš ï¸ **è¿æ¥æ± äº‰æŠ¢**: å¯èƒ½å¯¼è‡´ç­‰å¾…æ—¶é—´å¢åŠ 

---

## ğŸ”„ Celery å¼‚æ­¥æ¶æ„

### åŒå±‚å¼‚æ­¥è®¾è®¡

```mermaid
sequenceDiagram
    participant Frontend
    participant FastAPI
    participant RedisBroker as Redis Broker
    participant CeleryWorkflow as Celery Workflow Worker
    participant CeleryContent as Celery Content Worker
    participant DB as PostgreSQL
    
    %% 1. ç”¨æˆ·æäº¤è¯·æ±‚
    Frontend->>FastAPI: POST /api/v1/generate
    FastAPI->>DB: åˆ›å»º Task è®°å½•
    FastAPI->>RedisBroker: å‘é€ roadmap_generation ä»»åŠ¡
    FastAPI-->>Frontend: è¿”å› task_id
    
    %% 2. Celery Workflow Worker æ‰§è¡Œ
    RedisBroker->>CeleryWorkflow: æ‹‰å–ä»»åŠ¡
    CeleryWorkflow->>CeleryWorkflow: Intent Analysis
    CeleryWorkflow->>DB: ä¿å­˜ Intent ç»“æœ
    CeleryWorkflow->>CeleryWorkflow: Curriculum Design
    CeleryWorkflow->>DB: ä¿å­˜ Framework
    CeleryWorkflow->>CeleryWorkflow: Structure Validation
    
    %% 3. äººå·¥å®¡æ ¸ (å¯é€‰æš‚åœ)
    CeleryWorkflow->>DB: ä¿å­˜ Checkpoint (interrupt)
    CeleryWorkflow-->>Frontend: WebSocket: ç­‰å¾…å®¡æ ¸
    Frontend->>FastAPI: POST /approve
    FastAPI->>DB: æ›´æ–° human_approved=True
    FastAPI->>RedisBroker: å‘é€ workflow_resume ä»»åŠ¡
    RedisBroker->>CeleryWorkflow: æ‹‰å–æ¢å¤ä»»åŠ¡
    
    %% 4. å†…å®¹ç”Ÿæˆé˜¶æ®µ
    CeleryWorkflow->>RedisBroker: å‘é€ content_generation ä»»åŠ¡
    CeleryWorkflow-->>DB: ä¿å­˜ Checkpoint (completed)
    RedisBroker->>CeleryContent: æ‹‰å–ä»»åŠ¡
    
    %% 5. å¹¶è¡Œç”Ÿæˆå†…å®¹
    par 30 ä¸ªæ¦‚å¿µå¹¶è¡Œ
        CeleryContent->>CeleryContent: Concept 1 ç”Ÿæˆ
        CeleryContent->>DB: ä¿å­˜ Concept 1
    and
        CeleryContent->>CeleryContent: Concept 2 ç”Ÿæˆ
        CeleryContent->>DB: ä¿å­˜ Concept 2
    and
        CeleryContent->>CeleryContent: ...
    and
        CeleryContent->>CeleryContent: Concept 30 ç”Ÿæˆ
        CeleryContent->>DB: ä¿å­˜ Concept 30
    end
    
    CeleryContent-->>Frontend: WebSocket: å†…å®¹ç”Ÿæˆå®Œæˆ
```

---

### ä»»åŠ¡é˜Ÿåˆ—åˆ†ç¦»

| é˜Ÿåˆ—åç§° | å¤„ç†å†…å®¹ | Worker æ•°é‡ | å¹¶å‘æ•° | ç‰¹ç‚¹ |
|---------|---------|------------|-------|------|
| **roadmap_workflow** | LangGraph å·¥ä½œæµæ‰§è¡Œ | 1ä¸» + 4å·¥ä½œ = 5 | 4 | é•¿æ—¶é—´è¿è¡Œ,æœ‰çŠ¶æ€ |
| **content_generation** | å†…å®¹å¹¶è¡Œç”Ÿæˆ | 1ä¸» + 6å·¥ä½œ = 7 | 6 | CPU å¯†é›†,LLM è°ƒç”¨ |
| **logs** | æ—¥å¿—æ‰¹é‡å†™å…¥ | 1ä¸» + 4å·¥ä½œ = 5 | 4 | è½»é‡çº§,é«˜åå |

**é…ç½®æ–‡ä»¶**:
```bash
# backend/scripts/railway_entrypoint.sh

# Celery Workflow Worker
celery -A app.core.celery_app worker \
  --queues=roadmap_workflow \
  --concurrency=4 \
  --time-limit=3600

# Celery Content Worker
celery -A app.core.celery_app worker \
  --queues=content_generation \
  --concurrency=6 \
  --time-limit=1800
```

---

## â±ï¸ å®Œæ•´æ‰§è¡Œæ—¶åº

### æ­£å¸¸æµç¨‹ (æ— å®¡æ ¸æ‹’ç»)

```
æ—¶é—´è½´  FastAPI  Workflow Worker  Content Worker  å‰ç«¯çŠ¶æ€
  |
  0s    [ æ¥æ”¶è¯·æ±‚ ]
  |         â†“
  1s    [ åˆ›å»ºä»»åŠ¡ ] --> [ Celery: roadmap_generation ]
  |     [ è¿”å› task_id ]                â†“
  2s                   [ Intent Analysis ] --> WebSocket: éœ€æ±‚åˆ†æä¸­
  |                          â†“
 12s                   [ Curriculum Design ] --> WebSocket: è¯¾ç¨‹è®¾è®¡ä¸­
  |                          â†“
 32s                   [ Structure Validation ] --> WebSocket: ç»“æ„éªŒè¯ä¸­
  |                          â†“
 37s                   [ Human Review WAIT ] --> WebSocket: ç­‰å¾…å®¡æ ¸
  |                          â†“ (interrupt)
  |                   [ Checkpoint ä¿å­˜ ]
  |                          â¸ï¸
  âˆ                    [ ç­‰å¾…ç”¨æˆ·æ‰¹å‡†... ]
  |
  ?     [ /approve ]        â†“
  |         â†“          [ Resume from Checkpoint ]
  +1s               [ Content Generation Node ]
  |                          â†“
  +2s               [ Dispatch to content_generation queue ]
  |                          â†“                    â†“
  +3s                   [ è¿”å› END ]      [ Celery: generate_roadmap_content ]
  |                                             â†“
  +4s                                     [ å¹¶è¡Œç”Ÿæˆ 30 ä¸ªæ¦‚å¿µ ]
  |                                             â†“
  +34s                                    [ å…¨éƒ¨å®Œæˆ ] --> WebSocket: å†…å®¹ç”Ÿæˆå®Œæˆ
```

**å…³é”®æ—¶é—´ç‚¹**:
- **0-2s**: FastAPI å¤„ç†è¯·æ±‚,åˆ†å‘ Celery ä»»åŠ¡
- **2-37s**: LangGraph å·¥ä½œæµä¸²è¡Œæ‰§è¡Œ (35 ç§’)
- **âˆ**: ç­‰å¾…äººå·¥å®¡æ ¸ (ä¸ç¡®å®šæ—¶é—´)
- **+1-+3s**: æ¢å¤å·¥ä½œæµ,åˆ†å‘å†…å®¹ç”Ÿæˆä»»åŠ¡
- **+4-+34s**: å¹¶è¡Œç”Ÿæˆå†…å®¹ (30 ç§’)

---

### å¼‚å¸¸æµç¨‹: éªŒè¯å¤±è´¥è‡ªåŠ¨ä¿®å¤

```
æ—¶é—´è½´  Workflow Worker                çŠ¶æ€æœºèŠ‚ç‚¹
  |
 32s    [ Structure Validation ]       structure_validation
  |            â†“
  |     [ is_valid = False ]
  |            â†“
 33s    [ route_after_validation ]      (è·¯ç”±å†³ç­–)
  |            â†“
  |     [ modification_count < 3? ]
  |            â†“ Yes
 34s    [ Validation Edit Plan Analysis ] validation_edit_plan_analysis
  |            â†“
 44s    [ Roadmap Edit ]                roadmap_edit
  |            â†“
  |     [ edit_source = "validation_failed" ]
  |            â†“
 54s    [ route_after_edit ]            (è·¯ç”±å†³ç­–)
  |            â†“
  |     [ è¿”å› structure_validation ]
  |            â†“
 55s    [ Structure Validation ]        structure_validation (ç¬¬ 2 è½®)
  |            â†“
  |     [ is_valid = True âœ… ]
  |            â†“
 60s    [ Human Review ]                human_review
```

**å¾ªç¯ç»ˆæ­¢æ¡ä»¶**:
- âœ… éªŒè¯é€šè¿‡ (`is_valid = True`)
- âš ï¸ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° (`modification_count >= 3`)

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿ä¸æƒè¡¡

### âœ… ä¼˜åŠ¿

| ç»´åº¦ | ä¼˜åŠ¿ | å®ç°æ–¹å¼ |
|-----|------|---------|
| **è¿›ç¨‹éš”ç¦»** | FastAPI ä¸è¢«é˜»å¡ | Celery ç‹¬ç«‹è¿›ç¨‹æ‰§è¡Œ |
| **å¯æ¢å¤æ€§** | æ”¯æŒæ–­ç‚¹ç»­ä¼  | LangGraph Checkpoint + PostgreSQL |
| **å¯è§‚æµ‹æ€§** | å®Œæ•´çš„çŠ¶æ€è¿½è¸ª | WorkflowBrain ç»Ÿä¸€ç®¡ç†æ—¥å¿—å’Œé€šçŸ¥ |
| **å¹¶å‘æ§åˆ¶** | é¿å…è¿æ¥æ± è€—å°½ | Semaphore é™åˆ¶å¹¶å‘æ•°æ®åº“æ“ä½œ |
| **æ•…éšœæ¢å¤** | æ”¯æŒä»»åŠ¡é‡è¯• | Celery ä»»åŠ¡é‡è¯•æœºåˆ¶ |

---

### âš ï¸ æƒè¡¡ä¸çº¦æŸ

| ç»´åº¦ | çº¦æŸ | å½±å“ |
|-----|------|------|
| **ä¸²è¡Œè·¯çº¿å›¾ç”Ÿæˆ** | LangGraph é¡ºåºæ‰§è¡Œ | æ— æ³•å¹¶è¡ŒåŒ– Intent/Curriculum/Validation |
| **ä¿¡å·é‡é™åˆ¶** | æœ€å¤š 3 ä¸ªå¹¶å‘å†™æ•°æ®åº“ | é™ä½ååé‡,ä½†ä¿æŠ¤è¿æ¥æ±  |
| **äººå·¥å®¡æ ¸æš‚åœ** | GraphInterrupt é˜»å¡å·¥ä½œæµ | Worker è¿›ç¨‹èµ„æºå ç”¨ |
| **Checkpoint å¼€é”€** | æ¯ä¸ªèŠ‚ç‚¹åå†™æ•°æ®åº“ | ~50ms/checkpoint |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å†…å®¹ç”Ÿæˆé˜»å¡é—®é¢˜åˆ†æ](./20250101_å†…å®¹ç”Ÿæˆé˜»å¡é—®é¢˜åˆ†æ.md)
- [Celery ä»»åŠ¡ä¼˜åŒ–ä¸é€Ÿç‡é™åˆ¶](./20251231_Celeryä»»åŠ¡ä¼˜åŒ–ä¸é€Ÿç‡é™åˆ¶.md)
- [å¹¶å‘æ§åˆ¶æœºåˆ¶åˆ†æ](./20251231_å¹¶å‘æ§åˆ¶æœºåˆ¶åˆ†æ.md)
- [æ•°æ®åº“ä¼šè¯ä½¿ç”¨è§„èŒƒ](./20251231_æ•°æ®åº“ä¼šè¯ä½¿ç”¨è§„èŒƒ.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-01  
**ç»´æŠ¤è€…**: Backend Team

