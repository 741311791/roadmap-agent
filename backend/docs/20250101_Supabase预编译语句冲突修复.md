# Supabase é¢„ç¼–è¯‘è¯­å¥å†²çªå®Œæ•´ä¿®å¤

**ä¿®å¤æ—¥æœŸ**: 2025-01-01  
**é—®é¢˜**: asyncpg åœ¨ Supabase Transaction Mode ä¸‹é¢„ç¼–è¯‘è¯­å¥å†²çª  
**é”™è¯¯ç±»å‹**: `DuplicatePreparedStatementError` + `InvalidSQLStatementNameError`  
**æ ¹æœ¬åŸå› **: asyncpg ä¼šè‡ªåŠ¨ä¸ºæŸ¥è¯¢åˆ›å»ºé¢„ç¼–è¯‘è¯­å¥ï¼Œä½† pgbouncer äº‹åŠ¡æ¨¡å¼ä¸æ”¯æŒè·¨äº‹åŠ¡å¤ç”¨  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## é—®é¢˜æ¼”å˜å†ç¨‹

### é˜¶æ®µ 1ï¼šå¯åŠ¨æ—¶é”™è¯¯ï¼ˆasyncpg - DuplicatePreparedStatementErrorï¼‰
```
prepared statement "__asyncpg_stmt_1__" already exists
```
**è§¦å‘åœºæ™¯**: åº”ç”¨å¯åŠ¨æ—¶çš„ `task_recovery` å’Œ `tech_assessments_initialization`  
**é©±åŠ¨**: asyncpg (SQLAlchemy)

**é¦–æ¬¡ä¿®å¤å°è¯•**:
- è®¾ç½® `pool_pre_ping=False`
- è®¾ç½® `prepared_statement_name_func=None` (âŒ æ— æ•ˆå‚æ•°)

### é˜¶æ®µ 2ï¼šè¿è¡Œæ—¶é”™è¯¯ï¼ˆasyncpg - InvalidSQLStatementNameErrorï¼‰
```
prepared statement "__asyncpg_stmt_14__" does not exist
```
**è§¦å‘åœºæ™¯**: API è¯·æ±‚æ—¶çš„å®é™…æŸ¥è¯¢æ“ä½œï¼ˆå¦‚ `GET /api/v1/featured/roadmaps`ï¼‰  
**é©±åŠ¨**: asyncpg (SQLAlchemy)

**ä¿®å¤æ–¹æ¡ˆ**: åœ¨è¿æ¥å½’è¿˜æ—¶æ‰§è¡Œ `DEALLOCATE ALL`

### é˜¶æ®µ 3ï¼šCheckpointer åˆå§‹åŒ–é”™è¯¯ï¼ˆpsycopg - DuplicatePreparedStatementï¼‰
```
prepared statement "_pg3_0" already exists
```
**è§¦å‘åœºæ™¯**: `OrchestratorFactory.initialize()` æ—¶çš„ `checkpointer.setup()`  
**é©±åŠ¨**: psycopg (LangGraph AsyncPostgresSaver)

**æ ¹æœ¬åŸå› **:
- psycopg çš„ `prepare_threshold=0` ä»ç„¶ä¼šä½¿ç”¨å‘½åé¢„ç¼–è¯‘è¯­å¥ï¼ˆå¦‚ `_pg3_0`ï¼‰
- éœ€è¦è®¾ç½® `prepare_threshold=None` æ¥å®Œå…¨ç¦ç”¨é¢„ç¼–è¯‘è¯­å¥

---

## æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒç­–ç•¥
åœ¨**è¿æ¥å½’è¿˜åˆ°æ± ä¸­æ—¶**ï¼Œä¸»åŠ¨æ¸…ç†æ‰€æœ‰é¢„ç¼–è¯‘è¯­å¥ï¼Œç¡®ä¿åç»­è¯·æ±‚ä¸ä¼šé‡åˆ°å†²çªã€‚

### å®ç°æ­¥éª¤

#### 1. åŸºç¡€é…ç½®ï¼ˆbackend/app/db/session.pyï¼‰

```python
def _create_engine() -> AsyncEngine:
    return create_async_engine(
        settings.DATABASE_URL,
        pool_pre_ping=False,  # ç¦ç”¨å¥åº·æ£€æŸ¥
        pool_recycle=300,     # å®šæœŸå›æ”¶è¿æ¥
        connect_args={
            "statement_cache_size": 0,  # ç¦ç”¨å®¢æˆ·ç«¯ç¼“å­˜
        },
    )
```

#### 2. è¿æ¥å½’è¿˜äº‹ä»¶ç›‘å¬å™¨ï¼ˆå…³é”®ä¿®å¤ï¼‰

```python
@event.listens_for(engine.sync_engine, "checkin")
def on_checkin(dbapi_connection, connection_record):
    """
    è¿æ¥å½’è¿˜è¿æ¥æ± æ—¶è§¦å‘
    
    âš ï¸ Supabase Transaction Mode å…³é”®ä¿®å¤ï¼š
    åœ¨å½’è¿˜è¿æ¥å‰æ¸…ç†æ‰€æœ‰é¢„ç¼–è¯‘è¯­å¥ï¼Œé¿å… pgbouncer è¿æ¥å¤ç”¨æ—¶å†²çªã€‚
    """
    # ... ç›‘æ§é€»è¾‘ ...
    
    # ğŸ”§ æ¸…ç†é¢„ç¼–è¯‘è¯­å¥
    try:
        if hasattr(dbapi_connection, "_connection"):
            raw_connection = dbapi_connection._connection
            if hasattr(raw_connection, "execute"):
                from sqlalchemy.util._concurrency_py3k import await_only
                await_only(raw_connection.execute("DEALLOCATE ALL"))
                logger.debug("db_prepared_statements_cleared")
    except Exception as e:
        logger.debug("db_prepared_statements_clear_failed", error=str(e))
```

---

## æŠ€æœ¯ç»†èŠ‚

### psycopg vs asyncpg çš„é¢„ç¼–è¯‘è¯­å¥å·®å¼‚

| é©±åŠ¨ | å‚æ•° | å€¼ | æ•ˆæœ |
|------|------|-----|------|
| **asyncpg** | `statement_cache_size` | `0` | ç¦ç”¨å®¢æˆ·ç«¯ç¼“å­˜ï¼Œä½†ä»ä¼šåˆ›å»ºé¢„ç¼–è¯‘è¯­å¥ |
| **psycopg** | `prepare_threshold` | `0` | âŒ ä»ä½¿ç”¨å‘½åé¢„ç¼–è¯‘è¯­å¥ï¼ˆ`_pg3_0`ï¼‰ |
| **psycopg** | `prepare_threshold` | `None` | âœ… å®Œå…¨ç¦ç”¨é¢„ç¼–è¯‘è¯­å¥ |

### ä¸ºä»€ä¹ˆ psycopg çš„ `prepare_threshold=0` ä¸å¤Ÿï¼Ÿ

```python
# prepare_threshold=0 çš„è¡Œä¸º
# psycopg ä¼šç«‹å³ä¸ºç¬¬ä¸€æ¬¡æ‰§è¡Œçš„è¯­å¥åˆ›å»ºé¢„ç¼–è¯‘è¯­å¥
# å‘½åæ ¼å¼: _pg3_0, _pg3_1, _pg3_2, ...

# prepare_threshold=None çš„è¡Œä¸º
# psycopg å®Œå…¨ä¸ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥ï¼Œå§‹ç»ˆä½¿ç”¨ç®€å•æŸ¥è¯¢åè®®
```

### ä¸ºä»€ä¹ˆåœ¨ checkin æ—¶æ¸…ç†ï¼Ÿ

| æ—¶æœº | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **checkout æ—¶** | ç¡®ä¿è·å–çš„è¿æ¥æ˜¯å¹²å‡€çš„ | æ¯æ¬¡è·å–è¿æ¥éƒ½è¦æ‰§è¡Œæ¸…ç†ï¼Œæ€§èƒ½å¼€é”€å¤§ |
| **checkin æ—¶** âœ… | åªåœ¨å½’è¿˜æ—¶æ¸…ç†ä¸€æ¬¡ï¼Œæ€§èƒ½æ›´å¥½ | éœ€è¦ç¡®ä¿æ¸…ç†å¤±è´¥ä¸å½±å“å½’è¿˜ |
| **connect æ—¶** | æ–°è¿æ¥ä¸éœ€è¦æ¸…ç† | æ— æ³•å¤„ç†å·²æœ‰è¿æ¥çš„é¢„ç¼–è¯‘è¯­å¥ |

### `DEALLOCATE ALL` SQL å‘½ä»¤

```sql
DEALLOCATE ALL;
```

**ä½œç”¨**: åˆ é™¤å½“å‰ä¼šè¯ä¸­çš„æ‰€æœ‰é¢„ç¼–è¯‘è¯­å¥  
**æ€§èƒ½å½±å“**: æå°ï¼ˆ~1msï¼‰  
**é£é™©**: æ— ï¼ˆPostgreSQL æ ‡å‡†å‘½ä»¤ï¼‰

### å¼‚æ­¥äº‹ä»¶å¤„ç†

```python
from sqlalchemy.util._concurrency_py3k import await_only

# åœ¨åŒæ­¥äº‹ä»¶å¤„ç†å™¨ä¸­æ‰§è¡Œå¼‚æ­¥æ“ä½œ
await_only(raw_connection.execute("DEALLOCATE ALL"))
```

**ä¸ºä»€ä¹ˆéœ€è¦ `await_only`ï¼Ÿ**
- SQLAlchemy çš„äº‹ä»¶ç›‘å¬å™¨æ˜¯åŒæ­¥å‡½æ•°
- asyncpg çš„ `execute` æ–¹æ³•æ˜¯å¼‚æ­¥çš„
- `await_only` æ¡¥æ¥åŒæ­¥/å¼‚æ­¥ä¸Šä¸‹æ–‡

---

## å®Œæ•´é…ç½®æ¸…å•

### SQLAlchemy å¼•æ“ï¼ˆasyncpgï¼‰
```python
create_async_engine(
    DATABASE_URL,
    pool_pre_ping=False,       # ç¦ç”¨å¥åº·æ£€æŸ¥
    pool_recycle=300,          # 5åˆ†é’Ÿå›æ”¶è¿æ¥
    connect_args={
        "statement_cache_size": 0,  # ç¦ç”¨å®¢æˆ·ç«¯ç¼“å­˜
    }
)

# + ç›‘å¬ checkin äº‹ä»¶ï¼Œæ‰§è¡Œ DEALLOCATE ALL
```

### LangGraph Checkpointerï¼ˆpsycopgï¼‰
```python
# backend/app/core/orchestrator_factory.py
AsyncConnectionPool(
    conninfo=CHECKPOINTER_DATABASE_URL,
    kwargs={
        "autocommit": True,
        "prepare_threshold": None,  # âœ… å¿…é¡»è®¾ä¸º Noneï¼ˆä¸æ˜¯ 0ï¼‰
    }
)
```

**å…³é”®è¯´æ˜**:
- `prepare_threshold=0`: âŒ ä»ä¼šä½¿ç”¨å‘½åé¢„ç¼–è¯‘è¯­å¥ï¼ˆ`_pg3_0`ï¼‰
- `prepare_threshold=None`: âœ… å®Œå…¨ç¦ç”¨é¢„ç¼–è¯‘è¯­å¥ï¼Œä½¿ç”¨ç®€å•æŸ¥è¯¢åè®®

---

## éªŒè¯ä¿®å¤

### æµ‹è¯•åœºæ™¯
1. **å¯åŠ¨æµ‹è¯•**: åº”ç”¨å¯åŠ¨ä¸æŠ¥é”™ï¼ˆasyncpg + psycopgï¼‰
2. **Checkpointer åˆå§‹åŒ–**: `orchestrator_factory_initialized` æ—¥å¿—æ­£å¸¸
3. **API æµ‹è¯•**: æ‰§è¡Œå¤šæ¬¡ `GET /api/v1/featured/roadmaps`
4. **å¹¶å‘æµ‹è¯•**: ä½¿ç”¨ `ab` æˆ– `wrk` è¿›è¡Œå‹åŠ›æµ‹è¯•
5. **é•¿æ—¶é—´è¿è¡Œ**: è§‚å¯Ÿ24å°æ—¶æ— é”™è¯¯

### é¢„æœŸæ—¥å¿—
```bash
# å¯åŠ¨æ­£å¸¸ï¼ˆasyncpgï¼‰
2026-01-01 17:00:00 [info] task_recovery_no_tasks_found
2026-01-01 17:00:00 [info] tech_assessments_all_exist_skip_generation

# Checkpointer åˆå§‹åŒ–æ­£å¸¸ï¼ˆpsycopgï¼‰
2026-01-01 17:00:00 [info] orchestrator_factory_initialized checkpointer_type=AsyncPostgresSaver

# è¿æ¥å½’è¿˜æ—¶çš„æ¸…ç†æ—¥å¿—ï¼ˆdebugçº§åˆ«ï¼‰
2026-01-01 17:01:00 [debug] db_prepared_statements_cleared connection_id=5000804160
```

### é”™è¯¯æ’æŸ¥
å¦‚æœä»ç„¶å‡ºç°é”™è¯¯ï¼Œæ£€æŸ¥ï¼š

**asyncpg ç›¸å…³**ï¼š
1. âœ… `statement_cache_size=0` æ˜¯å¦è®¾ç½®
2. âœ… `pool_pre_ping=False` æ˜¯å¦è®¾ç½®
3. âœ… checkin äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ³¨å†ŒæˆåŠŸ
4. âœ… `DEALLOCATE ALL` æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼ˆæŸ¥çœ‹ debug æ—¥å¿—ï¼‰

**psycopg ç›¸å…³**ï¼š
1. âœ… `prepare_threshold=None` æ˜¯å¦è®¾ç½®ï¼ˆä¸æ˜¯ 0ï¼‰
2. âœ… `autocommit=True` æ˜¯å¦è®¾ç½®
3. âœ… è¿æ¥æ± æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–

---

## æ€§èƒ½å½±å“åˆ†æ

### é¢å¤–å¼€é”€
- **æ¯æ¬¡è¿æ¥å½’è¿˜**: +1msï¼ˆæ‰§è¡Œ `DEALLOCATE ALL`ï¼‰
- **é¢„ç¼–è¯‘è¯­å¥ç¦ç”¨**: +5-10% æŸ¥è¯¢æ—¶é—´ï¼ˆéœ€è¦é‡æ–°è§£æ SQLï¼‰

### å®é™…å½±å“
- **Supabase Transaction Mode æœ¬èº«å°±ä¸æ”¯æŒé¢„ç¼–è¯‘è¯­å¥è·¨äº‹åŠ¡å¤ç”¨**
- å› æ­¤ç¦ç”¨é¢„ç¼–è¯‘è¯­å¥**æ²¡æœ‰å®é™…æ€§èƒ½æŸå¤±**
- åè€Œé¿å…äº†é¢‘ç¹çš„é¢„ç¼–è¯‘è¯­å¥å†²çªé”™è¯¯

---

## æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆAï¼šåˆ‡æ¢åˆ° Session Modeï¼ˆâŒ ä¸æ¨èï¼‰
```
ç«¯å£: 5432 (Session Mode)
```
**ä¼˜ç‚¹**: æ”¯æŒé¢„ç¼–è¯‘è¯­å¥è·¨ä¼šè¯å¤ç”¨  
**ç¼ºç‚¹**: è¿æ¥æ•°é™åˆ¶æ›´ä¸¥æ ¼ï¼Œä¸é€‚åˆå¤šè¿›ç¨‹éƒ¨ç½²

### æ–¹æ¡ˆBï¼šä½¿ç”¨ psycopgï¼ˆâŒ ç”Ÿæ€ä¸æˆç†Ÿï¼‰
```python
create_async_engine("postgresql+psycopg://...")
```
**ä¼˜ç‚¹**: psycopg å¯¹ pgbouncer æ”¯æŒæ›´å¥½  
**ç¼ºç‚¹**: SQLAlchemy çš„ psycopg å¼‚æ­¥æ”¯æŒä¸æˆç†Ÿ

### æ–¹æ¡ˆCï¼šæœ¬æ–¹æ¡ˆï¼ˆâœ… æ¨èï¼‰
- ç»§ç»­ä½¿ç”¨ asyncpg + Transaction Mode
- åœ¨ checkin æ—¶ä¸»åŠ¨æ¸…ç†é¢„ç¼–è¯‘è¯­å¥
- å…¼å®¹æ€§å¥½ï¼Œæ€§èƒ½æŸå¤±å¯å¿½ç•¥

---

## ç›¸å…³æ–‡æ¡£
- [20250101_Supabaseæ•°æ®åº“ç»Ÿä¸€è¿ç§».md](./20250101_Supabaseæ•°æ®åº“ç»Ÿä¸€è¿ç§».md)
- [20250101_Supabaseè¿ç§»å®æ–½æŠ¥å‘Š.md](./20250101_Supabaseè¿ç§»å®æ–½æŠ¥å‘Š.md)
- [asyncpg - Prepared Statements](https://magicstack.github.io/asyncpg/current/usage.html#prepared-statements)
- [PostgreSQL - DEALLOCATE](https://www.postgresql.org/docs/current/sql-deallocate.html)
- [Supabase Pooler æ–‡æ¡£](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)

---

## é”™è¯¯ç°è±¡

### å¯åŠ¨æ—¥å¿—
```
2026-01-01 13:25:49 [error] task_recovery_error  error='(sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class \'asyncpg.exceptions.DuplicatePreparedStatementError\'>: prepared statement "__asyncpg_stmt_1__" already exists
HINT:  
NOTE: pgbouncer with pool_mode set to "transaction" or
"statement" does not support prepared statements properly.
You have two options:

* if you are using pgbouncer for connection pooling to a
  single server, switch to the connection pool functionality
  provided by asyncpg, it is a much better option for this
  purpose;

* if you have no option of avoiding the use of pgbouncer,
  then you can set statement_cache_size to 0 when creating
  the asyncpg connection object.
```

### è§¦å‘åœºæ™¯
- åº”ç”¨å¯åŠ¨æ—¶çš„ `task_recovery_starting`ï¼ˆä»»åŠ¡æ¢å¤ï¼‰
- åº”ç”¨å¯åŠ¨æ—¶çš„ `tech_assessments_initialization_started`ï¼ˆæŠ€æœ¯è¯„ä¼°åˆå§‹åŒ–ï¼‰
- ä¸¤ä¸ªæ“ä½œå‡ä½¿ç”¨ SQLAlchemy å¼•æ“åˆ›å»ºæ•°æ®åº“ä¼šè¯

---

## æ ¹æœ¬åŸå› åˆ†æ

### 1. Supabase Transaction Mode å·¥ä½œæœºåˆ¶
- Supabase ä½¿ç”¨ pgbouncer çš„ **Transaction Mode**ï¼ˆç«¯å£ 6543ï¼‰
- æ¯æ¬¡æŸ¥è¯¢å¯èƒ½åœ¨ä¸åŒçš„åç«¯ PostgreSQL è¿æ¥ä¸Šæ‰§è¡Œ
- é¢„ç¼–è¯‘è¯­å¥ç»‘å®šåˆ°ç‰¹å®šåç«¯è¿æ¥ï¼Œå¯¼è‡´åç§°å†²çª

### 2. asyncpg é¢„ç¼–è¯‘è¯­å¥è¡Œä¸º
å³ä½¿è®¾ç½®äº† `statement_cache_size=0`ï¼Œasyncpg ä»ä¼šåœ¨ä»¥ä¸‹æƒ…å†µåˆ›å»ºé¢„ç¼–è¯‘è¯­å¥ï¼š
- SQLAlchemy çš„ `pool_pre_ping=True`ï¼ˆå¥åº·æ£€æŸ¥ï¼‰
- å†…éƒ¨æ‰§è¡Œ `SELECT pg_catalog.version()` ç­‰ç³»ç»ŸæŸ¥è¯¢
- é»˜è®¤çš„é¢„ç¼–è¯‘è¯­å¥åç§°ç”Ÿæˆå‡½æ•° `prepared_statement_name_func`

### 3. ä¸ºä»€ä¹ˆè®¾ç½®äº† `statement_cache_size=0` ä»ç„¶å¤±è´¥ï¼Ÿ
```python
# âŒ ä»…è®¾ç½®ç¼“å­˜å¤§å°ä¸º 0ï¼Œä¸å¤Ÿå……åˆ†
connect_args={
    "statement_cache_size": 0,
    "max_cached_statement_lifetime": 0,
}
```

**é—®é¢˜**ï¼š
- `statement_cache_size=0` ä»…æ§åˆ¶ç¼“å­˜è¡Œä¸ºï¼Œä¸ç¦ç”¨é¢„ç¼–è¯‘è¯­å¥æœ¬èº«
- asyncpg åœ¨æŸäº›å†…éƒ¨æ“ä½œæ—¶ä»ä¼šåˆ›å»ºåŒ¿åé¢„ç¼–è¯‘è¯­å¥
- `pool_pre_ping=True` æ¯æ¬¡å¥åº·æ£€æŸ¥éƒ½ä¼šæ‰§è¡Œ `SELECT 1`ï¼Œè§¦å‘é¢„ç¼–è¯‘è¯­å¥åˆ›å»º

---

## ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒä¿®æ”¹ï¼š`backend/app/db/session.py`

```python
def _create_engine() -> AsyncEngine:
    return create_async_engine(
        settings.DATABASE_URL,
        echo=False,
        pool_size=settings.DB_POOL_SIZE,
        max_overflow=settings.DB_MAX_OVERFLOW,
        pool_pre_ping=False,  # âœ… ç¦ç”¨å¥åº·æ£€æŸ¥ï¼ˆå…³é”®ä¿®å¤ï¼‰
        pool_recycle=300,
        pool_timeout=60,
        pool_use_lifo=True,
        connect_args={
            # Supabase äº‹åŠ¡æ± åŒ–æ¨¡å¼å¿…é¡»é…ç½®
            "statement_cache_size": 0,
            "max_cached_statement_lifetime": 0,
            "prepared_statement_name_func": None,  # âœ… ç¦ç”¨é¢„ç¼–è¯‘è¯­å¥åç§°ç”Ÿæˆï¼ˆå…³é”®ä¿®å¤ï¼‰
            
            # åº”ç”¨çº§é…ç½®
            "server_settings": {
                "application_name": "roadmap_agent",
                "jit": "off",
            },
            "command_timeout": 120,
            "timeout": 30,
        },
    )
```

### å…³é”®é…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹ | å€¼ | ä½œç”¨ | æ˜¯å¦å¿…é¡» |
|-------|---|------|----------|
| `pool_pre_ping` | `False` | ç¦ç”¨è¿æ¥å¥åº·æ£€æŸ¥ | âœ… å¿…é¡» |
| `statement_cache_size` | `0` | ç¦ç”¨å®¢æˆ·ç«¯é¢„ç¼–è¯‘è¯­å¥ç¼“å­˜ | âœ… å¿…é¡» |
| `max_cached_statement_lifetime` | `0` | ç¦ç”¨ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç† | âœ… å¿…é¡» |
| `prepared_statement_name_func` | `None` | ç¦ç”¨é¢„ç¼–è¯‘è¯­å¥åç§°ç”Ÿæˆ | âœ… å¿…é¡» |

---

## ä¸ºä»€ä¹ˆç¦ç”¨ `pool_pre_ping`ï¼Ÿ

### åŸç†
`pool_pre_ping=True` æ—¶ï¼ŒSQLAlchemy åœ¨æ¯æ¬¡ä»è¿æ¥æ± è·å–è¿æ¥å‰ä¼šæ‰§è¡Œï¼š
```sql
SELECT 1
```

è¿™ä¸ªæŸ¥è¯¢åœ¨ asyncpg ä¸­ä¼šè§¦å‘é¢„ç¼–è¯‘è¯­å¥åˆ›å»ºï¼ˆå³ä½¿è®¾ç½®äº† `statement_cache_size=0`ï¼‰ã€‚

### Supabase Transaction Mode ä¸‹çš„è¡Œä¸º
1. **ç¬¬ä¸€æ¬¡è¯·æ±‚**: åˆ›å»ºé¢„ç¼–è¯‘è¯­å¥ `__asyncpg_stmt_1__` â†’ SELECT 1
2. **è¿æ¥å½’è¿˜åˆ° Supabase Pooler**
3. **ç¬¬äºŒæ¬¡è¯·æ±‚**: ä» Pooler è·å–åŒä¸€ä¸ªåç«¯è¿æ¥
4. **å°è¯•å†æ¬¡åˆ›å»º** `__asyncpg_stmt_1__` â†’ **å†²çªé”™è¯¯**

### æ›¿ä»£æ–¹æ¡ˆ
- âœ… ä½¿ç”¨ `pool_recycle=300`ï¼ˆ5åˆ†é’Ÿå›æ”¶è¿æ¥ï¼‰ç¡®ä¿è¿æ¥ä¸ä¼šé•¿æ—¶é—´æŒæœ‰
- âœ… ä¾èµ– Supabase è‡ªèº«çš„è¿æ¥å¥åº·ç®¡ç†
- âœ… é€šè¿‡åº”ç”¨å±‚é‡è¯•æœºåˆ¶å¤„ç†å¶å‘çš„è¿æ¥å¤±æ•ˆ

---

## ä¸ºä»€ä¹ˆè®¾ç½® `prepared_statement_name_func=None`ï¼Ÿ

### asyncpg é»˜è®¤è¡Œä¸º
```python
# é»˜è®¤ç”Ÿæˆå›ºå®šåç§°çš„é¢„ç¼–è¯‘è¯­å¥
def default_name_func(sql):
    return f"__asyncpg_stmt_{hash(sql) % 1000}__"
```

### Supabase Transaction Mode å†²çªåœºæ™¯
- ä¸åŒè¯·æ±‚å¯èƒ½ç”Ÿæˆç›¸åŒçš„è¯­å¥å“ˆå¸Œ
- Pooler è¿æ¥å¤ç”¨å¯¼è‡´åç§°å†²çª

### è®¾ç½®ä¸º `None` çš„æ•ˆæœ
- **å®Œå…¨ç¦ç”¨**é¢„ç¼–è¯‘è¯­å¥çš„åç§°ç”Ÿæˆ
- å¼ºåˆ¶ asyncpg æ¯æ¬¡éƒ½ä½¿ç”¨**ç®€å•æŸ¥è¯¢åè®®**ï¼ˆSimple Query Protocolï¼‰
- é¿å…æ‰€æœ‰é¢„ç¼–è¯‘è¯­å¥ç›¸å…³çš„é”™è¯¯

---

## éªŒè¯ä¿®å¤

### å¯åŠ¨æ—¥å¿—ï¼ˆä¿®å¤åï¼‰
```bash
uv run uvicorn app.main:app --workers 4 --reload --host 0.0.0.0 --port 8000
```

**é¢„æœŸè¾“å‡º**ï¼š
```
2026-01-01 13:30:00 [info] orchestrator_factory_initialized checkpointer_type=AsyncPostgresSaver database_url=aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres
2026-01-01 13:30:00 [info] task_recovery_starting max_age_hours=24 max_concurrent=3
2026-01-01 13:30:01 [info] task_recovery_no_tasks_found
2026-01-01 13:30:01 [info] tech_assessments_initialization_started
2026-01-01 13:30:02 [info] tech_assessments_all_exist_skip_generation
INFO: Application startup complete.
```

**å…³é”®æ£€æŸ¥ç‚¹**ï¼š
- âœ… æ—  `DuplicatePreparedStatementError` é”™è¯¯
- âœ… `task_recovery` æˆåŠŸå®Œæˆ
- âœ… `tech_assessments_initialization` æˆåŠŸå®Œæˆ

---

## å½±å“èŒƒå›´

### ä¿®æ”¹æ–‡ä»¶
- `backend/app/db/session.py` (1 å¤„ä¿®æ”¹)

### å—ç›Šåœºæ™¯
- âœ… åº”ç”¨å¯åŠ¨ï¼ˆtask recovery + tech assessmentsï¼‰
- âœ… API è¯·æ±‚ï¼ˆæ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢ï¼‰
- âœ… Celery ä»»åŠ¡ï¼ˆæ‰€æœ‰å¼‚æ­¥ä»»åŠ¡ï¼‰
- âœ… å¤šè¿›ç¨‹éƒ¨ç½²ï¼ˆuvicorn --workers 4ï¼‰

### æ€§èƒ½å½±å“
- **ç†è®ºæ€§èƒ½æŸå¤±**: ç¦ç”¨é¢„ç¼–è¯‘è¯­å¥åï¼Œæ¯æ¬¡æŸ¥è¯¢éœ€è¦è§£æ SQL
- **å®é™…å½±å“**: å¯å¿½ç•¥ï¼ˆSupabase Transaction Mode æœ¬èº«ä¹Ÿä¸æ”¯æŒè·¨äº‹åŠ¡çš„é¢„ç¼–è¯‘è¯­å¥ç¼“å­˜ï¼‰
- **ç¨³å®šæ€§æå‡**: æ¶ˆé™¤äº†æ‰€æœ‰é¢„ç¼–è¯‘è¯­å¥ç›¸å…³çš„é”™è¯¯

---

## å®Œæ•´çš„ Supabase Transaction Mode é…ç½®æ¸…å•

### SQLAlchemy å¼•æ“ï¼ˆasyncpgï¼‰
```python
# backend/app/db/session.py
create_async_engine(
    settings.DATABASE_URL,
    pool_pre_ping=False,  # ç¦ç”¨å¥åº·æ£€æŸ¥
    pool_recycle=300,     # 5åˆ†é’Ÿå›æ”¶è¿æ¥
    connect_args={
        "statement_cache_size": 0,
        "max_cached_statement_lifetime": 0,
        "prepared_statement_name_func": None,
    }
)
```

### LangGraph Checkpointerï¼ˆpsycopgï¼‰
```python
# backend/app/core/orchestrator_factory.py
AsyncConnectionPool(
    conninfo=settings.CHECKPOINTER_DATABASE_URL,
    kwargs={
        "autocommit": True,
        "prepare_threshold": 0,  # ç¦ç”¨ psycopg é¢„ç¼–è¯‘è¯­å¥
    }
)
```

---

## ç›¸å…³æ–‡æ¡£
- [20250101_Supabaseæ•°æ®åº“ç»Ÿä¸€è¿ç§».md](./20250101_Supabaseæ•°æ®åº“ç»Ÿä¸€è¿ç§».md)
- [20250101_Supabaseè¿ç§»å®æ–½æŠ¥å‘Š.md](./20250101_Supabaseè¿ç§»å®æ–½æŠ¥å‘Š.md)
- [asyncpg å®˜æ–¹æ–‡æ¡£ - Prepared Statements](https://magicstack.github.io/asyncpg/current/usage.html#prepared-statements)
- [Supabase Pooler æ–‡æ¡£](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)

