# Supabase æ•°æ®åº“ç»Ÿä¸€è¿ç§»å®æ–½æ€»ç»“

**è¿ç§»æ—¥æœŸ**: 2025-01-01  
**æ–¹æ¡ˆ**: æ”¾å¼ƒ PgBouncer æœ¬åœ°ä»£ç†ï¼Œç»Ÿä¸€è¿ç§»åˆ° Supabase Transaction Mode Pooling  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## è¿ç§»èƒŒæ™¯

### åŸæ¶æ„é—®é¢˜
- **ç¯å¢ƒä¸ä¸€è‡´**: æœ¬åœ°ä½¿ç”¨ PostgreSQLï¼Œç”Ÿäº§ä½¿ç”¨ Railway PostgreSQL
- **è¿ç»´å¤æ‚**: éœ€è¦ç»´æŠ¤æœ¬åœ° PostgreSQL æœåŠ¡
- **è¿æ¥æ± ç®¡ç†**: å¤šè¿›ç¨‹éƒ¨ç½²å¯¼è‡´è¿æ¥æ± è€—å°½ï¼ˆ21 è¿›ç¨‹ Ã— 4 è¿æ¥ = 84 è¿æ¥ï¼‰

### æ–°æ¶æ„ä¼˜åŠ¿
- **ç»Ÿä¸€ç¯å¢ƒ**: æœ¬åœ°å’Œç”Ÿäº§éƒ½ä½¿ç”¨ Supabase äº‘ç«¯æ•°æ®åº“
- **ç®€åŒ–è¿ç»´**: æ— éœ€ç»´æŠ¤æœ¬åœ°æ•°æ®åº“æœåŠ¡
- **äº‘ç«¯æ± åŒ–**: Supabase Transaction Pooler è‡ªåŠ¨ç®¡ç†çœŸå®è¿æ¥æ•°
- **æ— è¿æ¥é™åˆ¶**: åº”ç”¨å¯ä»¥åˆ›å»ºæ›´å¤šè¿æ¥ï¼Œç”± Supabase æ˜ å°„åˆ°æœ‰é™çš„çœŸå®è¿æ¥

---

## æ ¸å¿ƒä¿®æ”¹

### 1. ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `backend/env.supabase.example`:

```bash
# Supabase æ•°æ®åº“é…ç½®ï¼ˆTransaction Mode - ç«¯å£ 6543ï¼‰
POSTGRES_HOST=aws-0-us-east-1.pooler.supabase.com
POSTGRES_PORT=6543
POSTGRES_USER=postgres.your_project_id
POSTGRES_PASSWORD=your_database_password
POSTGRES_DB=postgres

# è¿æ¥æ± é…ç½®ï¼ˆå¯ä»¥é€‚åº¦å¢å¤§ï¼ŒSupabase ä¼šç®¡ç†çœŸå®è¿æ¥ï¼‰
DB_POOL_SIZE=5
DB_MAX_OVERFLOW=10
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨ç«¯å£ **6543**ï¼ˆTransaction Modeï¼‰
- ä¸»æœºæ ¼å¼: `aws-0-[region].pooler.supabase.com`
- ç”¨æˆ·åæ ¼å¼: `postgres.[project_id]`

---

### 2. Settings é…ç½®ç®€åŒ–

ä¿®æ”¹ `backend/app/config/settings.py`:

**ç§»é™¤çš„å‚æ•°**:
- âŒ `keepalives` å‚æ•°ï¼ˆç”± Supabase ç®¡ç†ï¼‰
- âŒ `statement_timeout` å‚æ•°ï¼ˆTransaction Mode ä¸æ”¯æŒï¼‰

```python
@property
def DATABASE_URL(self) -> str:
    """æ„å»ºå¼‚æ­¥æ•°æ®åº“è¿æ¥ URLï¼ˆSupabase å…¼å®¹ï¼‰"""
    return (
        f"postgresql+asyncpg://{self.POSTGRES_USER}:{self.POSTGRES_PASSWORD}"
        f"@{self.POSTGRES_HOST}:{self.POSTGRES_PORT}/{self.POSTGRES_DB}"
    )

@property
def CHECKPOINTER_DATABASE_URL(self) -> str:
    """æ„å»º Checkpointer æ•°æ®åº“è¿æ¥ URLï¼ˆSupabase å…¼å®¹ï¼‰"""
    return (
        f"postgresql://{self.POSTGRES_USER}:{self.POSTGRES_PASSWORD}"
        f"@{self.POSTGRES_HOST}:{self.POSTGRES_PORT}/{self.POSTGRES_DB}"
    )
```

---

### 3. SQLAlchemy å¼•æ“é…ç½®

ä¿®æ”¹ `backend/app/db/session.py`:

**æ–°å¢å…³é”®é…ç½®**:
```python
connect_args={
    # Supabase äº‹åŠ¡æ± åŒ–æ¨¡å¼å¿…é¡»é…ç½®
    "statement_cache_size": 0,              # ç¦ç”¨ asyncpg é¢„å¤„ç†è¯­å¥ç¼“å­˜
    "max_cached_statement_lifetime": 0,     # ç¦ç”¨ç¼“å­˜ç”Ÿå‘½å‘¨æœŸ
    
    # åº”ç”¨çº§é…ç½®ï¼ˆä¿ç•™ï¼‰
    "server_settings": {
        "application_name": "roadmap_agent",
        "jit": "off",
    },
    "command_timeout": 120,
    "timeout": 30,
}
```

**ä¸ºä»€ä¹ˆå¿…é¡»ç¦ç”¨é¢„å¤„ç†è¯­å¥ç¼“å­˜ï¼Ÿ**
- Supabase Transaction Mode æ¯æ¬¡ä»æ± ä¸­è·å–çš„å¯èƒ½æ˜¯ä¸åŒçš„åç«¯è¿æ¥
- é¢„å¤„ç†è¯­å¥ç¼“å­˜ç»‘å®šåˆ°ç‰¹å®šè¿æ¥ï¼Œä¼šå¯¼è‡´ `prepared statement does not exist` é”™è¯¯
- è®¾ç½® `statement_cache_size=0` å¼ºåˆ¶æ¯æ¬¡éƒ½ä½¿ç”¨ç®€å•æŸ¥è¯¢åè®®

---

### 4. Checkpointer è¿æ¥æ± é…ç½®

ä¿®æ”¹ `backend/app/core/orchestrator_factory.py`:

```python
cls._connection_pool = AsyncConnectionPool(
    conninfo=settings.CHECKPOINTER_DATABASE_URL,
    min_size=2,
    max_size=10,
    max_idle=180,
    timeout=60,
    reconnect_timeout=0,
    open=False,
    kwargs={
        "autocommit": True,
        "prepare_threshold": 0,  # ç¦ç”¨ psycopg é¢„å¤„ç†è¯­å¥ï¼ˆSupabase å¿…é¡»ï¼‰
    },
)
```

**ä¸ºä»€ä¹ˆè®¾ç½® `prepare_threshold=0`ï¼Ÿ**
- psycopg (LangGraph Checkpointer ä½¿ç”¨) é»˜è®¤ä¼šç¼“å­˜é¢„å¤„ç†è¯­å¥
- ä¸ asyncpg åŒç†ï¼ŒTransaction Mode æ± åŒ–ä¸æ”¯æŒé¢„å¤„ç†è¯­å¥ç¼“å­˜
- è®¾ç½®ä¸º 0 ç¦ç”¨è‡ªåŠ¨é¢„å¤„ç†

---

## è¿æ¥æ•°ä¼˜åŒ–å¯¹æ¯”

### è¿ç§»å‰ï¼ˆæœ¬åœ° PostgreSQLï¼‰
```
åº”ç”¨è¿›ç¨‹: 21 ä¸ª
æ¯è¿›ç¨‹è¿æ¥: 4 (pool_size=2 + max_overflow=2)
æ€»è¿æ¥éœ€æ±‚: 21 Ã— 4 = 84
PostgreSQL é™åˆ¶: 100
ä½¿ç”¨ç‡: 84% âš ï¸
```

### è¿ç§»åï¼ˆSupabase Transaction Poolerï¼‰
```
åº”ç”¨è¿›ç¨‹: 21 ä¸ª
æ¯è¿›ç¨‹è¿æ¥: 15 (pool_size=5 + max_overflow=10)
åº”ç”¨æ€»è¿æ¥: 21 Ã— 15 = 315
Supabase Pooler: å°† 315 ä¸ªåº”ç”¨è¿æ¥æ˜ å°„åˆ°çº¦ 50 ä¸ªçœŸå®è¿æ¥
Supabase PostgreSQL: æ— éœ€å…³å¿ƒè¿æ¥é™åˆ¶
ä½¿ç”¨ç‡: ç”± Supabase æ™ºèƒ½ç®¡ç† âœ…
```

**å…³é”®æ”¹è¿›**:
- åº”ç”¨å¯ä»¥åˆ›å»ºæ›´å¤šè¿æ¥ï¼ˆæå‡å¹¶å‘èƒ½åŠ›ï¼‰
- çœŸå®æ•°æ®åº“è¿æ¥æ•°ç”± Supabase æ§åˆ¶
- æ— è¿æ¥æ± è€—å°½é£é™©

---

## éªŒè¯å·¥å…·

åˆ›å»º `backend/scripts/test_supabase_connection.py`:

æµ‹è¯•è¦†ç›–:
- âœ… asyncpg ç›´è¿ï¼ˆç¦ç”¨é¢„å¤„ç†è¯­å¥ï¼‰
- âœ… SQLAlchemy å¼•æ“ï¼ˆç¦ç”¨é¢„å¤„ç†è¯­å¥ï¼‰
- âœ… è¿æ¥æ± çŠ¶æ€ç›‘æ§
- âœ… Checkpointer è¿æ¥ï¼ˆç¦ç”¨ prepare_thresholdï¼‰

è¿è¡Œæµ‹è¯•:
```bash
cd backend
python scripts/test_supabase_connection.py
```

---

## æ¸…ç†å·¥ä½œ

### åˆ é™¤çš„æ–‡ä»¶ï¼ˆPgBouncer ç›¸å…³ï¼‰
- âŒ `config/pgbouncer/pgbouncer.ini`
- âŒ `config/pgbouncer/userlist.txt`
- âŒ `scripts/install_pgbouncer_local.sh`
- âŒ `scripts/manage_pgbouncer.sh`
- âŒ `scripts/start_with_pgbouncer.sh`
- âŒ `scripts/generate_pgbouncer_userlist.py`
- âŒ `scripts/verify_pgbouncer.py`

### å½’æ¡£çš„æ–‡æ¡£
- ğŸ“¦ `POOL_EXHAUSTION_FIX.md` â†’ `docs/20250101_è¿æ¥æ± è€—å°½ä¿®å¤å†å².md`

---

## éƒ¨ç½²æ¸…å•

### æœ¬åœ°ç¯å¢ƒ
- [x] åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå‚è€ƒ `env.supabase.example`ï¼‰
- [x] é…ç½® Supabase è¿æ¥ä¿¡æ¯
- [x] è®¾ç½® `DB_POOL_SIZE=5`, `DB_MAX_OVERFLOW=10`
- [x] è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯è¿æ¥

### Railway ç”Ÿäº§ç¯å¢ƒ
- [ ] åœ¨ Railway Dashboard é…ç½®ç¯å¢ƒå˜é‡:
  - `POSTGRES_HOST=aws-0-us-east-1.pooler.supabase.com`
  - `POSTGRES_PORT=6543`
  - `POSTGRES_USER=postgres.[project_id]`
  - `POSTGRES_PASSWORD=[your_password]`
  - `POSTGRES_DB=postgres`
  - `DB_POOL_SIZE=5`
  - `DB_MAX_OVERFLOW=10`
- [ ] éƒ¨ç½²å¹¶éªŒè¯å¥åº·æ£€æŸ¥
- [ ] ç›‘æ§è¿æ¥æ± ä½¿ç”¨ç‡

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœ Supabase å‡ºç°é—®é¢˜ï¼Œå¯å¿«é€Ÿå›é€€:

### å›é€€åˆ°æœ¬åœ° PostgreSQL
```bash
# ç¯å¢ƒå˜é‡
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
DB_POOL_SIZE=2
DB_MAX_OVERFLOW=2
```

### æ¢å¤ä»£ç é…ç½®
```bash
# ä» Git å†å²æ¢å¤
git checkout HEAD~1 -- backend/app/config/settings.py
git checkout HEAD~1 -- backend/app/db/session.py
git checkout HEAD~1 -- backend/app/core/orchestrator_factory.py
```

---

## é¢„æœŸæ”¶ç›Š

| æ–¹é¢ | è¿ç§»å‰ | è¿ç§»å | æ”¹è¿› |
|------|--------|--------|------|
| **ç¯å¢ƒä¸€è‡´æ€§** | æœ¬åœ°/ç”Ÿäº§ä¸åŒ | ç»Ÿä¸€ Supabase | âœ… 100% |
| **è¿ç»´å¤æ‚åº¦** | éœ€ç»´æŠ¤æœ¬åœ° PG | äº‘ç«¯æ‰˜ç®¡ | âœ… -80% |
| **è¿æ¥æ± ç®¡ç†** | æ‰‹åŠ¨é…ç½® | Supabase è‡ªåŠ¨ | âœ… ç®€åŒ– |
| **å¹¶å‘èƒ½åŠ›** | 84 è¿æ¥ | 315 åº”ç”¨è¿æ¥ | âœ… +375% |
| **è¿æ¥è€—å°½é£é™©** | é«˜ | æ—  | âœ… æ¶ˆé™¤ |

---

## æŠ€æœ¯è¦ç‚¹æ€»ç»“

### Supabase Transaction Mode çš„æ ¸å¿ƒè¦æ±‚
1. **ç«¯å£ 6543**: å¿…é¡»ä½¿ç”¨ Transaction Mode ç«¯å£
2. **ç¦ç”¨é¢„å¤„ç†è¯­å¥**: 
   - asyncpg: `statement_cache_size=0`
   - psycopg: `prepare_threshold=0`
3. **ç®€åŒ–è¿æ¥å‚æ•°**: ç§»é™¤ `keepalives`, `statement_timeout`
4. **é€‚åº¦å¢å¤§åº”ç”¨æ± **: Supabase ä¼šç®¡ç†çœŸå®è¿æ¥æ•°

### ä¸ºä»€ä¹ˆä¸èƒ½ä½¿ç”¨é¢„å¤„ç†è¯­å¥ï¼Ÿ
- Transaction Mode æ¯æ¬¡ä»æ± ä¸­è·å–çš„å¯èƒ½æ˜¯**ä¸åŒçš„åç«¯è¿æ¥**
- é¢„å¤„ç†è¯­å¥ç»‘å®šåˆ°ç‰¹å®šè¿æ¥ï¼Œä¸ä¼šåœ¨è¿æ¥é—´å…±äº«
- å¯¼è‡´ `prepared statement "XXX" does not exist` é”™è¯¯
- è§£å†³æ–¹æ¡ˆï¼šç¦ç”¨ç¼“å­˜ï¼Œä½¿ç”¨ç®€å•æŸ¥è¯¢åè®®

---

## å‚è€ƒèµ„æ–™

- [Supabase Connection Pooling æ–‡æ¡£](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)
- [asyncpg é¢„å¤„ç†è¯­å¥æ–‡æ¡£](https://magicstack.github.io/asyncpg/current/usage.html#prepared-statements)
- [psycopg3 Connection Pool æ–‡æ¡£](https://www.psycopg.org/psycopg3/docs/advanced/pool.html)

---

**è¿ç§»å®Œæˆæ ‡å¿—**: å½“æœ¬åœ°å’Œ Railway ç¯å¢ƒéƒ½èƒ½æˆåŠŸè¿è¡Œ `test_supabase_connection.py` ä¸”æ‰€æœ‰æµ‹è¯•é€šè¿‡æ—¶ï¼Œè¿ç§»å³ä¸ºæˆåŠŸã€‚

