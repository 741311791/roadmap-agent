# é‡è¯•ä»»åŠ¡æ‰§è¡Œæ—¥å¿— step å­—æ®µä¿®å¤

**æ—¥æœŸ**: 2026-01-04  
**ç±»å‹**: Bug Fix  
**å½±å“èŒƒå›´**: åç«¯é‡è¯•ä»»åŠ¡ã€æ‰§è¡Œæ—¥å¿—

---

## é—®é¢˜æè¿°

**ç°è±¡**:
- é‡è¯•ä»»åŠ¡ï¼ˆ`retry_tutorial_task`, `retry_resources_task`, `retry_quiz_task`ï¼‰æ‰§è¡Œæ—¶ï¼Œ`roadmap_test.public.execution_logs` è¡¨ä¸­çš„ `step` å­—æ®µå€¼ä¸º `null`
- å¯¼è‡´æ— æ³•é€šè¿‡ `step` å­—æ®µç­›é€‰å’Œè¿½è¸ªé‡è¯•ä»»åŠ¡çš„æ‰§è¡Œæ—¥å¿—
- å½±å“æ—¥å¿—æŸ¥è¯¢å’Œé—®é¢˜æ’æŸ¥

**æ ¹æœ¬åŸå› **:
- é‡è¯•ä»»åŠ¡åªåœ¨æˆåŠŸå®Œæˆåæ‰è®°å½•æ‰§è¡Œæ—¥å¿—ï¼ˆç¬¬ 182-190 è¡Œï¼‰
- ä»»åŠ¡å¼€å§‹æ—¶æ²¡æœ‰è®°å½•æ—¥å¿—
- ä»»åŠ¡å¤±è´¥æ—¶ä¹Ÿæ²¡æœ‰è®°å½•æ‰§è¡Œæ—¥å¿—
- å¯¼è‡´å¤§éƒ¨åˆ†é‡è¯•ä»»åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹æ²¡æœ‰å®Œæ•´çš„æ—¥å¿—è®°å½•

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

åœ¨ä¸‰ä¸ªé‡è¯•ä»»åŠ¡å‡½æ•°ä¸­æ·»åŠ å®Œæ•´çš„æ—¥å¿—è®°å½•ï¼š

1. **ä»»åŠ¡å¼€å§‹æ—¶è®°å½•æ—¥å¿—**ï¼šåœ¨ä»»åŠ¡å¼€å§‹æ‰§è¡Œæ—¶ç«‹å³è®°å½•æ—¥å¿—ï¼ŒåŒ…å« `step` å­—æ®µ
2. **ä»»åŠ¡å¤±è´¥æ—¶è®°å½•æ—¥å¿—**ï¼šåœ¨å¼‚å¸¸å¤„ç†ä¸­è®°å½•å¤±è´¥æ—¥å¿—ï¼ŒåŒ…å« `step` å­—æ®µå’Œé”™è¯¯ä¿¡æ¯

### ä¿®æ”¹æ–‡ä»¶

**æ–‡ä»¶**: `backend/app/tasks/content_retry_tasks.py`

#### 1. Tutorial é‡è¯•ä»»åŠ¡

**æ·»åŠ å¼€å§‹æ—¥å¿—**:

```python
async def _async_retry_tutorial(...):
    """å¼‚æ­¥æ‰§è¡Œæ•™ç¨‹é‡è¯•é€»è¾‘"""
    from app.models.domain import Concept, LearningPreferences, TutorialGenerationInput
    from app.agents.factory import get_agent_factory
    from app.services.execution_logger import execution_logger, LogCategory
    
    concept = Concept.model_validate(concept_data)
    preferences = LearningPreferences.model_validate(user_preferences_data)
    
    # ğŸ†• è®°å½•é‡è¯•å¼€å§‹æ—¥å¿—
    await execution_logger.info(
        task_id=task_id,
        category=LogCategory.WORKFLOW,
        step="content_generation",  # âœ… ç»Ÿä¸€ä½¿ç”¨ content_generation
        roadmap_id=roadmap_id,
        concept_id=concept_id,
        message=f"ğŸ”„ Starting tutorial retry for {concept.name}",
    )
    
    # ... æ‰§è¡Œé€»è¾‘ ...
```

**æ·»åŠ å¤±è´¥æ—¥å¿—**:

```python
    except Exception as e:
        logger.error(
            "retry_tutorial_execution_failed",
            task_id=task_id,
            roadmap_id=roadmap_id,
            concept_id=concept_id,
            error=str(e),
        )
        
        # ğŸ†• è®°å½•å¤±è´¥æ—¥å¿—
        await execution_logger.error(
            task_id=task_id,
            category=LogCategory.WORKFLOW,
            step="content_generation",  # âœ… ç»Ÿä¸€ä½¿ç”¨ content_generation
            roadmap_id=roadmap_id,
            concept_id=concept_id,
            message=f"âŒ Tutorial retry failed for {concept.name}: {str(e)[:100]}",
            details={"error": str(e)},
        )
        
        # ... é”™è¯¯å¤„ç† ...
```

#### 2. Resources é‡è¯•ä»»åŠ¡

åŒæ ·çš„ä¿®æ”¹åº”ç”¨åˆ° `_async_retry_resources()` å‡½æ•°ï¼š
- æ·»åŠ å¼€å§‹æ—¥å¿—ï¼ˆ`step="content_generation"`ï¼‰
- æ·»åŠ å¤±è´¥æ—¥å¿—ï¼ˆ`step="content_generation"`ï¼‰

#### 3. Quiz é‡è¯•ä»»åŠ¡

åŒæ ·çš„ä¿®æ”¹åº”ç”¨åˆ° `_async_retry_quiz()` å‡½æ•°ï¼š
- æ·»åŠ å¼€å§‹æ—¥å¿—ï¼ˆ`step="content_generation"`ï¼‰
- æ·»åŠ å¤±è´¥æ—¥å¿—ï¼ˆ`step="content_generation"`ï¼‰

**é‡è¦è¯´æ˜**ï¼šå†…å®¹ç”Ÿæˆç›¸å…³çš„æ‰€æœ‰ä»»åŠ¡ï¼ˆé¦–æ¬¡ç”Ÿæˆå’Œé‡è¯•ï¼‰ç»Ÿä¸€ä½¿ç”¨ `step="content_generation"` è¿™ä¸€ä¸ªæšä¸¾å€¼ï¼Œä¸åº”è¯¥åˆ›å»ºæ–°çš„æšä¸¾å€¼ã€‚

---

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```sql
SELECT step, COUNT(*) 
FROM execution_logs 
WHERE category = 'workflow' AND message LIKE '%retry%'
GROUP BY step;

-- ç»“æœ:
-- step  | count
-- NULL  | 150    -- âŒ æ‰€æœ‰é‡è¯•æ—¥å¿—çš„ step éƒ½æ˜¯ null
```

### ä¿®å¤å

```sql
SELECT step, COUNT(*) 
FROM execution_logs 
WHERE category = 'workflow' AND message LIKE '%retry%'
GROUP BY step;

-- ç»“æœ:
-- step                | count
-- content_generation  | 150   -- âœ… æ‰€æœ‰é‡è¯•ä»»åŠ¡ç»Ÿä¸€ä½¿ç”¨ content_generation
```

### æ—¥å¿—è®°å½•æ—¶æœº

| æ—¶æœº | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ä»»åŠ¡å¼€å§‹ | âŒ æ— æ—¥å¿— | âœ… è®°å½•å¼€å§‹æ—¥å¿—ï¼ˆstep = "content_generation"ï¼‰ |
| ä»»åŠ¡æˆåŠŸ | âœ… è®°å½•æˆåŠŸæ—¥å¿—ï¼ˆstep æœ‰å€¼ï¼‰ | âœ… è®°å½•æˆåŠŸæ—¥å¿—ï¼ˆstep = "content_generation"ï¼‰ |
| ä»»åŠ¡å¤±è´¥ | âŒ æ— æ—¥å¿— | âœ… è®°å½•å¤±è´¥æ—¥å¿—ï¼ˆstep = "content_generation"ï¼‰ |

---

## è¾…åŠ©å·¥å…·

### 1. è°ƒè¯•è„šæœ¬

**æ–‡ä»¶**: `backend/scripts/debug_retry_logs.py`

**åŠŸèƒ½**:
- æ£€æŸ¥é‡è¯•ä»»åŠ¡çš„æ‰§è¡Œæ—¥å¿—
- ç»Ÿè®¡ `step` ä¸º null çš„æ—¥å¿—æ•°é‡
- æ˜¾ç¤ºæ—¥å¿—è¯¦æƒ…

**ç”¨æ³•**:
```bash
cd backend

# æ£€æŸ¥æŒ‡å®šä»»åŠ¡çš„æ—¥å¿—
python scripts/debug_retry_logs.py <task_id>

# æ£€æŸ¥æœ€è¿‘çš„é‡è¯•æ—¥å¿—
python scripts/debug_retry_logs.py
```

### 2. ä¿®å¤è„šæœ¬

**æ–‡ä»¶**: `backend/scripts/fix_retry_logs_step.py`

**åŠŸèƒ½**:
- æŸ¥æ‰¾ `step` ä¸º null çš„é‡è¯•æ—¥å¿—
- æ ¹æ® `message` å†…å®¹æ¨æ–­ `step` å€¼
- æ‰¹é‡æ›´æ–°æ•°æ®åº“

**ç”¨æ³•**:
```bash
cd backend

# å¹²è¿è¡Œæ¨¡å¼ï¼ˆä¸ä¿®æ”¹æ•°æ®åº“ï¼‰
python scripts/fix_retry_logs_step.py

# å®é™…æ‰§è¡Œæ¨¡å¼ï¼ˆä¼šä¿®æ”¹æ•°æ®åº“ï¼‰
python scripts/fix_retry_logs_step.py --execute
```

**æ¨æ–­è§„åˆ™**:
- message åŒ…å« "retry" æˆ– "regenerat" â†’ step = "content_generation"
- å†…å®¹ç”Ÿæˆç›¸å…³çš„æ‰€æœ‰ä»»åŠ¡ï¼ˆé¦–æ¬¡ç”Ÿæˆå’Œé‡è¯•ï¼‰ç»Ÿä¸€ä½¿ç”¨ `content_generation` è¿™ä¸€ä¸ªæšä¸¾å€¼

---

## å½±å“èŒƒå›´

### åç«¯

**ä¿®æ”¹æ–‡ä»¶**:
- `backend/app/tasks/content_retry_tasks.py` - æ·»åŠ å¼€å§‹å’Œå¤±è´¥æ—¥å¿—è®°å½•

**å½±å“åŠŸèƒ½**:
- Tutorial é‡è¯•ä»»åŠ¡
- Resources é‡è¯•ä»»åŠ¡
- Quiz é‡è¯•ä»»åŠ¡

### æ•°æ®åº“

**è¡¨**: `roadmap_test.public.execution_logs`

**å½±å“å­—æ®µ**:
- `step`: ä» null å˜ä¸ºæœ‰æ„ä¹‰çš„å€¼ï¼ˆ`retry_tutorial`, `retry_resources`, `retry_quiz`ï¼‰

**æ•°æ®ä¸€è‡´æ€§**:
- ä¿®å¤å‰çš„å†å²æ•°æ®ï¼š`step` ä»ä¸º nullï¼ˆå¯ä½¿ç”¨ä¿®å¤è„šæœ¬æ›´æ–°ï¼‰
- ä¿®å¤åçš„æ–°æ•°æ®ï¼š`step` æ­£ç¡®è®°å½•

---

## æ³¨æ„äº‹é¡¹

### 1. å†å²æ•°æ®

ä¿®å¤åªå½±å“æ–°äº§ç”Ÿçš„æ—¥å¿—ï¼Œå†å²æ•°æ®ä¸­ `step` ä¸º null çš„è®°å½•éœ€è¦ä½¿ç”¨ä¿®å¤è„šæœ¬æ›´æ–°ã€‚

### 2. æ—¥å¿—æŸ¥è¯¢

ä¿®å¤åå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢ï¼š

```sql
-- æŸ¥è¯¢æ‰€æœ‰å†…å®¹ç”Ÿæˆï¼ˆåŒ…æ‹¬é‡è¯•ï¼‰çš„æ—¥å¿—
SELECT * FROM execution_logs 
WHERE step = 'content_generation'
ORDER BY created_at DESC;

-- æŸ¥è¯¢ç‰¹å®šä»»åŠ¡çš„å†…å®¹ç”Ÿæˆæ—¥å¿—
SELECT * FROM execution_logs 
WHERE task_id = '<task_id>' 
  AND step = 'content_generation'
ORDER BY created_at;

-- æŸ¥è¯¢é‡è¯•ä»»åŠ¡çš„æ—¥å¿—ï¼ˆé€šè¿‡ message åŒºåˆ†ï¼‰
SELECT * FROM execution_logs 
WHERE step = 'content_generation'
  AND (message LIKE '%retry%' OR message LIKE '%regenerat%')
ORDER BY created_at DESC;

-- ç»Ÿè®¡å†…å®¹ç”Ÿæˆä»»åŠ¡çš„æˆåŠŸ/å¤±è´¥ç‡
SELECT 
    level,
    COUNT(*) as count,
    COUNT(CASE WHEN message LIKE '%retry%' THEN 1 END) as retry_count
FROM execution_logs 
WHERE step = 'content_generation'
GROUP BY level;
```

### 3. æ€§èƒ½å½±å“

- æ¯ä¸ªé‡è¯•ä»»åŠ¡å¢åŠ  2 æ¡æ—¥å¿—è®°å½•ï¼ˆå¼€å§‹ + æˆåŠŸ/å¤±è´¥ï¼‰
- æ—¥å¿—é€šè¿‡ Celery å¼‚æ­¥é˜Ÿåˆ—å¤„ç†ï¼Œä¸å½±å“ä¸»æµç¨‹æ€§èƒ½
- ä½¿ç”¨æœ¬åœ°ç¼“å†²åŒºæ‰¹é‡å‘é€ï¼Œå‡å°‘æ•°æ®åº“æ“ä½œ

---

## åç»­ä¼˜åŒ–å»ºè®®

### 1. ç»Ÿä¸€æ—¥å¿—è®°å½•æ¨¡å¼

å»ºè®®åœ¨æ‰€æœ‰ Celery ä»»åŠ¡ä¸­ç»Ÿä¸€ä½¿ç”¨ä»¥ä¸‹æ¨¡å¼ï¼š
- ä»»åŠ¡å¼€å§‹æ—¶è®°å½•å¼€å§‹æ—¥å¿—
- ä»»åŠ¡æˆåŠŸæ—¶è®°å½•æˆåŠŸæ—¥å¿—
- ä»»åŠ¡å¤±è´¥æ—¶è®°å½•å¤±è´¥æ—¥å¿—

### 2. æ·»åŠ æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯

åœ¨æ—¥å¿—ä¸­æ·»åŠ æ›´å¤šæœ‰ç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š
- é‡è¯•åŸå› ï¼ˆé¦–æ¬¡å¤±è´¥çš„é”™è¯¯ä¿¡æ¯ï¼‰
- é‡è¯•æ¬¡æ•°ï¼ˆç¬¬å‡ æ¬¡é‡è¯•ï¼‰
- é¢„è®¡å®Œæˆæ—¶é—´

### 3. æ—¥å¿—ç›‘æ§å‘Šè­¦

åŸºäº `step` å­—æ®µå»ºç«‹ç›‘æ§å‘Šè­¦ï¼š
- é‡è¯•ä»»åŠ¡å¤±è´¥ç‡è¿‡é«˜æ—¶å‘Šè­¦
- é‡è¯•ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿æ—¶å‘Šè­¦

---

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†é‡è¯•ä»»åŠ¡æ‰§è¡Œæ—¥å¿— `step` å­—æ®µä¸º null çš„é—®é¢˜ï¼š

1. **å®Œæ•´æ€§**: æ·»åŠ äº†ä»»åŠ¡å¼€å§‹å’Œå¤±è´¥æ—¶çš„æ—¥å¿—è®°å½•
2. **å¯è¿½è¸ªæ€§**: æ‰€æœ‰é‡è¯•ä»»åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹éƒ½æœ‰å®Œæ•´çš„æ—¥å¿—
3. **å¯æŸ¥è¯¢æ€§**: å¯ä»¥é€šè¿‡ `step` å­—æ®µç­›é€‰å’Œåˆ†æé‡è¯•ä»»åŠ¡

ä¿®å¤åï¼Œé‡è¯•ä»»åŠ¡çš„æ‰§è¡Œæ—¥å¿—æ›´åŠ å®Œæ•´å’Œå¯è¿½è¸ªï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥å’Œæ€§èƒ½åˆ†æã€‚

