# 全局异常处理重构实施总结

**日期**: 2026-01-03  
**类型**: 架构重构  
**影响范围**: FastAPI + Celery Worker

---

## 概述

实现了统一的全局异常捕获机制，确保生产环境隐藏 Python 堆栈信息，所有错误以统一格式返回或记录。

## 实施内容

### 1. 错误响应模型 (`app/core/exceptions.py`)

创建了标准化的错误响应格式：

```json
{
  "error": {
    "code": "INTERNAL_SERVER_ERROR",
    "message": "用户友好的错误描述",
    "details": {},
    "request_id": "uuid",
    "timestamp": "ISO8601",
    "debug_info": {
      "exception_type": "ValueError",
      "traceback": "...",
      "locals": {}
    }
  }
}
```

**核心组件**：
- `ErrorCode` 枚举：定义标准错误码（VALIDATION_ERROR、NOT_FOUND、INTERNAL_SERVER_ERROR 等）
- `ErrorResponse` 模型：Pydantic 模型，确保响应格式一致
- `format_error_response()` 工具函数：根据环境变量自动决定是否包含调试信息
- `sanitize_error_message()` 函数：移除敏感信息（数据库连接字符串、API 密钥等）

### 2. FastAPI 全局异常处理器 (`app/core/global_exception_handlers.py`)

注册了 4 个全局异常处理器：

| 异常类型 | HTTP 状态码 | 处理逻辑 |
|---------|-----------|---------|
| `HTTPException` | 原状态码 | 提取 detail，格式化响应 |
| `RequestValidationError` | 422 | 解析 Pydantic 验证错误，返回友好消息 |
| `SQLAlchemyError` | 500 | 数据库错误，隐藏 SQL 细节 |
| `Exception`（通用） | 500 | 兜底处理，记录完整日志，返回通用错误 |

**关键特性**：
- 自动从 `request.state` 提取 `request_id`
- 使用 `structlog` 记录结构化日志（包含 URL、method、client_ip、user_id等）
- 生产环境自动隐藏敏感信息

### 3. Request ID 中间件 (`app/middleware/request_id.py`)

功能：
- 为每个请求生成唯一标识（UUID）
- 支持从请求头 `X-Request-ID` 读取（客户端可传递）
- 将 `request_id` 注入到 `request.state.request_id`
- 在响应头中返回 `X-Request-ID`
- 自动将 `request_id` 添加到 `structlog` 上下文

### 4. Celery Worker 异常处理 (`app/core/celery_error_handler.py`)

实现了 Celery 任务的统一异常处理：

- **`@safe_task` 装饰器**：自动捕获任务异常，记录日志，更新任务状态
- **`update_task_status_failed()` 函数**：更新任务状态为 `failed`
- **`should_retry()` 函数**：判断异常是否应该重试
- **`exponential_backoff()` 函数**：计算指数退避延迟

### 5. Celery 信号处理器 (`app/core/celery_app.py`)

注册了 2 个 Celery 信号处理器：

- **`task_failure` 信号**：捕获所有未被 `@safe_task` 处理的任务异常
- **`task_retry` 信号**：记录任务重试事件

### 6. FastAPI 主应用集成 (`app/main.py`)

- 注册 Request ID 中间件（优先级最高）
- 注册 4 个全局异常处理器

---

## 架构说明

本项目包含两个独立的异常处理域：

| 域 | 进程类型 | 错误输出 | 处理机制 |
|---|---------|---------|---------|
| **FastAPI** | uvicorn 进程 | HTTP JSON 响应 | `app.add_exception_handler()` |
| **Celery Worker** | Celery Worker 进程 | 结构化日志 + 任务状态更新 | Celery Signals + 任务装饰器 |

---

## 环境配置

使用现有的环境变量控制行为：

- `ENVIRONMENT`（`development` / `production`）：控制是否包含调试信息
- `DEBUG`（`True` / `False`）：开发模式下的额外调试标志

**默认行为**：
- 开发环境（`DEBUG=True` 或 `ENVIRONMENT=development`）：包含完整堆栈跟踪
- 生产环境（`ENVIRONMENT=production`）：隐藏堆栈跟踪，仅记录到日志

---

## 文件清单

### 新建文件

| 文件 | 说明 |
|-----|------|
| `backend/app/core/exceptions.py` | 错误响应模型、错误码枚举 |
| `backend/app/core/global_exception_handlers.py` | FastAPI 全局异常处理器 |
| `backend/app/middleware/request_id.py` | Request ID 中间件 |
| `backend/app/core/celery_error_handler.py` | Celery 任务异常处理装饰器和工具函数 |

### 修改文件

| 文件 | 修改内容 |
|-----|---------|
| `backend/app/main.py` | 注册异常处理器和中间件 |
| `backend/app/core/celery_app.py` | 注册 Celery 错误信号处理器 |

---

## 现有代码兼容性

### FastAPI 端点

✅ **零侵入**：现有代码无需修改，继续使用 `HTTPException`

示例：
```python
from fastapi import HTTPException

@router.get("/items/{item_id}")
async def get_item(item_id: str):
    if not item_exists(item_id):
        raise HTTPException(status_code=404, detail="Item not found")
    return item
```

全局异常处理器会自动捕获并格式化响应。

### Celery 任务

✅ **现有任务无需重构**：Celery 信号处理器作为全局兜底机制

现有任务继续使用 `run_async` 模式：
```python
@celery_app.task(bind=True)
def my_task(self, task_id: str):
    try:
        result = run_async(_async_logic(task_id))
        return result
    except Exception as e:
        logger.error("task_failed", error=str(e))
        raise
```

**新任务可选使用 `@safe_task`**：
```python
from app.core.celery_error_handler import safe_task

@safe_task(bind=True, max_retries=3)
async def new_task(self, task_id: str):
    # 任务逻辑
    # 异常自动处理，无需手动 try-except
    pass
```

---

## 测试验证

### 单元测试

- ✅ 错误响应模型格式验证
- ✅ 调试信息包含/隐藏逻辑
- ✅ 敏感信息清理函数

### 集成测试（建议）

启动应用后进行以下测试：

1. **验证错误（422）**：发送无效请求体
   ```bash
   curl -X POST http://localhost:8000/api/v1/roadmaps/generate \
     -H "Content-Type: application/json" \
     -d '{"invalid": "data"}'
   ```

2. **业务异常（404）**：访问不存在的资源
   ```bash
   curl http://localhost:8000/api/v1/roadmaps/nonexistent-id
   ```

3. **未捕获异常（500）**：触发通用异常处理器
   - 在测试端点中抛出 `raise ValueError("Test error")`
   - 验证响应格式和日志

4. **生产环境模式**：
   ```bash
   export ENVIRONMENT=production
   # 重启应用，验证 debug_info 字段不存在
   ```

5. **Request ID 验证**：
   ```bash
   curl -H "X-Request-ID: custom-123" http://localhost:8000/health
   # 验证响应头包含 X-Request-ID: custom-123
   ```

---

## 日志示例

### FastAPI 异常日志

```json
{
  "event": "http_exception",
  "status_code": 404,
  "error_code": "NOT_FOUND",
  "message": "Roadmap not found",
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "url": "http://localhost:8000/api/v1/roadmaps/abc123",
  "method": "GET",
  "timestamp": "2026-01-03T10:30:00Z"
}
```

### Celery 任务失败日志

```json
{
  "event": "celery_task_failed",
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "task_name": "generate_roadmap",
  "error_type": "ValueError",
  "error_message": "Invalid input data",
  "traceback": "..."  // 仅开发环境
}
```

---

## 优势

### FastAPI 部分
- ✅ **零侵入**：现有代码无需修改
- ✅ **统一格式**：前端可以依赖固定的 JSON 结构解析错误
- ✅ **生产安全**：自动隐藏敏感信息和堆栈
- ✅ **可追溯**：每个错误都有唯一 `request_id`

### Celery Worker 部分
- ✅ **全局兜底**：Celery 信号处理器捕获所有未处理异常
- ✅ **统一日志格式**：结构化日志，便于排查问题
- ✅ **灵活重试**：支持可配置的重试策略
- ✅ **渐进式迁移**：新任务可选使用 `@safe_task`

### 整体优势
- ✅ **可扩展**：未来可轻松添加错误码映射、多语言支持、错误聚合监控
- ✅ **开发体验**：开发环境保留完整调试信息，生产环境自动脱敏

---

## 后续优化建议

1. **错误监控集成**：集成 Sentry/Datadog 等监控平台，自动上报错误
2. **错误统计**：定期分析错误日志，发现系统瓶颈
3. **多语言支持**：根据 `Accept-Language` 请求头返回不同语言的错误消息
4. **错误恢复建议**：为常见错误提供恢复建议（如"请稍后重试"、"请联系管理员"等）
5. **错误码文档**：为前端团队提供完整的错误码映射表

---

## 总结

本次重构实现了统一的全局异常处理机制，覆盖 FastAPI 和 Celery Worker 两个进程域。通过标准化的错误响应格式、Request ID 追踪和环境感知的调试信息控制，显著提升了系统的可维护性和生产安全性。

**关键成果**：
- ✅ 生产环境自动隐藏 Python 堆栈信息
- ✅ 统一 JSON 错误响应格式
- ✅ 捕获所有未处理异常
- ✅ 开发环境保留详细调试信息
- ✅ 现有代码零侵入，向后兼容

