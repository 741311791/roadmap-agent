# 数据库连接池耗尽修复 - 历史方案归档

**归档日期**: 2025-01-01  
**原方案**: 使用连接池配置和信号量限制解决连接耗尽  
**当前方案**: 已迁移到 Supabase Transaction Mode Pooling

> ⚠️ **注意**: 本文档已归档，仅供历史参考。当前项目已迁移到 Supabase 统一数据库。
> 
> 最新配置请参考: [`docs/20250101_Supabase数据库统一迁移.md`](./20250101_Supabase数据库统一迁移.md)

---

## 问题症状
```
asyncpg.exceptions.TooManyConnectionsError: sorry, too many clients already
```

## 根本原因（第一性原理分析）

**错误来自 PostgreSQL 数据库，不是 SQLAlchemy 连接池！**

```
进程数统计：
- FastAPI (uvicorn --workers 4): 4 个进程
- Celery logs (--concurrency=4 --pool=prefork): 5 个进程
- Celery content_generation (--concurrency=8 --pool=prefork): 9 个进程
- Celery workflow (--concurrency=2): 3 个进程
总计: 21 个进程

修复前：
每进程连接池 = 10 + 5 = 15
总连接需求 = 21 × 15 = 315
PostgreSQL max_connections = 100
315 > 100 → 连接耗尽 ❌
```

## 修复方案（已替代）

### 1. 降低每进程连接池大小（✅ 核心修复）
```python
# backend/app/config/settings.py
DB_POOL_SIZE = 2      # 从 10 降到 2
DB_MAX_OVERFLOW = 2   # 从 5 降到 2

# 修复后：21 × 4 = 84 < 100 ✅
```

### 2. 信号量限制 Celery 并发（✅ 已完成）
```python
# backend/app/tasks/content_generation_tasks.py
MAX_DB_CONCURRENT = 3  # 从 5 降到 3（适应更小的连接池）
```

### 3. 连接关闭保护（✅ 已完成）
```python
# backend/app/db/session.py
await asyncio.shield(session.close())  # 即使请求取消也归还连接
```

### 4. 连接分配策略（修复后）

| 组件 | 进程数 | 每进程连接 | 子进程连接 | 总连接需求 |
|------|--------|------------|------------|------------|
| FastAPI | 4 | 4 (2+2) | - | 16 |
| Celery logs | 1 主进程 + 4 子进程 | 1 × 4 + 4 × 4 | 16 | 20 |
| Celery content | 1 主进程 + 8 子进程 | 1 × 4 + 8 × 4 | 32 | 36 |
| Celery workflow | 1 主进程 + 2 子进程 | 1 × 4 + 2 × 4 | 8 | 12 |
| **总计** | **21** | - | - | **84** |

**安全边界**: 84 < 100 (PostgreSQL max_connections) ✅  
**预留空间**: 16 个连接（用于 psql、监控、LangGraph Checkpointer）

---

## 当前方案（2025-01-01）

项目已迁移到 **Supabase Transaction Mode Pooling**:
- 应用连接数: 21 × 15 = 315
- Supabase Pooler 映射到: ~50 真实连接
- 无连接耗尽风险

详细信息: [`docs/20250101_Supabase数据库统一迁移.md`](./20250101_Supabase数据库统一迁移.md)

---

## 历史监控工具（参考）

### 连接池状态检查
```bash
python scripts/check_pool_status.py
```

### PostgreSQL 连接数查询
```sql
SELECT count(*) FROM pg_stat_activity;
SELECT count(*) FROM pg_stat_activity WHERE application_name = 'roadmap_agent';
```

---

**归档原因**: 本地 PostgreSQL 方案已被 Supabase 统一架构替代，不再维护本地数据库服务。

