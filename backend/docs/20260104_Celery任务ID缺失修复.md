# Celery 任务 ID 缺失修复

**日期**：2026-01-04  
**严重程度**：高（Critical）  
**影响范围**：路线图生成任务无法正常执行

---

## 一、问题现象

用户报告生成路线图时报错：

```
Task Failed
Task 736dc742-4efb-4f9e-9a6d-d9d9646759f2 not found in database after 5 retries
```

数据库中存在该任务记录，但：
- `status` 停留在 `pending`
- `current_step` 停留在 `init`
- `celery_task_id` 字段为 **null**

---

## 二、根本原因分析

### 问题定位

在 `backend/app/api/v1/endpoints/generation.py` 的 `generate_roadmap_async()` 函数中：

```python
# 第 183-190 行：创建任务记录
async with repo_factory.create_session() as session:
    task_repo = repo_factory.create_task_repo(session)
    await task_repo.create_task(
        task_id=task_id,
        user_id=request.user_id,
        user_request=request.model_dump(mode='json'),
    )
    await session.commit()

# 第 193-198 行：分发 Celery 任务
celery_task = generate_roadmap.delay(
    task_id=task_id,
    user_request=request.preferences.learning_goal,
    user_id=request.user_id,
    learning_preferences=request.preferences.model_dump(mode='json'),
)

# ❌ 缺失步骤：没有将 celery_task.id 更新到数据库
```

### 执行流程缺陷

1. FastAPI 创建任务记录（`celery_task_id` 为 null）
2. FastAPI 分发 Celery 任务（获得 `celery_task.id`）
3. **❌ 未将 `celery_task.id` 回写到数据库**
4. Celery Worker 收到任务，验证任务记录存在
5. 后续流程可能因 `celery_task_id` 缺失而失败

---

## 三、修复方案

### 3.1 添加 TaskRepository 方法

在 `backend/app/db/repositories/task_repo.py` 中新增 `update_task_celery_id()` 方法：

```python
async def update_task_celery_id(
    self,
    task_id: str,
    celery_task_id: str,
) -> bool:
    """
    更新任务的 celery_task_id
    
    Args:
        task_id: 任务 ID
        celery_task_id: Celery 任务 ID
        
    Returns:
        True 如果更新成功，False 如果任务不存在
    """
    updated = await self.update_by_id(
        task_id,
        celery_task_id=celery_task_id,
        updated_at=beijing_now(),
    )
    
    if updated:
        logger.info(
            "task_celery_id_updated",
            task_id=task_id,
            celery_task_id=celery_task_id,
        )
    
    return updated
```

### 3.2 修改 API 端点

在 `backend/app/api/v1/endpoints/generation.py` 的 `generate_roadmap_async()` 中添加回写逻辑：

```python
# 分发 Celery 任务
celery_task = generate_roadmap.delay(
    task_id=task_id,
    user_request=request.preferences.learning_goal,
    user_id=request.user_id,
    learning_preferences=request.preferences.model_dump(mode='json'),
)

# ✅ 更新任务记录中的 celery_task_id
async with repo_factory.create_session() as session:
    task_repo = repo_factory.create_task_repo(session)
    await task_repo.update_task_celery_id(
        task_id=task_id,
        celery_task_id=celery_task.id,
    )
    await session.commit()

logger.info(
    "celery_task_dispatched",
    task_id=task_id,
    celery_task_id=celery_task.id,
)
```

---

## 四、修复效果

### 预期改进

1. **任务记录完整性**
   - `celery_task_id` 字段正确填充
   - 可通过 Celery API 查询任务状态

2. **任务追踪能力**
   - 支持通过 `celery_task_id` 取消任务
   - 支持查询 Celery 任务的详细执行状态

3. **调试便利性**
   - 日志中包含完整的任务关联信息
   - 可追踪 FastAPI → Celery → Worker 的完整链路

### 数据库字段对比

**修复前**：
```json
{
  "task_id": "736dc742-4efb-4f9e-9a6d-d9d9646759f2",
  "status": "pending",
  "current_step": "init",
  "celery_task_id": null  // ❌ 缺失
}
```

**修复后**：
```json
{
  "task_id": "736dc742-4efb-4f9e-9a6d-d9d9646759f2",
  "status": "processing",
  "current_step": "intent_analysis",
  "celery_task_id": "a43ee5e9-0c5b-4633-88f1-a269d8e2e996"  // ✅ 正确填充
}
```

---

## 五、测试验证

### 验证步骤

1. **重启服务**
   ```bash
   # 重启 FastAPI
   pkill -f uvicorn
   cd backend
   uv run uvicorn app.main:app --reload
   
   # 重启 Celery Worker
   pkill -f celery
   uv run celery -A app.core.celery_app worker \
     --queues=roadmap_workflow \
     --concurrency=6 \
     --loglevel=info
   ```

2. **创建新任务**
   ```bash
   curl -X POST http://localhost:8000/api/generation/generate \
     -H "Content-Type: application/json" \
     -d '{
       "user_id": "test-user",
       "preferences": {
         "learning_goal": "学习Python"
       }
     }'
   ```

3. **检查数据库**
   ```sql
   SELECT task_id, status, current_step, celery_task_id
   FROM roadmap_tasks
   ORDER BY created_at DESC
   LIMIT 1;
   ```

4. **预期结果**
   - `celery_task_id` 不为 null
   - Celery Worker 日志显示任务正常执行
   - 任务状态正常流转（pending → processing → ...）

---

## 六、关联文件

**修改文件**：
- `backend/app/api/v1/endpoints/generation.py` (API 层)
- `backend/app/db/repositories/task_repo.py` (数据访问层)

**相关代码**：
- `backend/app/tasks/roadmap_generation_tasks.py` (Celery 任务定义)
- `backend/app/models/database.py` (RoadmapTask 模型)

---

## 七、防范措施

### 代码审查要点

1. **异步任务分发后必须回写关联 ID**
   - Celery 任务 ID
   - 第三方服务的请求 ID

2. **数据库事务边界清晰**
   - 任务记录创建和更新使用独立事务
   - 避免长时间持有数据库连接

3. **日志记录完整性**
   - 记录任务创建和分发的完整过程
   - 包含所有关键 ID（task_id, celery_task_id）

### 未来改进建议

1. **原子性优化**
   - 考虑使用数据库触发器或应用层事务确保 `celery_task_id` 必填

2. **监控告警**
   - 添加监控检测 `celery_task_id` 为 null 的任务
   - 超过 5 秒未更新 `celery_task_id` 时触发告警

3. **重试机制**
   - 如果 `celery_task_id` 更新失败，应回滚任务创建或标记为失败

---

## 八、总结

本次修复解决了 Celery 任务 ID 缺失导致的任务无法正常执行问题。通过在任务分发后立即回写 `celery_task_id`，确保了任务追踪链路的完整性，提升了系统的可观测性和可维护性。

