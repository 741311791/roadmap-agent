# æ•™ç¨‹æ‰¹é‡ä¿å­˜ä¸»é”®å†²çªä¿®å¤

**æ—¥æœŸ**: 2025-12-31  
**ç±»å‹**: Bug ä¿®å¤  
**å½±å“èŒƒå›´**: åç«¯ - å†…å®¹ç”Ÿæˆä»»åŠ¡  
**ä¸¥é‡ç¨‹åº¦**: é«˜ï¼ˆå¯¼è‡´ä»»åŠ¡å¤±è´¥ï¼‰

---

## 1. é—®é¢˜æè¿°

### 1.1 é”™è¯¯ç°è±¡

Celery å†…å®¹ç”Ÿæˆä»»åŠ¡åœ¨æ‰¹é‡ä¿å­˜æ•™ç¨‹å…ƒæ•°æ®æ—¶ï¼ŒæŠ›å‡ºæ•°æ®åº“å”¯ä¸€çº¦æŸå†²çªé”™è¯¯ï¼š

```
sqlalchemy.exc.IntegrityError: duplicate key value violates unique constraint "tutorial_metadata_pkey"
DETAIL: Key (tutorial_id)=(e809402b-e937-4bee-b907-e5e06822659d) already exists.
```

### 1.2 é”™è¯¯å †æ ˆ

```python
File "app/tasks/content_generation_tasks.py", line 435, in _save_content_results
    await repo.save_tutorials_batch(batch, roadmap_id)
File "app/db/repositories/roadmap_repo.py", line 1009, in save_tutorials_batch
    await self.session.flush()
```

### 1.3 è§¦å‘åœºæ™¯

- **ä»»åŠ¡é‡è¯•**ï¼šå½“ä»»åŠ¡å¤±è´¥åé‡è¯•æ—¶ï¼Œéƒ¨åˆ† tutorial å¯èƒ½å·²ç»ä¿å­˜æˆåŠŸ
- **å¹¶å‘ç”Ÿæˆ**ï¼šå¤šä¸ªä»»åŠ¡åŒæ—¶ä¸ºç›¸åŒçš„ concept ç”Ÿæˆå†…å®¹
- **éƒ¨åˆ†æˆåŠŸ**ï¼šæ‰¹é‡æ“ä½œä¸­éƒ¨åˆ†è®°å½•å·²æˆåŠŸæ’å…¥ï¼Œä½†æ•´ä½“äº‹åŠ¡æœªæäº¤

---

## 2. ç¬¬ä¸€æ€§åŸç†åˆ†æ

### 2.1 é—®é¢˜çš„æœ¬è´¨

ä»ç¬¬ä¸€æ€§åŸç†æ€è€ƒï¼š

1. **tutorial_id ç”Ÿæˆæœºåˆ¶**
   - ä½¿ç”¨ `uuid.uuid4()` ç”Ÿæˆï¼Œç†è®ºä¸Šå…¨å±€å”¯ä¸€
   - ä»£ç ä½ç½®ï¼š`backend/app/agents/tutorial_generator.py:385`

2. **ä¸ºä»€ä¹ˆä¼šé‡å¤ï¼Ÿ**
   - UUID æœ¬èº«ä¸ä¼šé‡å¤
   - é‡å¤è¯´æ˜**ç›¸åŒçš„ tutorial_id è¢«å°è¯•æ’å…¥ä¸¤æ¬¡**
   - æ ¹æœ¬åŸå› ï¼šä¹‹å‰çš„æ“ä½œå·²ç»æˆåŠŸæ’å…¥ï¼Œä½†å½“å‰æ“ä½œä¸çŸ¥é“

3. **åŸæœ‰é€»è¾‘çš„ç¼ºé™·**
```python
# åŸæœ‰å®ç°ï¼ˆæœ‰é—®é¢˜ï¼‰
new_records = [TutorialMetadata(...) for tutorial in tutorial_refs.values()]
self.session.add_all(new_records)  # âŒ ç›´æ¥æ’å…¥ï¼Œä¸æ£€æŸ¥æ˜¯å¦å­˜åœ¨
await self.session.flush()  # ğŸ’¥ ä¸»é”®å†²çªï¼
```

4. **ä¸ºä»€ä¹ˆéœ€è¦å¤„ç†é‡å¤ï¼Ÿ**
   - **ä»»åŠ¡é‡è¯•æ˜¯å¸¸æ€**ï¼šç½‘ç»œæ³¢åŠ¨ã€è¶…æ—¶ã€ä¸´æ—¶é”™è¯¯éƒ½ä¼šè§¦å‘é‡è¯•
   - **å¹‚ç­‰æ€§åŸåˆ™**ï¼šåŒä¸€ä¸ªæ“ä½œæ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœåº”è¯¥ä¸€è‡´
   - **æ•°æ®ä¸€è‡´æ€§**ï¼šä¸åº”å› ä¸ºé‡è¯•è€Œå¯¼è‡´ä»»åŠ¡å¤±è´¥

### 2.2 è§£å†³æ–¹æ¡ˆçš„è®¾è®¡åŸåˆ™

1. **å¹‚ç­‰æ€§ï¼ˆIdempotencyï¼‰**
   - åŒä¸€ä¸ª tutorial_id å¤šæ¬¡ä¿å­˜ï¼Œç»“æœåº”è¯¥ä¸€è‡´
   - ä¸åº”å› ä¸º"è®°å½•å·²å­˜åœ¨"è€ŒæŠ¥é”™

2. **åŸå­æ€§ï¼ˆAtomicityï¼‰**
   - ä½¿ç”¨æ•°æ®åº“åŸç”Ÿçš„ UPSERT æ“ä½œï¼Œé¿å…ç«æ€æ¡ä»¶
   - å•æ¡ SQL è¯­å¥å®Œæˆ"æ£€æŸ¥-æ’å…¥/æ›´æ–°"é€»è¾‘

3. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰¹é‡æ“ä½œï¼Œé¿å… N æ¬¡æ•°æ®åº“å¾€è¿”
   - å•æ¡ SQL å®Œæˆæ‰¹é‡ UPSERT

---

## 3. è§£å†³æ–¹æ¡ˆ

### 3.1 æ ¸å¿ƒæ”¹åŠ¨

ä½¿ç”¨ PostgreSQL çš„ `INSERT ... ON CONFLICT DO UPDATE` (UPSERT) æœºåˆ¶ï¼š

```python
from sqlalchemy.dialects.postgresql import insert

# æ„å»ºå€¼åˆ—è¡¨
values_list = [
    {
        "tutorial_id": tutorial.tutorial_id,
        "concept_id": tutorial.concept_id,
        # ... å…¶ä»–å­—æ®µ
    }
    for tutorial in tutorial_refs.values()
]

# PostgreSQL UPSERT
stmt = insert(TutorialMetadata).values(values_list)
stmt = stmt.on_conflict_do_update(
    index_elements=["tutorial_id"],  # ä¸»é”®å†²çªæ—¶
    set_={
        "concept_id": stmt.excluded.concept_id,
        "title": stmt.excluded.title,
        # ... æ›´æ–°æ‰€æœ‰å­—æ®µ
    }
)

await self.session.execute(stmt)
```

### 3.2 å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ ‡è®°æ—§ç‰ˆæœ¬ä¸ºéæœ€æ–°          â”‚
â”‚ UPDATE tutorial_metadata            â”‚
â”‚ SET is_latest = False               â”‚
â”‚ WHERE concept_id IN (...)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: UPSERT æ–°ç‰ˆæœ¬               â”‚
â”‚ INSERT ... ON CONFLICT DO UPDATE    â”‚
â”‚ - å¦‚æœ tutorial_id ä¸å­˜åœ¨ â†’ æ’å…¥   â”‚
â”‚ - å¦‚æœ tutorial_id å·²å­˜åœ¨ â†’ æ›´æ–°   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: æŸ¥è¯¢åˆšä¿å­˜çš„è®°å½•            â”‚
â”‚ SELECT * FROM tutorial_metadata     â”‚
â”‚ WHERE concept_id IN (...) AND       â”‚
â”‚       is_latest = True              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æŠ€æœ¯ç»†èŠ‚

#### UPSERT è¯­ä¹‰

```sql
INSERT INTO tutorial_metadata (tutorial_id, concept_id, ...)
VALUES ('uuid-1', 'c-1', ...), ('uuid-2', 'c-2', ...)
ON CONFLICT (tutorial_id) DO UPDATE SET
    concept_id = EXCLUDED.concept_id,
    title = EXCLUDED.title,
    ...;
```

- **EXCLUDED**ï¼šä»£è¡¨å†²çªæ—¶çš„æ–°å€¼
- **ON CONFLICT (tutorial_id)**ï¼šæŒ‡å®šå†²çªæ£€æµ‹å­—æ®µï¼ˆä¸»é”®ï¼‰
- **DO UPDATE SET**ï¼šå†²çªæ—¶æ‰§è¡Œçš„æ›´æ–°æ“ä½œ

#### SQLAlchemy å®ç°

```python
from sqlalchemy.dialects.postgresql import insert

stmt = insert(TutorialMetadata).values(values_list)
stmt = stmt.on_conflict_do_update(
    index_elements=["tutorial_id"],
    set_={field: stmt.excluded[field] for field in fields}
)
```

---

## 4. ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 4.1 ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | è¡Œæ•°å˜åŒ– |
|---------|---------|---------|
| `backend/app/db/repositories/roadmap_repo.py` | é‡å†™ `save_tutorials_batch` æ–¹æ³• | ~60 è¡Œ |

### 4.2 å…³é”®ä»£ç ä½ç½®

```python
# backend/app/db/repositories/roadmap_repo.py

async def save_tutorials_batch(
    self,
    tutorial_refs: Dict[str, TutorialGenerationOutput],
    roadmap_id: str,
) -> list[TutorialMetadata]:
    """
    æ‰¹é‡ä¿å­˜æ•™ç¨‹å…ƒæ•°æ®ï¼ˆä½¿ç”¨ UPSERT é¿å…ä¸»é”®å†²çªï¼‰
    
    âœ… æ”¯æŒä»»åŠ¡é‡è¯•ï¼ˆå¹‚ç­‰æ€§ï¼‰
    âœ… æ”¯æŒå¹¶å‘åœºæ™¯
    âœ… é¿å…ä¸»é”®å†²çªé”™è¯¯
    """
    # ... å®ç°ä»£ç 
```

---

## 5. æµ‹è¯•éªŒè¯

### 5.1 æµ‹è¯•åœºæ™¯

#### åœºæ™¯ 1ï¼šæ­£å¸¸æ’å…¥ï¼ˆé¦–æ¬¡ç”Ÿæˆï¼‰

```python
# ç»™å®šï¼šæ•°æ®åº“ä¸­æ²¡æœ‰è¯¥ tutorial
tutorial_refs = {"c-1": TutorialGenerationOutput(tutorial_id="uuid-1", ...)}

# å½“ï¼šæ‰§è¡Œ save_tutorials_batch
result = await repo.save_tutorials_batch(tutorial_refs, roadmap_id)

# åˆ™ï¼šæˆåŠŸæ’å…¥æ–°è®°å½•
assert len(result) == 1
assert result[0].tutorial_id == "uuid-1"
```

#### åœºæ™¯ 2ï¼šé‡å¤æ’å…¥ï¼ˆä»»åŠ¡é‡è¯•ï¼‰

```python
# ç»™å®šï¼šæ•°æ®åº“ä¸­å·²å­˜åœ¨è¯¥ tutorial
tutorial_refs = {"c-1": TutorialGenerationOutput(tutorial_id="uuid-1", ...)}
await repo.save_tutorials_batch(tutorial_refs, roadmap_id)  # ç¬¬ä¸€æ¬¡

# å½“ï¼šå†æ¬¡æ‰§è¡Œï¼ˆæ¨¡æ‹Ÿä»»åŠ¡é‡è¯•ï¼‰
result = await repo.save_tutorials_batch(tutorial_refs, roadmap_id)  # ç¬¬äºŒæ¬¡

# åˆ™ï¼šä¸ä¼šæŠ¥é”™ï¼ŒæˆåŠŸæ›´æ–°è®°å½•
assert len(result) == 1
assert result[0].tutorial_id == "uuid-1"
```

#### åœºæ™¯ 3ï¼šå¹¶å‘æ’å…¥

```python
# ç»™å®šï¼šä¸¤ä¸ªä»»åŠ¡åŒæ—¶ä¸ºåŒä¸€ concept ç”Ÿæˆ tutorial
tutorial_refs_1 = {"c-1": TutorialGenerationOutput(tutorial_id="uuid-1", ...)}
tutorial_refs_2 = {"c-1": TutorialGenerationOutput(tutorial_id="uuid-1", ...)}

# å½“ï¼šå¹¶å‘æ‰§è¡Œ
await asyncio.gather(
    repo.save_tutorials_batch(tutorial_refs_1, roadmap_id),
    repo.save_tutorials_batch(tutorial_refs_2, roadmap_id),
)

# åˆ™ï¼šä¸ä¼šæŠ¥é”™ï¼Œæœ€ç»ˆä¿å­˜ä¸€æ¡è®°å½•
result = await repo.get_tutorials_by_roadmap(roadmap_id)
assert len(result) == 1
```

### 5.2 éªŒè¯æ­¥éª¤

1. **é‡å¯ Celery Worker**
```bash
# åœæ­¢æ—§çš„ worker
pkill -f "celery.*worker"

# å¯åŠ¨æ–°çš„ worker
cd backend
celery -A app.core.celery_app worker --loglevel=info --pool=solo
```

2. **è§¦å‘å†…å®¹ç”Ÿæˆä»»åŠ¡**
```bash
# åˆ›å»ºæ–°çš„è·¯çº¿å›¾
curl -X POST http://localhost:8000/api/v1/roadmaps/streaming \
  -H "Content-Type: application/json" \
  -d '{"user_goal": "å­¦ä¹  React æ¡†æ¶", ...}'
```

3. **è§‚å¯Ÿæ—¥å¿—**
```bash
# åº”è¯¥çœ‹åˆ°æˆåŠŸæ—¥å¿—ï¼Œè€Œä¸æ˜¯ IntegrityError
[INFO] tutorials_metadata_saved_batch_upsert roadmap_id=xxx count=10
```

---

## 6. å½±å“åˆ†æ

### 6.1 æ­£é¢å½±å“

1. **æé«˜ç³»ç»Ÿç¨³å®šæ€§**
   - âœ… ä»»åŠ¡é‡è¯•ä¸å†å¤±è´¥
   - âœ… å¹¶å‘åœºæ™¯æ­£å¸¸å·¥ä½œ
   - âœ… å‡å°‘ç”¨æˆ·çœ‹åˆ°çš„é”™è¯¯

2. **ä¿æŒæ€§èƒ½ä¼˜åŒ–**
   - âœ… ä¾ç„¶æ˜¯æ‰¹é‡æ“ä½œï¼ˆå•æ¡ SQLï¼‰
   - âœ… æ—¶é—´å¤æ‚åº¦ä¸å˜ï¼šO(N)
   - âœ… æ•°æ®åº“å¾€è¿”æ¬¡æ•°ä¸å˜ï¼š2 æ¬¡

3. **æå‡ä»£ç è´¨é‡**
   - âœ… éµå¾ªå¹‚ç­‰æ€§åŸåˆ™
   - âœ… æ›´ç¬¦åˆåˆ†å¸ƒå¼ç³»ç»Ÿæœ€ä½³å®è·µ
   - âœ… ä»£ç æ›´å¥å£®

### 6.2 æ½œåœ¨é£é™©

1. **æ•°æ®åº“å…¼å®¹æ€§**
   - âš ï¸ ä¾èµ– PostgreSQL çš„ `ON CONFLICT` è¯­æ³•
   - âœ… å½“å‰é¡¹ç›®ä½¿ç”¨ PostgreSQLï¼Œæ— å½±å“

2. **è¡Œä¸ºå˜åŒ–**
   - âš ï¸ ä»"æ’å…¥å¤±è´¥"å˜ä¸º"é™é»˜æ›´æ–°"
   - âœ… ç¬¦åˆé¢„æœŸï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„å¹‚ç­‰æ€§

### 6.3 æ€§èƒ½å½±å“

- **CPU**ï¼šæ— æ˜¾è‘—å˜åŒ–
- **å†…å­˜**ï¼šæ— æ˜¾è‘—å˜åŒ–
- **æ•°æ®åº“**ï¼š
  - å†™æ“ä½œï¼šç›¸åŒï¼ˆæ‰¹é‡ UPSERT vs æ‰¹é‡ INSERTï¼‰
  - è¯»æ“ä½œï¼šå¢åŠ  1 æ¬¡ï¼ˆæŸ¥è¯¢ä¿å­˜çš„è®°å½•ï¼‰
  - æ€»ä½“å½±å“ï¼šå¯å¿½ç•¥

---

## 7. ç›¸å…³é—®é¢˜

### 7.1 å…¶ä»–æ‰¹é‡ä¿å­˜æ–¹æ³•

å½“å‰ç³»ç»Ÿè¿˜æœ‰ä»¥ä¸‹æ‰¹é‡ä¿å­˜æ–¹æ³•ï¼Œéœ€è¦è¯„ä¼°æ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜ï¼š

| æ–¹æ³• | ä¸»é”®ç”Ÿæˆæ–¹å¼ | å½“å‰ç­–ç•¥ | æ˜¯å¦éœ€è¦ä¿®å¤ |
|-----|------------|---------|------------|
| `save_resources_batch` | UUID | å…ˆåˆ é™¤åæ’å…¥ | âš ï¸ ä½ä¼˜å…ˆçº§ |
| `save_quizzes_batch` | UUID | å…ˆåˆ é™¤åæ’å…¥ | âš ï¸ ä½ä¼˜å…ˆçº§ |

**è¯„ä¼°ç»“è®º**ï¼š
- **Resources & Quizzes**ï¼šä½¿ç”¨"å…ˆåˆ é™¤åæ’å…¥"ç­–ç•¥
  - âœ… ä¸ä¼šæœ‰ä¸»é”®å†²çª
  - âš ï¸ ä½†åœ¨å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½è¯¯åˆ å…¶ä»–ä»»åŠ¡çš„è®°å½•
  - ğŸ’¡ å»ºè®®ï¼šå¦‚æœæœªæ¥å‡ºç°é—®é¢˜ï¼Œä¹Ÿæ”¹ä¸º UPSERT

### 7.2 æ•°æ®è¿ç§»

**æ˜¯å¦éœ€è¦æ•°æ®è¿ç§»ï¼Ÿ**  
âŒ ä¸éœ€è¦

**åŸå› **ï¼š
- åªä¿®æ”¹äº†åº”ç”¨å±‚é€»è¾‘
- æ•°æ®åº“ schema æ²¡æœ‰å˜åŒ–
- å¯¹å·²æœ‰æ•°æ®æ— å½±å“

---

## 8. æœ€ä½³å®è·µæ€»ç»“

### 8.1 åˆ†å¸ƒå¼ç³»ç»ŸåŸåˆ™

1. **å¹‚ç­‰æ€§ï¼ˆIdempotencyï¼‰**
   - æ‰€æœ‰å†™æ“ä½œåº”è¯¥æ˜¯å¹‚ç­‰çš„
   - ä½¿ç”¨ UPSERT è€Œä¸æ˜¯ INSERT
   - ä½¿ç”¨å”¯ä¸€é”®è€Œä¸æ˜¯è‡ªå¢ ID

2. **é‡è¯•å®‰å…¨ï¼ˆRetry-Safeï¼‰**
   - å‡è®¾ä»»ä½•æ“ä½œéƒ½å¯èƒ½é‡è¯•
   - ä»£ç åº”è¯¥èƒ½å¤„ç†"éƒ¨åˆ†æˆåŠŸ"åœºæ™¯
   - ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§

3. **å¹¶å‘å®‰å…¨ï¼ˆConcurrent-Safeï¼‰**
   - ä½¿ç”¨æ•°æ®åº“çº¦æŸè€Œä¸æ˜¯åº”ç”¨å±‚æ£€æŸ¥
   - ä½¿ç”¨ä¹è§‚é”æˆ–æ‚²è§‚é”
   - é¿å… "Check-Then-Act" åæ¨¡å¼

### 8.2 æ•°æ®åº“æ“ä½œå»ºè®®

```python
# âŒ åæ¨¡å¼ï¼šCheck-Then-Actï¼ˆæœ‰ç«æ€æ¡ä»¶ï¼‰
existing = await repo.get_by_id(id)
if existing:
    await repo.update(id, data)
else:
    await repo.create(data)

# âœ… æœ€ä½³å®è·µï¼šUPSERTï¼ˆåŸå­æ“ä½œï¼‰
stmt = insert(Model).values(data)
stmt = stmt.on_conflict_do_update(...)
await session.execute(stmt)
```

### 8.3 é”™è¯¯å¤„ç†å»ºè®®

```python
# âŒ æ•è·å¹¶å¿½ç•¥å”¯ä¸€çº¦æŸé”™è¯¯ï¼ˆæ©ç›–é—®é¢˜ï¼‰
try:
    await repo.create(data)
except IntegrityError:
    pass  # é™é»˜å¿½ç•¥

# âœ… ä½¿ç”¨æ­£ç¡®çš„è¯­ä¹‰ï¼ˆé¿å…é”™è¯¯å‘ç”Ÿï¼‰
await repo.upsert(data)  # ä¸ä¼šæŠ›å‡º IntegrityError
```

---

## 9. å‚è€ƒèµ„æ–™

### 9.1 PostgreSQL æ–‡æ¡£

- [INSERT ... ON CONFLICT](https://www.postgresql.org/docs/current/sql-insert.html#SQL-ON-CONFLICT)
- [Upsert (MERGE)](https://www.postgresql.org/docs/current/sql-merge.html)

### 9.2 SQLAlchemy æ–‡æ¡£

- [PostgreSQL INSERT ... ON CONFLICT](https://docs.sqlalchemy.org/en/20/dialects/postgresql.html#insert-on-conflict-upsert)

### 9.3 ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“ä¼˜åŒ–å®æ–½æ€»ç»“](./20251231_æ•°æ®åº“ä¼˜åŒ–å®æ–½æ€»ç»“.md)
- [å¹¶å‘æ§åˆ¶æœºåˆ¶åˆ†æ](./20251231_å¹¶å‘æ§åˆ¶æœºåˆ¶åˆ†æ.md)

---

## 10. åç»­è®¡åˆ’

### 10.1 çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰

- [x] ä¿®å¤ `save_tutorials_batch` çš„ä¸»é”®å†²çªé—®é¢˜
- [ ] æµ‹è¯•ä»»åŠ¡é‡è¯•åœºæ™¯
- [ ] ç›‘æ§ç”Ÿäº§ç¯å¢ƒé”™è¯¯ç‡

### 10.2 ä¸­æœŸï¼ˆä¸‹å‘¨ï¼‰

- [ ] è¯„ä¼° `save_resources_batch` å’Œ `save_quizzes_batch` çš„å¹¶å‘å®‰å…¨æ€§
- [ ] å¦‚æœ‰å¿…è¦ï¼Œç»Ÿä¸€æ”¹ä¸º UPSERT ç­–ç•¥
- [ ] æ·»åŠ å¹¶å‘æµ‹è¯•ç”¨ä¾‹

### 10.3 é•¿æœŸï¼ˆä¸‹æœˆï¼‰

- [ ] å»ºç«‹æ•°æ®åº“æ“ä½œæœ€ä½³å®è·µæ–‡æ¡£
- [ ] Code Review æ£€æŸ¥æ¸…å•ä¸­åŠ å…¥"å¹‚ç­‰æ€§æ£€æŸ¥"
- [ ] ç›‘æ§ç³»ç»Ÿæ·»åŠ "é‡è¯•æ¬¡æ•°"æŒ‡æ ‡

---

## é™„å½•

### A. å®Œæ•´ä»£ç å¯¹æ¯”

#### ä¿®æ”¹å‰

```python
async def save_tutorials_batch(self, tutorial_refs, roadmap_id):
    # Step 1: æ ‡è®°æ—§ç‰ˆæœ¬
    await self.session.execute(
        update(TutorialMetadata)
        .where(...)
        .values(is_latest=False)
    )
    
    # Step 2: æ‰¹é‡æ’å…¥ï¼ˆâŒ å¯èƒ½å†²çªï¼‰
    new_records = [TutorialMetadata(...) for tutorial in tutorial_refs.values()]
    self.session.add_all(new_records)
    await self.session.flush()  # ğŸ’¥ IntegrityError!
    
    return new_records
```

#### ä¿®æ”¹å

```python
async def save_tutorials_batch(self, tutorial_refs, roadmap_id):
    # Step 1: æ ‡è®°æ—§ç‰ˆæœ¬
    await self.session.execute(
        update(TutorialMetadata)
        .where(...)
        .values(is_latest=False)
    )
    
    # Step 2: UPSERTï¼ˆâœ… é¿å…å†²çªï¼‰
    from sqlalchemy.dialects.postgresql import insert
    
    values_list = [{...} for tutorial in tutorial_refs.values()]
    stmt = insert(TutorialMetadata).values(values_list)
    stmt = stmt.on_conflict_do_update(
        index_elements=["tutorial_id"],
        set_={...}
    )
    await self.session.execute(stmt)
    
    # Step 3: æŸ¥è¯¢ä¿å­˜çš„è®°å½•
    result = await self.session.execute(
        select(TutorialMetadata).where(...)
    )
    return list(result.scalars().all())
```

### B. æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

```python
# tests/integration/test_tutorial_batch_upsert.py

import pytest
from app.db.repositories.roadmap_repo import RoadmapRepository
from app.models.domain import TutorialGenerationOutput

@pytest.mark.asyncio
async def test_save_tutorials_batch_idempotent(db_session):
    """æµ‹è¯•æ‰¹é‡ä¿å­˜æ•™ç¨‹çš„å¹‚ç­‰æ€§"""
    repo = RoadmapRepository(db_session)
    roadmap_id = "test-roadmap-1"
    
    tutorial_refs = {
        "c-1": TutorialGenerationOutput(
            tutorial_id="uuid-1",
            concept_id="c-1",
            title="Test Tutorial",
            # ... å…¶ä»–å­—æ®µ
        )
    }
    
    # ç¬¬ä¸€æ¬¡ä¿å­˜
    result1 = await repo.save_tutorials_batch(tutorial_refs, roadmap_id)
    assert len(result1) == 1
    
    # ç¬¬äºŒæ¬¡ä¿å­˜ï¼ˆæ¨¡æ‹Ÿé‡è¯•ï¼‰
    result2 = await repo.save_tutorials_batch(tutorial_refs, roadmap_id)
    assert len(result2) == 1
    assert result2[0].tutorial_id == result1[0].tutorial_id
    
    # éªŒè¯æ•°æ®åº“ä¸­åªæœ‰ä¸€æ¡è®°å½•
    all_tutorials = await repo.get_tutorials_by_roadmap(roadmap_id)
    assert len(all_tutorials) == 1
```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-31  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡ Linter æ£€æŸ¥  
**éƒ¨ç½²çŠ¶æ€**: â³ å¾…éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

