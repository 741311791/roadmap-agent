# 前后端步骤枚举同步修复

## 问题描述

用户反馈任务详情页的当前阶段从 `queued` 直接跳到 `curriculum_design`，跳过了 `intent_analysis` 阶段。

## 根本原因分析

### 1. 前后端步骤定义不一致

前端 `workflow-topology.tsx` 中定义的步骤与后端 `WorkflowStep` 枚举存在以下差异：

| 位置 | 前端定义 | 后端定义 | 状态 |
|------|---------|---------|------|
| Design | `framework_generation` | 不存在 | ❌ 已删除 |
| Review | `human_review_pending` | 不存在（是任务状态，不是步骤） | ❌ 已删除 |
| Edit | `edit_plan`, `validation_edit_plan` | `edit_plan_analysis`, `validation_edit_plan_analysis` | ❌ 已修正 |

### 2. 步骤映射分散在多处

前端的步骤映射分散在多个文件中，导致修改时容易遗漏：
- `workflow-topology.tsx`: MAIN_STAGES, VALIDATION_BRANCH, REVIEW_BRANCH
- `core-display-area.tsx`: shouldShowIntentCard, shouldShowRoadmap
- `execution-log-timeline.tsx`: STEP_CONFIG

### 3. 执行速度问题（次要原因）

`intent_analysis` 阶段可能执行得太快，导致前端来不及渲染这个状态。但这不是根本原因，只要状态同步正确，即使执行快也能正确显示。

## 解决方案

### 1. 修复前端步骤映射

**`workflow-topology.tsx`**:
- 移除不存在的 `framework_generation` 步骤
- 移除 `human_review_pending`（这是任务状态，不是工作流步骤）

**`core-display-area.tsx`**:
- 更新 `shouldShowIntentCard` 使用统一的常量函数
- 更新 `shouldShowRoadmap` 使用统一的常量函数
- 更新 `getWaitingStatusText` 使用统一的常量函数

**`execution-log-timeline.tsx`**:
- 移除不存在的 `framework_generation` 和 `human_review_pending`

### 2. 创建统一的常量文件

新增 `lib/constants/workflow-steps.ts`，作为前端步骤定义的单一真相来源：

```typescript
export const WorkflowStep = {
  INIT: 'init',
  QUEUED: 'queued',
  STARTING: 'starting',
  INTENT_ANALYSIS: 'intent_analysis',
  CURRICULUM_DESIGN: 'curriculum_design',
  STRUCTURE_VALIDATION: 'structure_validation',
  VALIDATION_EDIT_PLAN_ANALYSIS: 'validation_edit_plan_analysis',
  EDIT_PLAN_ANALYSIS: 'edit_plan_analysis',
  ROADMAP_EDIT: 'roadmap_edit',
  HUMAN_REVIEW: 'human_review',
  CONTENT_GENERATION_QUEUED: 'content_generation_queued',
  CONTENT_GENERATION: 'content_generation',
  TUTORIAL_GENERATION: 'tutorial_generation',
  RESOURCE_RECOMMENDATION: 'resource_recommendation',
  QUIZ_GENERATION: 'quiz_generation',
  FINALIZING: 'finalizing',
  COMPLETED: 'completed',
  FAILED: 'failed',
} as const;
```

同时提供了辅助函数：
- `isAfterIntentAnalysis(step)`: 判断是否在 intent_analysis 完成后
- `isAfterCurriculumDesign(step)`: 判断是否在 curriculum_design 完成后
- `getStepLabel(step)`: 获取步骤的显示标签
- `getStepDescription(step)`: 获取步骤的显示描述

### 3. 后端 WorkflowStep 枚举参考

```python
# backend/app/models/constants.py
class WorkflowStep(str, Enum):
    INIT = "init"
    QUEUED = "queued"
    STARTING = "starting"
    INTENT_ANALYSIS = "intent_analysis"
    CURRICULUM_DESIGN = "curriculum_design"
    STRUCTURE_VALIDATION = "structure_validation"
    VALIDATION_EDIT_PLAN_ANALYSIS = "validation_edit_plan_analysis"
    EDIT_PLAN_ANALYSIS = "edit_plan_analysis"
    ROADMAP_EDIT = "roadmap_edit"
    HUMAN_REVIEW = "human_review"
    CONTENT_GENERATION_QUEUED = "content_generation_queued"
    CONTENT_GENERATION = "content_generation"
    TUTORIAL_GENERATION = "tutorial_generation"
    RESOURCE_RECOMMENDATION = "resource_recommendation"
    QUIZ_GENERATION = "quiz_generation"
    FINALIZING = "finalizing"
    COMPLETED = "completed"
    FAILED = "failed"
```

## 修改的文件

1. `frontend-next/lib/constants/workflow-steps.ts` - **新增**
2. `frontend-next/components/task/workflow-topology.tsx` - 修复步骤映射
3. `frontend-next/components/task/core-display-area.tsx` - 使用统一常量
4. `frontend-next/components/task/execution-log-timeline.tsx` - 修复步骤映射

## 测试建议

1. 创建新任务，观察工作流拓扑图的节点状态变化
2. 确认 `intent_analysis` 阶段能正确显示
3. 确认所有步骤的显示文本正确
4. 确认验证分支和审核分支能正确触发和显示

## 后续优化建议

1. 考虑使用 TypeScript 的类型生成工具，从后端 Python 枚举自动生成前端 TypeScript 类型
2. 添加单元测试确保前后端枚举值保持同步
3. 在 CI/CD 中添加检查，防止枚举不一致

