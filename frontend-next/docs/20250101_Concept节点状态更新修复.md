# Concept 节点状态更新修复

## 问题描述

**问题现象：**
任务详情页面中，当 Concept 内容生成完成后，拓扑图中的节点状态没有及时更新为成功样式，仍然显示为加载中或待处理状态。

**根本原因：**
在 WebSocket 收到 `concept_complete` 事件后，虽然调用了 `loadRoadmapFramework()` 来刷新数据，但由于后端数据库可能存在写入延迟，前端获取到的 roadmap 数据中的 concept 状态可能仍然是 `generating`，导致节点样式无法正确更新。

## 解决方案

### 核心修改

在 `frontend-next/app/(app)/tasks/[taskId]/page.tsx` 中的 `handleConceptComplete` 函数添加了**乐观更新（Optimistic Update）**逻辑：

```typescript
const handleConceptComplete = async (event: any) => {
  // ... 日志记录 ...
  
  // ✅ 立即更新本地状态，避免等待后端数据库更新
  setRoadmapFramework(prevRoadmap => {
    if (!prevRoadmap) return prevRoadmap;
    
    const updatedRoadmap = { ...prevRoadmap };
    // 查找并更新对应的 concept
    for (const stage of updatedRoadmap.stages) {
      for (const module of stage.modules) {
        const concept = module.concepts.find(c => c.concept_id === event.concept_id);
        if (concept) {
          // 将所有状态设置为 completed
          concept.content_status = 'completed';
          concept.resources_status = 'completed';
          concept.quiz_status = 'completed';
          return updatedRoadmap;
        }
      }
    }
    return prevRoadmap;
  });
  
  // 后台刷新数据以验证状态（作为兜底）
  await loadRoadmapFramework(currentRoadmapId);
};
```

### 工作原理

1. **乐观更新（Optimistic Update）**：
   - 收到 `concept_complete` 事件时，立即在本地 state 中更新 concept 的所有状态为 `completed`
   - 不等待后端数据库更新完成
   - 实现即时 UI 响应

2. **后台验证（Background Sync）**：
   - 随后仍然调用 `loadRoadmapFramework()` 从后端获取最新数据
   - 作为数据一致性的保障机制
   - 如果本地状态与后端不一致，后端数据会覆盖本地状态

3. **状态计算流程**：
   ```
   WebSocket Event (concept_complete)
   → 立即更新本地 roadmapFramework state
   → React 重新渲染
   → useTreeLayout 重新计算节点状态
   → getConceptNodeStatus() 检查 concept 的 status 字段
   → 返回 'completed' 状态
   → 节点显示为成功样式 ✅
   ```

## 技术细节

### 状态优先级

在 `getConceptNodeStatus()` 函数中，状态检查优先级为：

1. **修改状态** (`modifiedIds`)
2. **加载状态** (`loadingIds`)
3. **失败状态** (`failedIds`)
4. **部分失败** (`partialFailedIds`)
5. **内容状态** (`content_status`, `resources_status`, `quiz_status`) ← 修复作用点
6. **默认待处理** (`pending`)

### 相关组件数据流

```
TaskDetailPage (page.tsx)
  ├─ WebSocket 事件处理
  │   └─ handleConceptComplete
  │       ├─ setLoadingConceptIds (移除)
  │       ├─ setRoadmapFramework (乐观更新) ✅ NEW
  │       └─ loadRoadmapFramework (后台验证)
  │
  ├─ CoreDisplayArea
  │   ├─ loadingConceptIds prop
  │   └─ RoadmapTree
  │       ├─ useTreeLayout
  │       │   └─ conceptToNode
  │       │       └─ getConceptNodeStatus ← 这里判断状态
  │       └─ TreeNode (显示节点样式)
```

## 影响范围

### 修改文件
- `frontend-next/app/(app)/tasks/[taskId]/page.tsx`

### 影响功能
- ✅ 任务详情页面的 Concept 节点状态更新
- ✅ 拓扑图实时刷新
- ✅ WebSocket 事件处理

### 未影响的相关功能
- `RetryContentButton`：已经在使用 roadmap store 的 `updateConceptStatus()`，无需修改
- `LearningStage`：使用独立的进度追踪机制，无需修改

## 测试验证

**验证步骤：**
1. 创建新任务并等待进入 Content Generation 阶段
2. 观察拓扑图中 Concept 节点的状态变化
3. 确认节点在生成完成时立即变为绿色成功样式
4. 检查浏览器控制台是否有相关日志输出

**预期结果：**
- Concept 生成完成后，节点应在 1 秒内更新为成功样式（绿色边框 + ✓ 图标）
- 不再有延迟或状态不同步的情况
- 控制台输出 `[TaskDetail] Updated concept status to completed: {概念名称}`

## 注意事项

1. **乐观更新的局限性**：
   - 假设后端处理成功，不处理更新失败的情况
   - 后台刷新会自动纠正不一致的状态

2. **状态管理的一致性**：
   - 任务详情页面使用本地 state 管理 roadmap
   - 其他页面（如路线图详情页）使用 roadmap store
   - 两者独立，不会相互影响

3. **性能考虑**：
   - 乐观更新避免了等待网络请求的延迟
   - 提升了用户体验的流畅度

