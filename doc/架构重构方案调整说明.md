# 架构重构方案调整说明

> **日期**: 2025-12-12  
> **原方案**: `doc/ROADMAP_TASK_ARCHITECTURE_REDESIGN.md`  
> **新方案**: `doc/路线图任务架构重构方案_简化版.md`

---

## 📝 方案调整

### 原方案（已废弃）

创建新的 `roadmap_task_links` 关联表：

```sql
-- ❌ 不再采用
CREATE TABLE roadmap_task_links (
    id SERIAL PRIMARY KEY,
    roadmap_id VARCHAR,
    task_id VARCHAR,
    task_type VARCHAR,
    ...
);
```

### 新方案（采用）✅

直接在现有 `roadmap_tasks` 表上扩展字段：

```sql
-- ✅ 采用
ALTER TABLE roadmap_tasks 
    ADD COLUMN task_type VARCHAR,
    ADD COLUMN concept_id VARCHAR,
    ADD COLUMN content_type VARCHAR;

-- ✅ 删除冗余字段
ALTER TABLE roadmap_metadata DROP COLUMN task_id;
```

---

## 🎯 调整原因

| 对比项 | 原方案 | 新方案 | 说明 |
|--------|-------|--------|------|
| **表数量** | 需要新建表 | 复用现有表 | 更简洁 ✅ |
| **数据模型** | 3 个表 | 2 个表 | 更干净 ✅ |
| **查询复杂度** | 需要 JOIN | 单表查询 | 更高效 ✅ |
| **向后兼容** | 保留旧字段 | 直接删除 | 更彻底 ✅ |

---

## 🔧 核心改动

### 1. 表结构（数据层）

```sql
-- roadmap_tasks 表扩展
ALTER TABLE roadmap_tasks 
    ADD COLUMN task_type VARCHAR,        -- 'creation', 'retry_tutorial', 'retry_resources', 'retry_quiz'
    ADD COLUMN concept_id VARCHAR,       -- 单 Concept 重试时填写
    ADD COLUMN content_type VARCHAR;     -- 'tutorial', 'resources', 'quiz'

-- roadmap_metadata 表清理
ALTER TABLE roadmap_metadata DROP COLUMN task_id;  -- 不再需要
```

### 2. 查询逻辑（业务层）

```python
# ❌ 旧逻辑：通过 metadata.task_id 查询
metadata = await repo.get_roadmap_metadata(roadmap_id)
task = await repo.get_task(metadata.task_id)

# ✅ 新逻辑：直接通过 roadmap_id 查询
active_tasks = await repo.get_active_tasks_by_roadmap_id(roadmap_id)
```

### 3. 不向后兼容

- ✅ 直接删除 `roadmap_metadata.task_id`
- ✅ 修复所有使用该字段的代码
- ✅ 不保留废弃字段

---

## 📊 优势对比

| 维度 | 原方案得分 | 新方案得分 |
|------|-----------|-----------|
| **代码简洁性** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **数据模型清晰度** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **查询性能** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **维护成本** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **实施难度** | ⭐⭐⭐ | ⭐⭐⭐⭐ |

**总评**: 新方案更优 ✅

---

## 📚 相关文档

### 主要文档
- ✅ **新方案（采用）**: `doc/路线图任务架构重构方案_简化版.md`
- ✅ **实施清单**: `doc/IMPLEMENTATION_CHECKLIST.md`

### 参考文档
- ❌ **原方案（已废弃）**: `doc/ROADMAP_TASK_ARCHITECTURE_REDESIGN.md`
- 📖 **背景文档**: `doc/STALE_STATUS_DETECTOR_FIX.md`

---

## 🚀 下一步

1. 阅读 `doc/路线图任务架构重构方案_简化版.md`
2. 按照 `doc/IMPLEMENTATION_CHECKLIST.md` 逐步实施
3. 在测试环境充分验证
4. 应用到生产环境

---

## ✅ 方案批准

- [x] 架构设计已完成
- [x] 实施清单已就绪
- [x] 代码影响已分析
- [ ] 等待实施批准

**状态**: 📋 **就绪，等待实施**

