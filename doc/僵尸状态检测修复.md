# åƒµå°¸çŠ¶æ€æ£€æµ‹ä¿®å¤ - WebSocket é€‚é…

> **æ—¥æœŸ**: 2025-12-12  
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## é—®é¢˜æè¿°

ç”¨æˆ·ç‚¹å‡»"é‡æ–°ç”Ÿæˆå­¦ä¹ èµ„æº"æŒ‰é’®åï¼Œå¦‚æœåˆ‡æ¢åˆ°å…¶ä»– tab æˆ– Conceptï¼Œå†è¿”å›æ—¶ä¼šé”™è¯¯åœ°æ˜¾ç¤º"å­¦ä¹ èµ„æºè·å–è¶…æ—¶"è­¦å‘Šã€‚

---

## é—®é¢˜æ ¹æº

### é”™è¯¯çš„æ£€æµ‹é€»è¾‘

1. **ç”¨æˆ·æ“ä½œ**ï¼šç‚¹å‡»"é‡æ–°ç”Ÿæˆèµ„æº"
2. **åç«¯**ï¼šåˆ›å»ºæ–°çš„ taskï¼ˆæ–° task_idï¼‰
3. **é—®é¢˜**ï¼šè·¯çº¿å›¾å…ƒæ•°æ®ä¸­çš„ `task_id` æ²¡æœ‰æ›´æ–°ï¼Œä»æŒ‡å‘æ—§ä»»åŠ¡
4. **ç”¨æˆ·æ“ä½œ**ï¼šåˆ‡æ¢ tabï¼Œç„¶åè¿”å›
5. **å‰ç«¯**ï¼š`StaleStatusDetector` ç»„ä»¶é‡æ–° mount
6. **API è°ƒç”¨**ï¼šè°ƒç”¨ `checkRoadmapStatusQuick(roadmapId)`
7. **åç«¯æ£€æŸ¥**ï¼šæ£€æŸ¥ `metadata.task_id`ï¼ˆæ—§ä»»åŠ¡ï¼Œå·²å®Œæˆï¼‰
8. **è¯¯åˆ¤**ï¼šå‘ç°çŠ¶æ€æ˜¯ `'generating'` ä½†æ²¡æœ‰æ´»è·ƒä»»åŠ¡ â†’ è¯¯åˆ¤ä¸º"åƒµå°¸çŠ¶æ€"

### åç«¯é€»è¾‘é—®é¢˜

```python
# backend/app/api/v1/roadmap.py
task = await repo.get_task(metadata.task_id)  # â† åªæ£€æŸ¥æ—§ä»»åŠ¡
has_active_task = task and task.status in ['pending', 'processing', ...]

# å¦‚æœæ—§ä»»åŠ¡å·²å®Œæˆï¼Œæ–°çš„é‡è¯•ä»»åŠ¡ä¸ä¼šè¢«æ£€æµ‹åˆ°
# å¯¼è‡´æ­£å¸¸çš„ 'generating' çŠ¶æ€è¢«è¯¯åˆ¤ä¸º"åƒµå°¸çŠ¶æ€"
```

---

## è§£å†³æ–¹æ¡ˆ

### ç§»é™¤å¤æ‚çš„è¶…æ—¶æ£€æµ‹é€»è¾‘

ç”±äºæˆ‘ä»¬å·²ç»ç»Ÿä¸€ä½¿ç”¨ **WebSocket çŠ¶æ€åŒæ­¥**ï¼Œè¶…æ—¶æ£€æµ‹æ˜¯ä¸å¿…è¦çš„ã€‚

### 1. åˆ›å»ºç®€å•åŠ è½½ç»„ä»¶

**æ–°æ–‡ä»¶**ï¼š`frontend-next/components/common/generating-content-loader.tsx`

```typescript
/**
 * GeneratingContentLoader - ç®€å•åŠ è½½æŒ‡ç¤ºå™¨
 * 
 * ä¸åŒ…å«è¶…æ—¶æ£€æµ‹ï¼Œå®Œå…¨ä¾èµ– WebSocket å®æ—¶çŠ¶æ€æ›´æ–°
 */
export function GeneratingContentLoader({ contentType }) {
  return (
    <div>
      <Loader2 className="animate-spin" />
      <h3>Generating {contentType}...</h3>
      <p>ğŸ’¡ Status updates via WebSocket</p>
    </div>
  );
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ— è¶…æ—¶æ£€æµ‹
- âœ… æ— è®¡æ—¶å™¨çŠ¶æ€
- âœ… æ—  API è°ƒç”¨
- âœ… çº¯å±•ç¤ºç»„ä»¶

### 2. æ›´æ–° learning-stage.tsx

```diff
- import { StaleStatusDetector } from '@/components/common/stale-status-detector';
+ import { GeneratingContentLoader } from '@/components/common/generating-content-loader';

  {resourcesGenerating ? (
-   <StaleStatusDetector
-     roadmapId={roadmapId}
-     conceptId={concept.concept_id}
-     contentType="resources"
-     status={concept.resources_status}
-     timeoutSeconds={120}
-     ...
-   />
+   <GeneratingContentLoader contentType="resources" />
  ) : ...}
```

---

## ä¼˜åŠ¿å¯¹æ¯”

| ç»´åº¦ | ä¿®å¤å‰ (`StaleStatusDetector`) | ä¿®å¤å (`GeneratingContentLoader`) |
|------|-------------------------------|-------------------------------------|
| **ä»£ç è¡Œæ•°** | 291 è¡Œ | 67 è¡Œ |
| **çŠ¶æ€å˜é‡** | 5 ä¸ªï¼ˆè®¡æ—¶å™¨ã€åƒµå°¸æ ‡è®°ç­‰ï¼‰ | 0 ä¸ª |
| **API è°ƒç”¨** | 1 ä¸ªï¼ˆ`checkRoadmapStatusQuick`ï¼‰ | 0 ä¸ª |
| **è¯¯æŠ¥** | âŒ åˆ‡æ¢ tab åè¿”å›ä¼šè¯¯æŠ¥è¶…æ—¶ | âœ… æ— è¯¯æŠ¥ |
| **å¤æ‚åº¦** | é«˜ | ä½ |

---

## æ¶æ„å¯¹æ¯”

### Beforeï¼ˆæ··åˆæ¨¡å¼ï¼‰

```
ç”¨æˆ·ç‚¹å‡»é‡è¯•
  â†“
WebSocket åˆ›å»º
  â†“
çŠ¶æ€: 'generating'
  â†“
StaleStatusDetector å¯åŠ¨è®¡æ—¶å™¨  â† âš ï¸ é—®é¢˜
  â†“
ç”¨æˆ·åˆ‡æ¢ tab
  â†“
ç»„ä»¶å¸è½½ï¼Œè®¡æ—¶å™¨æ¸…é™¤
  â†“
ç”¨æˆ·è¿”å›
  â†“
StaleStatusDetector é‡æ–° mount
  â†“
è°ƒç”¨ checkRoadmapStatusQuick()  â† âš ï¸ é—®é¢˜
  â†“
åç«¯æ£€æŸ¥æ—§ task_id  â† âš ï¸ é—®é¢˜
  â†“
è¯¯åˆ¤ä¸º"åƒµå°¸çŠ¶æ€"  â† âŒ Bug
```

### Afterï¼ˆçº¯ WebSocketï¼‰

```
ç”¨æˆ·ç‚¹å‡»é‡è¯•
  â†“
WebSocket åˆ›å»º
  â†“
çŠ¶æ€: 'generating'
  â†“
GeneratingContentLoader æ˜¾ç¤º  âœ… ç®€å•
  â†“
ç”¨æˆ·åˆ‡æ¢ tab
  â†“
ç»„ä»¶å¸è½½
  â†“
WebSocket ç»§ç»­è¿è¡Œ  âœ… æŒä¹…åŒ–
  â†“
ç”¨æˆ·è¿”å›
  â†“
GeneratingContentLoader é‡æ–°æ˜¾ç¤º  âœ… ç®€å•
  â†“
WebSocket æ¨é€ concept_complete
  â†“
çŠ¶æ€: 'completed'  âœ… æ­£ç¡®
  â†“
æ˜¾ç¤ºå®Œæˆå†…å®¹
```

---

## ä¿®æ”¹æ–‡ä»¶

### å·²ä¿®æ”¹
- âœ… `frontend-next/components/roadmap/immersive/learning-stage.tsx`
  - æ›¿æ¢äº† 3 å¤„ `StaleStatusDetector` ä½¿ç”¨

### æ–°å¢
- âœ… `frontend-next/components/common/generating-content-loader.tsx`
  - æ–°çš„ç®€å•åŠ è½½ç»„ä»¶

### å¯åˆ é™¤ï¼ˆå·²åºŸå¼ƒï¼‰
- âš ï¸ `frontend-next/components/common/stale-status-detector.tsx`
  - ä¸å†ä½¿ç”¨ï¼Œå¯é€‰åˆ é™¤

---

## æµ‹è¯•æ¸…å•

- [x] âœ… ç‚¹å‡»"é‡æ–°ç”Ÿæˆèµ„æº" â†’ æ˜¾ç¤ºåŠ è½½çŠ¶æ€
- [x] âœ… åˆ‡æ¢åˆ°å…¶ä»– Concept â†’ åŠ è½½çŠ¶æ€æ¶ˆå¤±
- [x] âœ… åˆ‡å›åŸ Concept â†’ å¦‚æœä»åœ¨ç”Ÿæˆï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
- [x] âœ… ç­‰å¾…å®Œæˆ â†’ WebSocket æ›´æ–°çŠ¶æ€ä¸º 'completed'
- [x] âœ… **æ— é”™è¯¯çš„"è¶…æ—¶"è­¦å‘Š**
- [x] âœ… æ— ä¸å¿…è¦çš„ API è°ƒç”¨

---

## åç«¯æ”¹è¿›å»ºè®®ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

è™½ç„¶å‰ç«¯ä¿®å¤è§£å†³äº†å½“å‰é—®é¢˜ï¼Œä½†åç«¯é€»è¾‘ä¹Ÿå¯ä»¥æ”¹è¿›ï¼š

```python
# backend/app/api/v1/roadmap.py

@router.get("/{roadmap_id}/status-check")
async def check_roadmap_status_quick(roadmap_id: str, ...):
    # âœ… æ”¹è¿›ï¼šæ£€æŸ¥æ‰€æœ‰ä¸è¯¥è·¯çº¿å›¾ç›¸å…³çš„æ´»è·ƒä»»åŠ¡
    active_tasks = await repo.get_active_tasks_by_roadmap(roadmap_id)
    has_active_task = len(active_tasks) > 0
    
    # è€Œä¸ä»…ä»…æ˜¯æ£€æŸ¥ metadata.task_id
```

---

## ç»“è®º

âœ… **é€šè¿‡ç§»é™¤å¤æ‚çš„è¶…æ—¶æ£€æµ‹å¹¶å®Œå…¨ä¾èµ– WebSocketï¼Œæˆ‘ä»¬ï¼š**

1. **ä¿®å¤äº† Bug**ï¼šä¸å†å‡ºç°é”™è¯¯çš„è¶…æ—¶è­¦å‘Š
2. **ç®€åŒ–äº†æ¶æ„**ï¼šä»£ç å‡å°‘ 76%ï¼ˆ291 â†’ 67 è¡Œï¼‰
3. **æå‡äº†æ€§èƒ½**ï¼šæ¶ˆé™¤äº†ä¸å¿…è¦çš„ API è°ƒç”¨
4. **ç»Ÿä¸€äº†æ¨¡å¼**ï¼šä¸è·¯çº¿å›¾åˆ›å»ºæµç¨‹ä¿æŒä¸€è‡´

**æ ¸å¿ƒæ´å¯Ÿ**ï¼šå½“ä½ æœ‰å¯é çš„å®æ—¶é€šä¿¡æœºåˆ¶ï¼ˆWebSocketï¼‰æ—¶ï¼ŒåŸºäºæ—¶é—´çš„è¶…æ—¶æ£€æµ‹å¾€å¾€æ˜¯ä¸å¿…è¦çš„ï¼Œç”šè‡³ä¼šå¼•å…¥ bugã€‚

---

**è¯¦ç»†æ–‡æ¡£**: `doc/STALE_STATUS_DETECTOR_FIX.md`

