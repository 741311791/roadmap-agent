# WorkflowBrain 重构任务看板

> **实时更新**: 请定期更新此文档以反映最新进度  
> **创建日期**: 2024-12-13

---

## 📊 整体进度

```
[████░░░░░░░░░░░░░░░░] 0/54 任务完成 (0%)

Phase 1: [░░░░░░░░░░] 0/9   (基础设施)
Phase 2: [░░░░░░░░░░] 0/23  (Runner 迁移)
Phase 3: [░░░░░░░░░░] 0/5   (事务增强)
Phase 4: [░░░░░░░░░░] 0/6   (优化监控)
```

---

## 🎯 当前冲刺 (Sprint 1: Phase 1)

**目标**: 完成 WorkflowBrain 核心组件开发  
**时间**: Day 1-3  
**状态**: 🚀 准备开始

### 📋 待办 (To Do)

```
┌─────────────────────────────────────────────────────────────┐
│ 🔴 HIGH PRIORITY                                            │
├─────────────────────────────────────────────────────────────┤
│ ☐ 1.1 创建 WorkflowBrain 核心类                            │
│      📁 workflow_brain.py                                   │
│      ⏱️  2 小时                                             │
│                                                             │
│ ☐ 1.2 实现 NodeContext 数据类                              │
│      📁 workflow_brain.py                                   │
│      ⏱️  30 分钟                                            │
│                                                             │
│ ☐ 1.3 实现 node_execution 上下文管理器                      │
│      📁 workflow_brain.py                                   │
│      ⏱️  1.5 小时                                           │
└─────────────────────────────────────────────────────────────┘
```

### 🏃 进行中 (In Progress)

```
┌─────────────────────────────────────────────────────────────┐
│ 当前无进行中任务                                            │
│ 👉 开始第一个任务: 1.1 创建 WorkflowBrain 核心类            │
└─────────────────────────────────────────────────────────────┘
```

### ✅ 已完成 (Done)

```
┌─────────────────────────────────────────────────────────────┐
│ 暂无已完成任务                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 📅 Phase 1: 基础设施 (Day 1-3)

### Day 1: 核心结构搭建

| 任务 | 优先级 | 预计时间 | 状态 | 负责人 | 备注 |
|------|--------|---------|------|--------|------|
| 1.1 创建 WorkflowBrain 核心类 | 🔴 Critical | 2h | ⏳ Pending | - | 依赖项：无 |
| 1.2 实现 NodeContext 数据类 | 🔴 Critical | 0.5h | ⏳ Pending | - | 依赖：1.1 |
| 1.3 实现 node_execution 上下文管理器 | 🔴 Critical | 1.5h | ⏳ Pending | - | 依赖：1.1, 1.2 |

**Day 1 目标**: 完成核心类和上下文管理器 ✓

---

### Day 2: 生命周期方法实现

| 任务 | 优先级 | 预计时间 | 状态 | 负责人 | 备注 |
|------|--------|---------|------|--------|------|
| 1.4 实现 _before_node 方法 | 🔴 Critical | 2h | ⏳ Pending | - | 状态/日志/通知 |
| 1.5 实现 _after_node 方法 | 🔴 Critical | 1h | ⏳ Pending | - | 完成处理 |
| 1.6 实现 _on_error 方法 | 🔴 Critical | 1h | ⏳ Pending | - | 错误处理 |
| 1.7 实现特定节点的数据保存方法 | 🟠 High | 2h | ⏳ Pending | - | 3个保存方法 |

**Day 2 目标**: 完成所有生命周期方法 ✓

---

### Day 3: 测试与集成

| 任务 | 优先级 | 预计时间 | 状态 | 负责人 | 备注 |
|------|--------|---------|------|--------|------|
| 1.8 添加 WorkflowBrain 单元测试 | 🔴 Critical | 3h | ⏳ Pending | - | 覆盖率>80% |
| 1.9 集成到 orchestrator_factory | 🔴 Critical | 1h | ⏳ Pending | - | 最后集成步骤 |

**Day 3 目标**: 测试通过，完成集成 ✓

---

## 📅 Phase 2: Runner 迁移 (Day 4-7)

### 迁移顺序与时间分配

```
Day 4: ValidationRunner (2h) + EditorRunner (2h)
Day 5: ReviewRunner (2h) + IntentAnalysisRunner (3h)
Day 6: CurriculumDesignRunner (3h)
Day 7: ContentRunner (4h) + E2E 测试 (2h)
```

### 2.1 ValidationRunner 迁移 (最简单)

| 任务 | 状态 | 预计时间 | 实际时间 |
|------|------|---------|---------|
| 2.1.1 创建新版 ValidationRunner | ⏳ | 1h | - |
| 2.1.2 添加迁移测试 | ⏳ | 0.5h | - |
| 2.1.3 并行对比 | ⏳ | 0.5h | - |
| 2.1.4 切换 | ⏳ | 15min | - |
| 2.1.5 清理 | ⏳ | 15min | - |

**预计完成时间**: Day 4 上午

---

### 2.2 EditorRunner 迁移

| 任务 | 状态 | 预计时间 | 实际时间 |
|------|------|---------|---------|
| 2.2.1 创建新版 EditorRunner | ⏳ | 1h | - |
| 2.2.2 添加迁移测试 | ⏳ | 0.5h | - |
| 2.2.3 切换并清理 | ⏳ | 0.5h | - |

**预计完成时间**: Day 4 下午

---

### 2.3 ReviewRunner 迁移

| 任务 | 状态 | 预计时间 | 实际时间 |
|------|------|---------|---------|
| 2.3.1 创建新版 ReviewRunner | ⏳ | 1h | - |
| 2.3.2 添加迁移测试 | ⏳ | 0.5h | - |
| 2.3.3 切换并清理 | ⏳ | 0.5h | - |

**预计完成时间**: Day 5 上午

**特别注意**: 保留 `interrupt()` 逻辑

---

### 2.4 IntentAnalysisRunner 迁移

| 任务 | 状态 | 预计时间 | 实际时间 |
|------|------|---------|---------|
| 2.4.1 创建新版 IntentAnalysisRunner | ⏳ | 1h | - |
| 2.4.2 实现 brain.ensure_unique_roadmap_id() | ⏳ | 1h | - |
| 2.4.3 添加迁移测试 | ⏳ | 0.5h | - |
| 2.4.4 切换并清理 | ⏳ | 0.5h | - |

**预计完成时间**: Day 5 下午

---

### 2.5 CurriculumDesignRunner 迁移

| 任务 | 状态 | 预计时间 | 实际时间 |
|------|------|---------|---------|
| 2.5.1 创建新版 CurriculumDesignRunner | ⏳ | 1.5h | - |
| 2.5.2 添加迁移测试 | ⏳ | 1h | - |
| 2.5.3 切换并清理 | ⏳ | 0.5h | - |

**预计完成时间**: Day 6

---

### 2.6 ContentRunner 迁移 (最复杂)

| 任务 | 状态 | 预计时间 | 实际时间 |
|------|------|---------|---------|
| 2.6.1 创建新版 ContentRunner | ⏳ | 2h | - |
| 2.6.2 实现 brain.save_content_results() | ⏳ | 1h | - |
| 2.6.3 添加迁移测试 | ⏳ | 0.5h | - |
| 2.6.4 切换并清理 | ⏳ | 0.5h | - |

**预计完成时间**: Day 7 上午

---

### 2.7 端到端验证

| 任务 | 状态 | 预计时间 | 实际时间 |
|------|------|---------|---------|
| 2.7 E2E 验证所有 Runner | ⏳ | 2h | - |

**预计完成时间**: Day 7 下午

---

## 📅 Phase 3: 事务增强 (Day 8-10)

### 任务分解

| 任务 | 优先级 | 状态 | 预计时间 | 目标日期 |
|------|--------|------|---------|----------|
| 3.1 实现 Unit of Work 模式 | 🔴 | ⏳ | 3h | Day 8 |
| 3.2 添加 savepoint 支持 | 🟠 | ⏳ | 2h | Day 8 |
| 3.3 实现智能回滚策略 | 🟠 | ⏳ | 3h | Day 9 |
| 3.4 添加事务超时处理 | 🟡 | ⏳ | 2h | Day 9 |
| 3.5 添加事务场景测试 | 🔴 | ⏳ | 3h | Day 10 |

**Phase 3 目标**: 事务回滚成功率 100% ✓

---

## 📅 Phase 4: 优化监控 (Day 11-13)

### 任务分解

| 任务 | 优先级 | 状态 | 预计时间 | 目标日期 |
|------|--------|------|---------|----------|
| 4.1 批量操作优化 | 🟠 | ⏳ | 2h | Day 11 |
| 4.2 添加性能监控指标 | 🟠 | ⏳ | 3h | Day 11 |
| 4.3 完善错误恢复机制 | 🟡 | ⏳ | 3h | Day 12 |
| 4.4 状态一致性检查工具 | 🟡 | ⏳ | 2h | Day 12 |
| 4.5 更新架构文档 | 🟢 | ⏳ | 3h | Day 13 |
| 4.6 性能基准测试报告 | 🟢 | ⏳ | 2h | Day 13 |

**Phase 4 目标**: 性能提升 > 30%，文档完善 ✓

---

## 🚀 快速开始指南

### 1️⃣ 开始第一个任务

```bash
# 1. 创建分支
git checkout -b feature/workflow-brain-phase1

# 2. 创建文件
touch backend/app/core/orchestrator/workflow_brain.py

# 3. 开始编码
# 参考 WORKFLOW_BRAIN_TASK_BREAKDOWN.md 中的代码骨架

# 4. 更新任务状态
# 将 phase1-1-create-brain-class 标记为 in_progress
```

### 2️⃣ 完成任务检查清单

每完成一个任务，确保：
- [ ] 代码符合中文注释规范
- [ ] 添加了单元测试
- [ ] 通过 linter 检查
- [ ] 更新 TODO 状态为 completed
- [ ] 提交有意义的 commit message

### 3️⃣ 每日同步

每天结束时：
1. 更新此看板的进度
2. 记录遇到的问题
3. 更新预计完成时间
4. 同步团队进度

---

## 📝 日志记录

### Day 1 (2024-12-13)
- ✅ 完成架构分析文档
- ✅ 完成任务清单拆分
- ⏳ 准备开始 Phase 1 开发

---

### 风险与阻塞

#### 🔴 当前阻塞
- 暂无

#### 🟡 潜在风险
1. **LangGraph 兼容性**: 需要深入研究 checkpoint 机制
   - **缓解措施**: 提前查看 LangGraph 源码
   
2. **性能回归**: 增加事务可能影响性能
   - **缓解措施**: 每个 Phase 完成后进行性能测试

---

## 🎯 团队协作

### 角色分工

| 角色 | 负责人 | 职责 |
|------|--------|------|
| 架构师 | - | 设计评审、技术难点攻关 |
| 开发者 | - | 编码实现、单元测试 |
| QA | - | 集成测试、性能测试 |
| DBA | - | 数据库优化、备份恢复 |

### 协作流程

```
开发者提交 PR
    ↓
架构师 Code Review
    ↓
QA 测试验证
    ↓
合并到主分支
    ↓
更新看板状态
```

---

## 📊 度量指标

### 代码指标

| 指标 | 目标 | 当前 | 状态 |
|------|-----|------|------|
| 代码重复率下降 | > 60% | 0% | ⏳ |
| Runner 平均行数 | < 100 | 300+ | ⏳ |
| 测试覆盖率 | > 80% | - | ⏳ |

### 可靠性指标

| 指标 | 目标 | 当前 | 状态 |
|------|-----|------|------|
| 事务回滚成功率 | 100% | - | ⏳ |
| 状态一致性检查 | 100% | - | ⏳ |
| 错误恢复成功率 | > 95% | - | ⏳ |

### 性能指标

| 指标 | 目标 | 重构前 | 重构后 | 提升 |
|------|-----|--------|--------|------|
| 工作流执行时间 | 降低 | - | - | - |
| 数据库查询次数 | 减少 30% | - | - | - |
| 内存占用 | 优化 | - | - | - |

---

## 🔗 快速链接

- [架构分析文档](../architecture/WORKFLOW_BRAIN_ARCHITECTURE_ANALYSIS.md)
- [详细任务清单](WORKFLOW_BRAIN_TASK_BREAKDOWN.md)
- [Orchestrator 架构](../architecture/orchestrator_architecture.md)

---

*看板最后更新: 2024-12-13*

