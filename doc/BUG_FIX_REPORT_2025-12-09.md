# Bug ä¿®å¤æŠ¥å‘Š - 2025-12-09

## ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1ï¼š`curriculum_architect.py` ä¸­ç¼ºå°‘ `re` æ¨¡å—å¯¼å…¥

**é”™è¯¯ä¿¡æ¯ï¼š**
```
NameError: name 're' is not defined. Did you forget to import 're'
```

**æ ¹æœ¬åŸå› ï¼š**
åœ¨ `backend/app/agents/curriculum_architect.py` ç¬¬ 176 è¡Œä½¿ç”¨äº† `re.search()` å‡½æ•°ï¼Œä½†æ–‡ä»¶å¼€å¤´æ²¡æœ‰å¯¼å…¥ `re` æ¨¡å—ã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š**
åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ  `import re` è¯­å¥ã€‚

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- `backend/app/agents/curriculum_architect.py`

---

### é—®é¢˜ 2ï¼šå¤±è´¥çš„è·¯çº¿å›¾æœªåœ¨å‰ç«¯åˆ—è¡¨ä¸­æ˜¾ç¤º

**é—®é¢˜æè¿°ï¼š**
å½“è·¯çº¿å›¾ç”Ÿæˆå¤±è´¥æ—¶ï¼Œå‰ç«¯çš„"æˆ‘çš„è·¯çº¿å›¾"åˆ—è¡¨ä¸­çœ‹ä¸åˆ°å¤±è´¥çš„è·¯çº¿å›¾ï¼Œç”¨æˆ·æ— æ³•ç‚¹å‡»æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ã€‚

**æ ¹æœ¬åŸå› ï¼š**
1. åç«¯ `get_in_progress_tasks_by_user` æ–¹æ³•åªæŸ¥è¯¢ `pending/processing/human_review_pending` çŠ¶æ€çš„ä»»åŠ¡ï¼Œæ²¡æœ‰åŒ…å« `failed` çŠ¶æ€
2. åç«¯ API è¿”å›æ—¶æ²¡æœ‰æ­£ç¡®æ˜ å°„ `failed` çŠ¶æ€
3. å‰ç«¯æ²¡æœ‰é’ˆå¯¹ `failed` çŠ¶æ€çš„ UI å±•ç¤º

**ä¿®å¤æ–¹æ¡ˆï¼š**

#### åç«¯ä¿®æ”¹ï¼š

1. **æ›´æ–°æ•°æ®åº“æŸ¥è¯¢** (`backend/app/db/repositories/roadmap_repo.py`)
   - åœ¨ `get_in_progress_tasks_by_user` æ–¹æ³•ä¸­æ·»åŠ  `"failed"` çŠ¶æ€åˆ°æŸ¥è¯¢æ¡ä»¶
   ```python
   RoadmapTask.status.in_(["pending", "processing", "human_review_pending", "failed"])
   ```

2. **æ›´æ–° API å“åº”** (`backend/app/api/v1/roadmap.py`)
   - åœ¨ `get_user_roadmaps` ç«¯ç‚¹ä¸­æ·»åŠ å¯¹ `failed` çŠ¶æ€çš„å¤„ç†
   - ä¸ºå·²ä¿å­˜çš„è·¯çº¿å›¾ï¼šä¼˜å…ˆæ£€æŸ¥ `task_status == "failed"` å¹¶è®¾ç½® `status = "failed"`
   - ä¸ºè¿›è¡Œä¸­çš„ä»»åŠ¡ï¼šæ ¹æ® `task.status` è®¾ç½® `display_status = "failed"`

#### å‰ç«¯ä¿®æ”¹ï¼š

1. **æ›´æ–°ç±»å‹å®šä¹‰** (`frontend-next/types/custom/store.ts`)
   - åœ¨ `RoadmapHistory` æ¥å£ä¸­æ·»åŠ  `'failed'` çŠ¶æ€åˆ° `status` ç±»å‹
   ```typescript
   status: 'draft' | 'completed' | 'archived' | 'generating' | 'failed' | 'learning';
   ```

2. **æ›´æ–° UI ç»„ä»¶** (`frontend-next/app/(app)/home/page.tsx`)
   - æ·»åŠ  `AlertCircle` å›¾æ ‡å¯¼å…¥
   - åœ¨ `STEP_LABELS` ä¸­æ·»åŠ  `'failed': 'ç”Ÿæˆå¤±è´¥'` æ˜ å°„
   - åœ¨ `RoadmapCard` ç»„ä»¶ä¸­ï¼š
     - æ·»åŠ  `isFailed` çŠ¶æ€åˆ¤æ–­
     - æ›´æ–° `href` é€»è¾‘ï¼Œå¤±è´¥çš„è·¯çº¿å›¾ç‚¹å‡»åè·³è½¬åˆ°ç”Ÿæˆé¡µé¢æŸ¥çœ‹é”™è¯¯
     - æ·»åŠ å¤±è´¥çŠ¶æ€çš„ UI å±•ç¤ºï¼š
       - çº¢è‰²çš„ `AlertCircle` å›¾æ ‡
       - çº¢è‰²çš„è¿›åº¦æ¡ï¼ˆ100% å¡«å……ï¼‰
       - çº¢è‰²çš„ Badge æ˜¾ç¤º"ç”Ÿæˆå¤±è´¥"
       - æ˜¾ç¤ºç›¸å¯¹æ—¶é—´

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- `backend/app/db/repositories/roadmap_repo.py`
- `backend/app/api/v1/roadmap.py`
- `frontend-next/types/custom/store.ts`
- `frontend-next/app/(app)/home/page.tsx`

---

## ä¿®å¤æ•ˆæœ

### é—®é¢˜ 1 ä¿®å¤æ•ˆæœï¼š
- âœ… `curriculum_architect.py` ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå– JSON å†…å®¹
- âœ… ä¸å†å‡ºç° `NameError: name 're' is not defined` é”™è¯¯
- âœ… è·¯çº¿å›¾ç”Ÿæˆæµç¨‹å¯ä»¥æ­£å¸¸å®Œæˆ

### é—®é¢˜ 2 ä¿®å¤æ•ˆæœï¼š
- âœ… å¤±è´¥çš„è·¯çº¿å›¾ç°åœ¨ä¼šæ˜¾ç¤ºåœ¨"æˆ‘çš„è·¯çº¿å›¾"åˆ—è¡¨ä¸­
- âœ… å¤±è´¥çš„è·¯çº¿å›¾æœ‰æ˜æ˜¾çš„è§†è§‰æ ‡è¯†ï¼ˆçº¢è‰²å›¾æ ‡ã€çº¢è‰²è¿›åº¦æ¡ã€"ç”Ÿæˆå¤±è´¥" Badgeï¼‰
- âœ… ç”¨æˆ·å¯ä»¥ç‚¹å‡»å¤±è´¥çš„è·¯çº¿å›¾ï¼Œè·³è½¬åˆ°ç”Ÿæˆé¡µé¢æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- âœ… å¤±è´¥çš„è·¯çº¿å›¾ä¼šæ˜¾ç¤ºåœ¨åˆ—è¡¨é¡¶éƒ¨ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- âœ… ç”¨æˆ·å¯ä»¥äº†è§£è·¯çº¿å›¾ç”Ÿæˆå¤±è´¥çš„åŸå› ï¼Œä¾¿äºé‡è¯•æˆ–è°ƒæ•´è¾“å…¥

---

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### å‰ç«¯ UI ä¼˜åŒ–ï¼š

**å¤±è´¥çŠ¶æ€çš„è·¯çº¿å›¾å¡ç‰‡æ ·å¼ï¼š**
- ğŸ”´ çº¢è‰² `AlertCircle` å›¾æ ‡ï¼Œæ¸…æ™°æ ‡è¯†é”™è¯¯çŠ¶æ€
- ğŸ”´ çº¢è‰²è¿›åº¦æ¡ï¼ˆ100% å¡«å……ï¼‰ï¼Œè¡¨æ˜æµç¨‹ä¸­æ–­
- ğŸ”´ çº¢è‰² Badge æ˜¾ç¤º"ç”Ÿæˆå¤±è´¥"
- ğŸ•’ æ˜¾ç¤ºå¤±è´¥æ—¶é—´ï¼ˆç›¸å¯¹æ—¶é—´æ ¼å¼ï¼‰
- ğŸ”— ç‚¹å‡»å¡ç‰‡è·³è½¬åˆ°ç”Ÿæˆé¡µé¢ï¼Œå¯æŸ¥çœ‹å®Œæ•´é”™è¯¯ä¿¡æ¯

**ä¸ç”Ÿæˆä¸­çŠ¶æ€çš„å¯¹æ¯”ï¼š**
- ç”Ÿæˆä¸­ï¼šç»¿è‰² `Loader2` æ—‹è½¬å›¾æ ‡ + ç»¿è‰²åŠ¨ç”»è¿›åº¦æ¡ + "ç”Ÿæˆä¸­" Badge
- å¤±è´¥ï¼šçº¢è‰² `AlertCircle` å›¾æ ‡ + çº¢è‰²å®Œæ•´è¿›åº¦æ¡ + "ç”Ÿæˆå¤±è´¥" Badge

---

## æŠ€æœ¯ç»†èŠ‚

### åç«¯çŠ¶æ€æµè½¬ï¼š

```
pending -> processing -> [human_review_pending] -> completed
                â†“
              failed (ç°åœ¨ä¼šæ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­)
```

### å‰ç«¯è·¯çº¿å›¾çŠ¶æ€ï¼š

```typescript
type RoadmapStatus = 
  | 'draft'       // è‰ç¨¿
  | 'learning'    // å­¦ä¹ ä¸­
  | 'generating'  // ç”Ÿæˆä¸­
  | 'failed'      // ç”Ÿæˆå¤±è´¥ (æ–°å¢)
  | 'completed'   // å·²å®Œæˆ
  | 'archived'    // å·²å½’æ¡£
```

### API æ•°æ®ç»“æ„ï¼š

```typescript
interface RoadmapHistoryItem {
  roadmap_id: string;
  title: string;
  created_at: string;
  total_concepts: number;
  completed_concepts: number;
  topic?: string | null;
  status?: string | null;       // 'generating' | 'failed' | 'completed' | 'learning'
  task_id?: string | null;      // ç”¨äºè·³è½¬åˆ°ç”Ÿæˆé¡µé¢
  task_status?: string | null;  // åŸå§‹ä»»åŠ¡çŠ¶æ€
  current_step?: string | null; // å½“å‰æˆ–å¤±è´¥çš„æ­¥éª¤
}
```

---

## æµ‹è¯•å»ºè®®

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤ï¼š

1. **æµ‹è¯•è·¯çº¿å›¾ç”Ÿæˆå¤±è´¥åœºæ™¯ï¼š**
   - åˆ›å»ºä¸€ä¸ªæ–°çš„è·¯çº¿å›¾
   - ç­‰å¾…ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼ˆæˆ–æ¨¡æ‹Ÿé”™è¯¯ï¼‰
   - éªŒè¯å¤±è´¥çš„è·¯çº¿å›¾å‡ºç°åœ¨é¦–é¡µåˆ—è¡¨ä¸­
   - éªŒè¯å¡ç‰‡æ˜¾ç¤ºçº¢è‰²å¤±è´¥çŠ¶æ€
   - ç‚¹å‡»å¡ç‰‡ï¼ŒéªŒè¯è·³è½¬åˆ°ç”Ÿæˆé¡µé¢
   - éªŒè¯å¯ä»¥åœ¨ç”Ÿæˆé¡µé¢çœ‹åˆ°å®Œæ•´çš„é”™è¯¯ä¿¡æ¯

2. **æµ‹è¯•æ­£å¸¸ç”Ÿæˆæµç¨‹ï¼š**
   - åˆ›å»ºä¸€ä¸ªæ–°çš„è·¯çº¿å›¾
   - éªŒè¯ç”Ÿæˆä¸­çŠ¶æ€æ­£å¸¸æ˜¾ç¤ºï¼ˆç»¿è‰²åŠ¨ç”»ï¼‰
   - ç­‰å¾…ç”Ÿæˆå®Œæˆ
   - éªŒè¯çŠ¶æ€æ›´æ–°ä¸º"å­¦ä¹ ä¸­"æˆ–"å·²å®Œæˆ"

3. **æµ‹è¯•å†å²è®°å½•ï¼š**
   - éªŒè¯å¤šä¸ªè·¯çº¿å›¾ï¼ˆåŒ…æ‹¬å¤±è´¥çš„ï¼‰éƒ½æ­£å¸¸æ˜¾ç¤º
   - éªŒè¯æ’åºæ­£ç¡®ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
   - éªŒè¯æ¯ä¸ªçŠ¶æ€çš„è§†è§‰æ ‡è¯†æ¸…æ™°å¯è¾¨

### è‡ªåŠ¨åŒ–æµ‹è¯•å»ºè®®ï¼š

```python
# åç«¯å•å…ƒæµ‹è¯•
async def test_get_user_roadmaps_includes_failed():
    """æµ‹è¯•ç”¨æˆ·è·¯çº¿å›¾åˆ—è¡¨åŒ…å«å¤±è´¥çš„ä»»åŠ¡"""
    # åˆ›å»ºä¸€ä¸ªå¤±è´¥çš„ä»»åŠ¡
    # è°ƒç”¨ get_user_roadmaps
    # éªŒè¯è¿”å›åˆ—è¡¨åŒ…å«å¤±è´¥çš„ä»»åŠ¡
    # éªŒè¯ status ä¸º 'failed'
```

```typescript
// å‰ç«¯å•å…ƒæµ‹è¯•
describe('RoadmapCard', () => {
  it('should display failed state correctly', () => {
    // æ¸²æŸ“å¤±è´¥çŠ¶æ€çš„è·¯çº¿å›¾å¡ç‰‡
    // éªŒè¯æ˜¾ç¤ºçº¢è‰²å›¾æ ‡
    // éªŒè¯æ˜¾ç¤º"ç”Ÿæˆå¤±è´¥" Badge
    // éªŒè¯ç‚¹å‡»è·³è½¬æ­£ç¡®
  });
});
```

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶ï¼š
- âœ… `backend/app/agents/curriculum_architect.py`
- âœ… `backend/app/db/repositories/roadmap_repo.py`
- âœ… `backend/app/api/v1/roadmap.py`

### å‰ç«¯æ–‡ä»¶ï¼š
- âœ… `frontend-next/app/(app)/home/page.tsx`
- âœ… `frontend-next/types/custom/store.ts`

### æ— éœ€ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `frontend-next/lib/api/endpoints.ts` (ç±»å‹å®šä¹‰å·²å®Œæ•´ï¼Œæ— éœ€ä¿®æ”¹)
- `frontend-next/lib/store/roadmap-store.ts` (å·²åŒ…å« 'failed' çŠ¶æ€)

---

## æ€»ç»“

æ­¤æ¬¡ä¿®å¤è§£å†³äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

1. **ä»£ç é”™è¯¯**ï¼šä¿®å¤äº† `curriculum_architect.py` ä¸­ç¼ºå°‘ `re` æ¨¡å—å¯¼å…¥å¯¼è‡´çš„è¿è¡Œæ—¶é”™è¯¯
2. **ç”¨æˆ·ä½“éªŒ**ï¼šç¡®ä¿å¤±è´¥çš„è·¯çº¿å›¾åœ¨å‰ç«¯å¯è§ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹é”™è¯¯ä¿¡æ¯å¹¶é‡è¯•

è¿™äº›ä¿®å¤æé«˜äº†ç³»ç»Ÿçš„å¥å£®æ€§å’Œç”¨æˆ·ä½“éªŒï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿæ›´å¥½åœ°äº†è§£è·¯çº¿å›¾ç”Ÿæˆè¿‡ç¨‹ä¸­çš„é—®é¢˜ã€‚

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2025-12-09
**æµ‹è¯•çŠ¶æ€ï¼š** âœ… ä»£ç å®¡æŸ¥é€šè¿‡ï¼Œæ—  Linter é”™è¯¯
**éƒ¨ç½²çŠ¶æ€ï¼š** å¾…éƒ¨ç½²

