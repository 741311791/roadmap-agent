# æ™ºèƒ½é‡è¯•æœºåˆ¶ (Intelligent Retry Mechanism)

## ğŸ“‹ æ¦‚è¿°

ç³»ç»Ÿå®ç°äº†**ä¸¤ç§é‡è¯•æœºåˆ¶**ï¼Œè‡ªåŠ¨æ ¹æ®ä»»åŠ¡å¤±è´¥é˜¶æ®µé€‰æ‹©æœ€åˆé€‚çš„æ¢å¤ç­–ç•¥ã€‚

---

## ğŸ¯ ä¸¤ç§é‡è¯•ç­–ç•¥

### ç­–ç•¥ 1ï¼šCheckpoint æ¢å¤ï¼ˆç²—ç²’åº¦ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- ä»»åŠ¡åœ¨å·¥ä½œæµ**æ—©æœŸé˜¶æ®µ**å¤±è´¥
- å¤±è´¥æ­¥éª¤ï¼š`intent_analysis`, `curriculum_design`, `structure_validation`, `roadmap_edit`, `human_review`

**å·¥ä½œåŸç†ï¼š**
```
ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼š
â”œâ”€ intent_analysis âœ…
â”œâ”€ curriculum_design âœ…  
â”œâ”€ structure_validation âœ…
â”œâ”€ roadmap_edit âŒ (å¤±è´¥)    â† LangGraph è‡ªåŠ¨ä¿å­˜ checkpoint
â””â”€ [æœªæ‰§è¡Œçš„æ­¥éª¤]

é‡è¯•æ—¶ï¼š
ä» checkpoint æ¢å¤ â†’ ç»§ç»­æ‰§è¡Œ roadmap_edit â†’ åç»­æ­¥éª¤
```

**ä¼˜ç‚¹ï¼š**
- âœ… ä¿ç•™æ‰€æœ‰ä¸­é—´çŠ¶æ€å’Œå˜é‡
- âœ… ä¸éœ€è¦é‡æ–°æ‰§è¡Œå·²æˆåŠŸçš„æ­¥éª¤
- âœ… é€‚ç”¨äºå·¥ä½œæµä»»ä½•é˜¶æ®µ
- âœ… ç»§æ‰¿åŸä»»åŠ¡çš„æ‰€æœ‰ä¸Šä¸‹æ–‡

**å®ç°ï¼š**
- ä» PostgreSQL `checkpoints` è¡¨æ¢å¤çŠ¶æ€
- ä½¿ç”¨ LangGraph çš„ `ainvoke(None, config)` API
- ä»»åŠ¡ ID ä¿æŒä¸å˜

---

### ç­–ç•¥ 2ï¼šå†…å®¹é‡è¯•ï¼ˆç»†ç²’åº¦ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- ä»»åŠ¡åœ¨**å†…å®¹ç”Ÿæˆé˜¶æ®µ**éƒ¨åˆ†å¤±è´¥
- éƒ¨åˆ† Concept çš„æ•™ç¨‹/èµ„æº/æµ‹éªŒç”Ÿæˆå¤±è´¥

**å·¥ä½œåŸç†ï¼š**
```
Roadmap ç»“æ„ï¼ˆå·²ç”Ÿæˆï¼‰ï¼š
â”œâ”€ Concept A
â”‚  â”œâ”€ Tutorial âœ…
â”‚  â”œâ”€ Resources âœ…
â”‚  â””â”€ Quiz âœ…
â”œâ”€ Concept B
â”‚  â”œâ”€ Tutorial âŒ (å¤±è´¥)    â† åªé‡è¯•è¿™ä¸ª
â”‚  â”œâ”€ Resources âœ…
â”‚  â””â”€ Quiz âœ…
â””â”€ Concept C
   â”œâ”€ Tutorial âœ…
   â”œâ”€ Resources âŒ (å¤±è´¥)   â† åªé‡è¯•è¿™ä¸ª
   â””â”€ Quiz âŒ (å¤±è´¥)        â† åªé‡è¯•è¿™ä¸ª

é‡è¯•æ—¶ï¼š
æ‰«æ framework_data â†’ æ‰¾åˆ°å¤±è´¥é¡¹ â†’ åˆ›å»ºæ–°ä»»åŠ¡é‡æ–°ç”Ÿæˆ
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç²¾ç¡®åˆ° ConceptÃ—ContentType ç²’åº¦
- âœ… åªé‡æ–°ç”Ÿæˆå¤±è´¥çš„éƒ¨åˆ†
- âœ… èŠ‚çœ API è°ƒç”¨æˆæœ¬ï¼ˆå¯èŠ‚çœ 90%+ï¼‰
- âœ… æ”¯æŒå¢é‡ä¿®å¤ï¼ˆå¯å¤šæ¬¡é‡è¯•ï¼‰

**å®ç°ï¼š**
- æ‰«æ `framework_data` ä¸­çš„çŠ¶æ€å­—æ®µ
- åˆ›å»ºæ–°çš„åå°ä»»åŠ¡
- åªè°ƒç”¨å¤±è´¥å†…å®¹å¯¹åº”çš„ Agent

---

## ğŸ”§ API ä½¿ç”¨

### ç«¯ç‚¹

```
POST /api/v1/tasks/{task_id}/retry?user_id={user_id}
```

### å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `task_id` | string (path) | è¦é‡è¯•çš„ä»»åŠ¡ ID |
| `user_id` | string (query) | ç”¨æˆ· ID |
| `force_checkpoint` | bool (query) | å¼ºåˆ¶ä½¿ç”¨ checkpoint æ¢å¤ï¼ˆé»˜è®¤ falseï¼‰ |

### è‡ªåŠ¨åˆ¤æ–­é€»è¾‘

```python
if force_checkpoint:
    ä½¿ç”¨ Checkpoint æ¢å¤
elif checkpoint_exists and task.current_step in EARLY_STAGES:
    ä½¿ç”¨ Checkpoint æ¢å¤  # æ—©æœŸé˜¶æ®µå¤±è´¥
elif has_failed_concepts:
    ä½¿ç”¨å†…å®¹é‡è¯•  # å†…å®¹ç”Ÿæˆé˜¶æ®µå¤±è´¥
else:
    è¿”å›é”™è¯¯ï¼ˆæ— æ³•é‡è¯•ï¼‰
```

### å“åº”ç¤ºä¾‹

#### Checkpoint æ¢å¤å“åº”

```json
{
  "success": true,
  "recovery_type": "checkpoint",
  "task_id": "e2054e91-c19f-4221-9e5e-449de50ca1ef",
  "roadmap_id": "ai-agent-development-k8s7m6n5",
  "checkpoint_step": "roadmap_edit",
  "status": "recovering",
  "message": "æ­£åœ¨ä» checkpoint æ¢å¤ï¼ˆæ­¥éª¤ï¼šroadmap_editï¼‰"
}
```

#### å†…å®¹é‡è¯•å“åº”

```json
{
  "success": true,
  "recovery_type": "content_retry",
  "new_task_id": "550e8400-e29b-41d4-a716-446655440000",
  "old_task_id": "e2054e91-c19f-4221-9e5e-449de50ca1ef",
  "roadmap_id": "python-web-dev-2024",
  "status": "processing",
  "items_to_retry": {
    "tutorial": 3,
    "resources": 2,
    "quiz": 1
  },
  "total_items": 6,
  "message": "å¼€å§‹é‡è¯• 6 ä¸ªå¤±è´¥é¡¹ç›®"
}
```

---

## ğŸ“Š å†³ç­–æµç¨‹å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ç”¨æˆ·ç‚¹å‡»é‡è¯•    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ æ£€æŸ¥ checkpoint  â”‚
                    â”‚ å’Œå¤±è´¥é˜¶æ®µ       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ checkpoint   â”‚           â”‚ å†…å®¹ç”Ÿæˆ   â”‚
         â”‚ å­˜åœ¨ &&      â”‚           â”‚ é˜¶æ®µå¤±è´¥   â”‚
         â”‚ æ—©æœŸé˜¶æ®µå¤±è´¥ â”‚           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚
                â”‚                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ ç­–ç•¥1:      â”‚           â”‚ ç­–ç•¥2:     â”‚
         â”‚ Checkpoint  â”‚           â”‚ å†…å®¹é‡è¯•   â”‚
         â”‚ æ¢å¤        â”‚           â”‚            â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ ä» thread_idâ”‚           â”‚ åˆ›å»ºæ–°ä»»åŠ¡  â”‚
         â”‚ æ¢å¤æ‰§è¡Œ    â”‚           â”‚ é‡æ–°ç”Ÿæˆ    â”‚
         â”‚ ä¿æŒåŸä»»åŠ¡IDâ”‚           â”‚ å¤±è´¥å†…å®¹    â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚                         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                  â”‚  è®¢é˜…è¿›åº¦   â”‚
                  â”‚  (WebSocket)â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ç¤ºä¾‹åœºæ™¯

### åœºæ™¯ 1ï¼šè·¯çº¿å›¾ç¼–è¾‘å¤±è´¥

```bash
# ä»»åŠ¡å¤±è´¥ä¿¡æ¯
Task ID: e2054e91-c19f-4221-9e5e-449de50ca1ef
Status: failed
Current Step: roadmap_edit
Error: RoadmapEditOutput object has no attribute 'updated_framework'

# æ£€æŸ¥çŠ¶æ€
âœ… Checkpoint å­˜åœ¨ (5ä¸ª)
âœ… å¤±è´¥åœ¨æ—©æœŸé˜¶æ®µ (roadmap_edit)
âŒ æ²¡æœ‰å¤±è´¥çš„ Concept å†…å®¹ (0ä¸ª)

# é‡è¯•å†³ç­–
â†’ ä½¿ç”¨ Checkpoint æ¢å¤
â†’ ä» roadmap_edit æ­¥éª¤ç»§ç»­æ‰§è¡Œ
â†’ ä¸åˆ›å»ºæ–°ä»»åŠ¡ï¼Œä½¿ç”¨åŸ task_id
```

### åœºæ™¯ 2ï¼šéƒ¨åˆ†æ•™ç¨‹ç”Ÿæˆå¤±è´¥

```bash
# ä»»åŠ¡å¤±è´¥ä¿¡æ¯
Task ID: abc123-def456
Status: partial_failure
Current Step: content_generation
Roadmap: 50 concepts

# æ£€æŸ¥çŠ¶æ€
âœ… Checkpoint å­˜åœ¨
âœ… å¤±è´¥åœ¨å†…å®¹ç”Ÿæˆé˜¶æ®µ
âœ… å¤±è´¥çš„ Concept å†…å®¹:
   - 3ä¸ªæ•™ç¨‹å¤±è´¥
   - 2ä¸ªèµ„æºæ¨èå¤±è´¥
   - 1ä¸ªæµ‹éªŒå¤±è´¥

# é‡è¯•å†³ç­–
â†’ ä½¿ç”¨å†…å®¹é‡è¯•
â†’ åªé‡æ–°ç”Ÿæˆ 6ä¸ªå¤±è´¥é¡¹
â†’ åˆ›å»ºæ–°ä»»åŠ¡ ID
â†’ èŠ‚çœ 44ä¸ª Concept çš„ API è°ƒç”¨
```

### åœºæ™¯ 3ï¼šå¼ºåˆ¶ Checkpoint æ¢å¤

```bash
# ç”¨æˆ·éœ€æ±‚ï¼šå³ä½¿æœ‰å¤±è´¥å†…å®¹ï¼Œä¹Ÿæƒ³ä»å¤´é‡æ–°ç”Ÿæˆ

# API è°ƒç”¨
POST /api/v1/tasks/{task_id}/retry?force_checkpoint=true

# é‡è¯•å†³ç­–
â†’ å¼ºåˆ¶ä½¿ç”¨ Checkpoint æ¢å¤
â†’ å¿½ç•¥ framework_data ä¸­çš„å¤±è´¥çŠ¶æ€
â†’ ä»å·¥ä½œæµæœ€åä¸€ä¸ª checkpoint ç»§ç»­
```

---

## âš™ï¸ é…ç½®

### Checkpoint ä¿ç•™ç­–ç•¥

é»˜è®¤æƒ…å†µä¸‹ï¼ŒLangGraph ä¼šè‡ªåŠ¨ä¿å­˜ checkpointï¼š

```python
# æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåè‡ªåŠ¨ä¿å­˜
workflow.compile(checkpointer=AsyncPostgresSaver(...))

# Checkpoint å­˜å‚¨åœ¨ PostgreSQL
Table: checkpoints
Columns: thread_id, checkpoint_id, checkpoint, metadata
```

### Checkpoint æ¸…ç†

Checkpoint åœ¨ä»¥ä¸‹æƒ…å†µä¼šè¢«æ¸…ç†ï¼š
- âš ï¸ ä»»åŠ¡å®Œæˆåï¼ˆå¯èƒ½è¢«æ¸…ç†ï¼‰
- âš ï¸ æ•°æ®åº“ç»´æŠ¤æ—¶
- âš ï¸ è¶…è¿‡ä¿ç•™æœŸé™

**å»ºè®®ï¼š** å¯¹äºé‡è¦ä»»åŠ¡ï¼Œåœ¨å†…å®¹ç”Ÿæˆå®Œæˆå‰ä¸è¦æ¸…ç† checkpointã€‚

---

## ğŸ§ª å‰ç«¯é…åˆ

### 1. å¤„ç†å“åº”ç±»å‹

```typescript
const result = await retryTask(taskId, userId);

if (result.recovery_type === 'checkpoint') {
  // Checkpoint æ¢å¤ï¼šä½¿ç”¨åŸ task_id è®¢é˜…è¿›åº¦
  subscribeToTask(result.task_id);
  
} else if (result.recovery_type === 'content_retry') {
  // å†…å®¹é‡è¯•ï¼šä½¿ç”¨æ–° task_id è®¢é˜…è¿›åº¦
  subscribeToTask(result.new_task_id);
}
```

### 2. æ˜¾ç¤ºæ¢å¤ç±»å‹

```typescript
if (result.recovery_type === 'checkpoint') {
  toast.info(`Recovering from ${result.checkpoint_step}...`);
  router.push(`/roadmap/${result.roadmap_id}`);
  
} else {
  toast.info(`Retrying ${result.total_items} failed items...`);
  router.push(`/roadmap/${result.roadmap_id}?retryTaskId=${result.new_task_id}`);
}
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | Checkpoint æ¢å¤ | å†…å®¹é‡è¯• |
|------|----------------|----------|
| é€‚ç”¨é˜¶æ®µ | ä»»ä½•é˜¶æ®µ | ä»…å†…å®¹ç”Ÿæˆ |
| ä¿ç•™çŠ¶æ€ | âœ… å®Œæ•´ä¿ç•™ | âŒ é‡æ–°å¼€å§‹ |
| API è°ƒç”¨ | åªè°ƒç”¨å¤±è´¥æ­¥éª¤åçš„ | åªè°ƒç”¨å¤±è´¥çš„å†…å®¹ |
| æˆæœ¬ | ä½ | éå¸¸ä½ |
| é€Ÿåº¦ | å¿«ï¼ˆç»§ç»­æ‰§è¡Œï¼‰ | å–å†³äºå¤±è´¥æ•°é‡ |
| ç²¾ç¡®åº¦ | èŠ‚ç‚¹çº§ | ConceptÃ—ContentType çº§ |

---

## ğŸš€ æœ€ä½³å®è·µ

1. **è®©ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©ç­–ç•¥** - é»˜è®¤è¡Œä¸ºå·²ä¼˜åŒ–
2. **æ—©æœŸé˜¶æ®µå¤±è´¥** - è‡ªåŠ¨ä½¿ç”¨ checkpoint æ¢å¤
3. **å†…å®¹ç”Ÿæˆå¤±è´¥** - è‡ªåŠ¨ä½¿ç”¨å†…å®¹é‡è¯•
4. **å¼ºåˆ¶æ¢å¤** - ä½¿ç”¨ `force_checkpoint=true`
5. **å¤šæ¬¡é‡è¯•** - å†…å®¹é‡è¯•æ”¯æŒå¢é‡ä¿®å¤

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šè¿”å›"æ²¡æœ‰éœ€è¦é‡è¯•çš„å¤±è´¥é¡¹ç›®"

**åŸå› ï¼š** ä»»åŠ¡åœ¨æ—©æœŸé˜¶æ®µå¤±è´¥ï¼Œè¿˜æ²¡æœ‰ç”Ÿæˆ Concept å†…å®¹

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ä½¿ç”¨å¼ºåˆ¶ checkpoint æ¢å¤
POST /api/v1/tasks/{task_id}/retry?force_checkpoint=true
```

### é—®é¢˜ï¼šCheckpoint ä¸å­˜åœ¨

**åŸå› ï¼š** Checkpoint å·²è¢«æ¸…ç†æˆ–æ•°æ®åº“è¿æ¥å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. ä½¿ç”¨å†…å®¹é‡è¯•ï¼ˆå¦‚æœæœ‰å¤±è´¥çš„ Conceptï¼‰
3. é‡æ–°ç”Ÿæˆè·¯çº¿å›¾

---

## ğŸ“ æ€»ç»“

è¿™ä¸ªæ™ºèƒ½é‡è¯•æœºåˆ¶ç»“åˆäº†ï¼š
- âœ… **LangGraph Checkpoint** çš„çŠ¶æ€æŒä¹…åŒ–èƒ½åŠ›
- âœ… **ç»†ç²’åº¦çŠ¶æ€è¿½è¸ª** çš„ç²¾ç¡®æ§åˆ¶
- âœ… **è‡ªåŠ¨å†³ç­–** çš„ç”¨æˆ·å‹å¥½ä½“éªŒ
- âœ… **æˆæœ¬ä¼˜åŒ–** çš„ç”Ÿäº§çº§è€ƒè™‘

æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€ç”Ÿäº§çº§çš„ä»»åŠ¡æ¢å¤è§£å†³æ–¹æ¡ˆï¼ğŸ¯

