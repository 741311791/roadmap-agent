# R2 æ•™ç¨‹å†…å®¹ CORS é—®é¢˜ä¿®å¤ - 2025-12-26

## ğŸ› é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Access to fetch at 'https://be54a709a35ba73b4686b31599f9823d.r2.cloudflarestorage.com/...' 
from origin 'http://localhost:3000' has been blocked by CORS policy: 
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**ç°è±¡ï¼š**
- æ•™ç¨‹å·²æˆåŠŸç”Ÿæˆå¹¶ä¸Šä¼ åˆ° Cloudflare R2
- åç«¯è¿”å›çš„ `content_url` æ˜¯ R2 çš„é¢„ç­¾å URL
- å‰ç«¯å°è¯•ç›´æ¥é€šè¿‡ `fetch()` ä¸‹è½½å†…å®¹æ—¶è¢« CORS ç­–ç•¥é˜»æ­¢
- ç”¨æˆ·æ— æ³•æŸ¥çœ‹æ•™ç¨‹å†…å®¹

---

## ğŸ” æ ¹æœ¬åŸå› 

### æ¶æ„é—®é¢˜

**ä¿®å¤å‰çš„æµç¨‹ï¼š**
```
1. åç«¯ç”Ÿæˆæ•™ç¨‹ï¼Œä¸Šä¼ åˆ° R2
2. åç«¯è¿”å›é¢„ç­¾å URL: https://xxx.r2.cloudflarestorage.com/...
3. å‰ç«¯ç›´æ¥ fetch(content_url)
4. âŒ CORS é˜»æ­¢ï¼ˆR2 Bucket æœªé…ç½® CORSï¼‰
```

**ä¸ºä»€ä¹ˆä¼šæœ‰ CORS é—®é¢˜ï¼š**
- å‰ç«¯è¿è¡Œåœ¨ `http://localhost:3000` (å¼€å‘) æˆ– `https://yourdomain.com` (ç”Ÿäº§)
- R2 å­˜å‚¨åœ¨ `https://xxx.r2.cloudflarestorage.com`
- è¿™æ˜¯è·¨åŸŸè¯·æ±‚ï¼Œéœ€è¦ R2 è¿”å› `Access-Control-Allow-Origin` å¤´
- ä½† R2 Bucket é»˜è®¤ä¸é…ç½® CORS ç­–ç•¥

**ä¸ºä»€ä¹ˆä¸ç›´æ¥é…ç½® R2 CORSï¼š**
1. **å®‰å…¨æ€§é—®é¢˜**ï¼šæš´éœ² R2 URL ç»™å‰ç«¯ï¼Œå¯èƒ½è¢«æ»¥ç”¨
2. **ç®¡ç†å¤æ‚æ€§**ï¼šéœ€è¦åœ¨ Cloudflare æ§åˆ¶å°æ‰‹åŠ¨é…ç½®
3. **ä¸å¤Ÿçµæ´»**ï¼šæ— æ³•åŠ¨æ€æ§åˆ¶è®¿é—®æƒé™

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©ï¼šåç«¯ä»£ç†ä¸‹è½½ï¼ˆæ¨èï¼‰

**ä¿®å¤åçš„æµç¨‹ï¼š**
```
1. åç«¯ç”Ÿæˆæ•™ç¨‹ï¼Œä¸Šä¼ åˆ° R2
2. åç«¯åœ¨æ•°æ®åº“ä¸­è®°å½• content_urlï¼ˆç§æœ‰ï¼Œä¸æš´éœ²ç»™å‰ç«¯ï¼‰
3. å‰ç«¯è¯·æ±‚åç«¯ä»£ç†ç«¯ç‚¹
4. åç«¯ä» R2 ä¸‹è½½å†…å®¹
5. åç«¯è¿”å›å†…å®¹ç»™å‰ç«¯
6. âœ… æ—  CORS é—®é¢˜ï¼ˆåŒåŸŸè¯·æ±‚ï¼‰
```

**ä¼˜ç‚¹ï¼š**
- âœ… ä¸éœ€è¦é…ç½® R2 CORS
- âœ… R2 URL ä¸æš´éœ²ç»™å‰ç«¯ï¼Œæ›´å®‰å…¨
- âœ… åç«¯å¯ä»¥æ·»åŠ è®¿é—®æ§åˆ¶é€»è¾‘
- âœ… å¯ä»¥ç¼“å­˜ã€å‹ç¼©ç­‰ä¼˜åŒ–

**ç¼ºç‚¹ï¼š**
- åç«¯å¢åŠ ä¸€æ¬¡ä»£ç†è¯·æ±‚
- å¢åŠ åç«¯å¸¦å®½æ¶ˆè€—ï¼ˆä½†æ•™ç¨‹å†…å®¹é€šå¸¸ä¸å¤§ï¼Œå¯æ¥å—ï¼‰

---

## ğŸ“ ä¿®æ”¹å†…å®¹

### 1. åç«¯ï¼šæ–°å¢ä»£ç†ä¸‹è½½ç«¯ç‚¹

**æ–‡ä»¶ï¼š** `backend/app/api/v1/endpoints/tutorial.py`

**æ–°å¢ç«¯ç‚¹ï¼š**
```python
@router.get(
    "/{roadmap_id}/concepts/{concept_id}/tutorials/latest/content",
    response_class=PlainTextResponse
)
async def download_latest_tutorial_content(
    roadmap_id: str,
    concept_id: str,
    db: AsyncSession = Depends(get_db),
):
    """
    ä¸‹è½½æœ€æ–°ç‰ˆæœ¬æ•™ç¨‹çš„ Markdown å†…å®¹ï¼ˆåç«¯ä»£ç†ï¼‰
    
    æ­¤ç«¯ç‚¹è§£å†³ CORS é—®é¢˜ï¼š
    - å‰ç«¯ä¸ç›´æ¥è®¿é—® R2/S3 URLï¼ˆä¼šæœ‰ CORS é™åˆ¶ï¼‰
    - é€šè¿‡åç«¯ä»£ç†ä¸‹è½½å†…å®¹
    - è¿”å›çº¯æ–‡æœ¬ Markdown
    """
    repo = RoadmapRepository(db)
    
    # 1. è·å–æœ€æ–°æ•™ç¨‹å…ƒæ•°æ®
    tutorial = await repo.get_latest_tutorial(roadmap_id, concept_id)
    
    # 2. ä» content_url æå– S3 key
    # 3. ä» S3 ä¸‹è½½å†…å®¹
    # 4. è¿”å› Markdown æ–‡æœ¬
```

**å…³é”®é€»è¾‘ï¼š**
- ä» `content_url` ä¸­æå– S3 keyï¼ˆç§»é™¤åŸŸåå’Œç­¾åå‚æ•°ï¼‰
- ä½¿ç”¨ `S3StorageTool.download()` ä¸‹è½½å†…å®¹
- è¿”å› `PlainTextResponse`ï¼ŒContent-Type ä¸º `text/plain`

---

### 2. å‰ç«¯ï¼šä¿®æ”¹ä¸‹è½½å‡½æ•°

**æ–‡ä»¶ï¼š** `frontend-next/lib/api/endpoints.ts`

**ä¿®æ”¹å‰ï¼š**
```typescript
export async function downloadTutorialContent(
  contentUrl: string  // âŒ ç›´æ¥ä½¿ç”¨ R2 URL
): Promise<string> {
  const response = await fetch(contentUrl);  // âŒ CORS é˜»æ­¢
  return await response.text();
}
```

**ä¿®æ”¹åï¼š**
```typescript
export async function downloadTutorialContent(
  roadmapId: string,
  conceptId: string
): Promise<string> {
  const response = await apiClient.get(
    `/roadmaps/${roadmapId}/concepts/${conceptId}/tutorials/latest/content`,
    { responseType: 'text' }
  );
  return response.data;
}
```

**å˜åŒ–ï¼š**
- âœ… ä¸å†æ¥æ”¶ `contentUrl` å‚æ•°
- âœ… æ”¹ä¸ºæ¥æ”¶ `roadmapId` å’Œ `conceptId`
- âœ… é€šè¿‡åç«¯ä»£ç†ç«¯ç‚¹ä¸‹è½½
- âœ… æ—  CORS é—®é¢˜

---

### 3. å‰ç«¯ï¼šæ›´æ–°è°ƒç”¨æ–¹

**æ–‡ä»¶ 1ï¼š** `frontend-next/app/(immersive)/roadmap/[id]/page.tsx`

```typescript
// âŒ ä¿®æ”¹å‰
const text = await downloadTutorialContent(meta.content_url);

// âœ… ä¿®æ”¹å
const text = await downloadTutorialContent(roadmapId, conceptId);
```

**æ–‡ä»¶ 2ï¼š** `frontend-next/components/tutorial/tutorial-dialog.tsx`

```typescript
// âŒ ä¿®æ”¹å‰
const markdownContent = await downloadTutorialContent(tutorialMeta.content_url);

// âœ… ä¿®æ”¹å
const markdownContent = await downloadTutorialContent(roadmapId, conceptId);
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. é‡å¯åç«¯æœåŠ¡
```bash
cd backend
poetry run uvicorn app.main:app --reload
```

### 2. è®¿é—®è·¯çº¿å›¾è¯¦æƒ…é¡µ
```
http://localhost:3000/roadmap/{roadmap_id}?concept={concept_id}
```

### 3. éªŒè¯åŠ è½½æˆåŠŸ

**æœŸæœ›ï¼š**
- âœ… æ•™ç¨‹å†…å®¹æ­£å¸¸æ˜¾ç¤º
- âœ… æ—  CORS é”™è¯¯
- âœ… Console æ˜¾ç¤ºæˆåŠŸæ—¥å¿—

**æ£€æŸ¥ç½‘ç»œè¯·æ±‚ï¼š**
```
# æµè§ˆå™¨å¼€å‘è€…å·¥å…· Network æ ‡ç­¾
GET /api/v1/roadmaps/{roadmap_id}/concepts/{concept_id}/tutorials/latest/content
Status: 200 OK
Content-Type: text/plain; charset=utf-8
Response: # Introduction to Python\n\nPython is...
```

---

## ğŸ“Š æ€§èƒ½å½±å“

### è¯·æ±‚æµç¨‹å¯¹æ¯”

**ä¿®å¤å‰ï¼š**
```
å‰ç«¯ â†’ R2 (ç›´æ¥ä¸‹è½½)
```

**ä¿®å¤åï¼š**
```
å‰ç«¯ â†’ åç«¯ â†’ R2 â†’ åç«¯ â†’ å‰ç«¯
```

### é¢å¤–å¼€é”€

| é¡¹ç›® | å½±å“ | è¯´æ˜ |
|-----|------|------|
| å»¶è¿Ÿ | +50-200ms | å¤šä¸€æ¬¡åç«¯è½¬å‘ï¼Œä½†å¯¹ç”¨æˆ·ä½“éªŒå½±å“ä¸å¤§ |
| åç«¯å¸¦å®½ | +æ•™ç¨‹å¤§å°Ã—2 | æ•™ç¨‹é€šå¸¸ 5-50KBï¼Œå¯æ¥å— |
| åç«¯å†…å­˜ | ä¸´æ—¶å†…å­˜ | æµå¼ä¼ è¾“ï¼Œå†…å­˜å ç”¨å° |
| å®‰å…¨æ€§ | âœ… æå‡ | R2 URL ä¸æš´éœ²ï¼Œæ›´å®‰å…¨ |

### ä¼˜åŒ–å»ºè®®ï¼ˆå¯é€‰ï¼‰

1. **åç«¯ç¼“å­˜ï¼š**
   - ä½¿ç”¨ Redis ç¼“å­˜æ•™ç¨‹å†…å®¹
   - TTL: 1 å°æ—¶
   - å‡å°‘é‡å¤ä¸‹è½½

2. **CDN åŠ é€Ÿï¼š**
   - å°†åç«¯ä»£ç†ç«¯ç‚¹é…ç½®åˆ° CDN
   - å…¨çƒåŠ é€Ÿè®¿é—®

3. **å‹ç¼©ä¼ è¾“ï¼š**
   - å¯ç”¨ gzip å‹ç¼©
   - å‡å°‘å¸¦å®½æ¶ˆè€—

---

## ğŸ”’ å®‰å…¨æ€§æå‡

### ä¿®å¤å‰ï¼ˆç›´æ¥æš´éœ² R2 URLï¼‰
- âŒ å‰ç«¯å¯è§ R2 çš„å®Œæ•´ URL å’Œç­¾å
- âŒ ç”¨æˆ·å¯ä»¥ç›´æ¥ä¸‹è½½ R2 å†…å®¹ï¼ˆè™½ç„¶æœ‰ç­¾åï¼Œä½†ä»æœ‰é£é™©ï¼‰
- âŒ URL å¯èƒ½è¢«åˆ†äº«æˆ–æ»¥ç”¨

### ä¿®å¤åï¼ˆåç«¯ä»£ç†ï¼‰
- âœ… R2 URL ä»…åç«¯å¯è§
- âœ… åç«¯å¯ä»¥æ·»åŠ è®¿é—®æ§åˆ¶ï¼ˆå¦‚æ£€æŸ¥ç”¨æˆ·æƒé™ï¼‰
- âœ… åç«¯å¯ä»¥è®°å½•ä¸‹è½½æ—¥å¿—
- âœ… å¯ä»¥åŠ¨æ€é™æµã€é˜²æ­¢æ»¥ç”¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Cloudflare R2 CORS æ–‡æ¡£](https://developers.cloudflare.com/r2/buckets/cors/)
- [MDN CORS æ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
- `backend/docs/s3_download_usage.md` - S3 ä¸‹è½½ä½¿ç”¨æŒ‡å—
- `backend/docs/s3_download_implementation.md` - S3 ä¸‹è½½å®ç°æ–‡æ¡£

---

## âœ¨ æ€»ç»“

### é—®é¢˜
å‰ç«¯ç›´æ¥è®¿é—® R2 é¢„ç­¾å URL è¢« CORS é˜»æ­¢ï¼Œæ— æ³•åŠ è½½æ•™ç¨‹å†…å®¹ã€‚

### è§£å†³æ–¹æ¡ˆ
æ·»åŠ åç«¯ä»£ç†ç«¯ç‚¹ï¼Œå‰ç«¯é€šè¿‡åç«¯ä¸‹è½½å†…å®¹ï¼Œé¿å… CORS é—®é¢˜ã€‚

### ä¿®æ”¹æ–‡ä»¶
- âœ… `backend/app/api/v1/endpoints/tutorial.py` - æ–°å¢ä»£ç†ç«¯ç‚¹
- âœ… `frontend-next/lib/api/endpoints.ts` - ä¿®æ”¹ä¸‹è½½å‡½æ•°
- âœ… `frontend-next/app/(immersive)/roadmap/[id]/page.tsx` - æ›´æ–°è°ƒç”¨
- âœ… `frontend-next/components/tutorial/tutorial-dialog.tsx` - æ›´æ–°è°ƒç”¨

### æ•ˆæœ
- âœ… æ—  CORS é”™è¯¯
- âœ… æ•™ç¨‹å†…å®¹æ­£å¸¸æ˜¾ç¤º
- âœ… å®‰å…¨æ€§æå‡
- âœ… å¯æ‰©å±•æ€§å¢å¼º

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2025-12-26  
**ä¿®å¤ä½œè€…ï¼š** AI Assistant  
**æµ‹è¯•çŠ¶æ€ï¼š** â³ å¾…æµ‹è¯•

