# è·¯çº¿å›¾ä»»åŠ¡æ¶æ„é‡æ„æ–¹æ¡ˆï¼ˆç®€åŒ–ç‰ˆï¼‰

> **æ—¥æœŸ**: 2025-12-12  
> **ç±»å‹**: æ¶æ„æ”¹è¿›  
> **ä¼˜å…ˆçº§**: é«˜  
> **çŠ¶æ€**: ğŸ“‹ è®¾è®¡æ–¹æ¡ˆï¼ˆç®€åŒ–ç‰ˆï¼‰

---

## ğŸ“‹ æ ¸å¿ƒè®¾è®¡

### æ–¹æ¡ˆè°ƒæ•´

**ä¸å†åˆ›å»ºæ–°è¡¨**ï¼Œç›´æ¥åœ¨ç°æœ‰ `roadmap_tasks` è¡¨ä¸Šæ‰©å±•å­—æ®µï¼Œä¿æŒæ•°æ®æ¨¡å‹ç®€æ´ã€‚

### è¡¨ç»“æ„å˜æ›´

#### 1. `roadmap_tasks` è¡¨æ‰©å±•

```sql
-- ç°æœ‰å­—æ®µ
CREATE TABLE roadmap_tasks (
    task_id VARCHAR PRIMARY KEY,
    user_id VARCHAR NOT NULL,
    status VARCHAR DEFAULT 'pending',
    current_step VARCHAR DEFAULT 'init',
    user_request JSON,
    roadmap_id VARCHAR,  -- å·²æœ‰å­—æ®µ
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- âœ… æ–°å¢å­—æ®µ
ALTER TABLE roadmap_tasks 
    ADD COLUMN task_type VARCHAR,        -- 'creation', 'retry_tutorial', 'retry_resources', 'retry_quiz', 'retry_batch'
    ADD COLUMN concept_id VARCHAR,       -- å• Concept é‡è¯•æ—¶å¡«å†™
    ADD COLUMN content_type VARCHAR;     -- 'tutorial', 'resources', 'quiz'ï¼ˆå• Concept é‡è¯•æ—¶å¡«å†™ï¼‰

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_roadmap_tasks_roadmap_id_status ON roadmap_tasks(roadmap_id, status);
CREATE INDEX idx_roadmap_tasks_roadmap_id_created_at ON roadmap_tasks(roadmap_id, created_at DESC);
```

**å­—æ®µè¯´æ˜**ï¼š
- `task_type`: ä»»åŠ¡ç±»å‹ï¼ŒåŒºåˆ†åˆ›å»ºä»»åŠ¡å’Œé‡è¯•ä»»åŠ¡
- `concept_id`: å• Concept é‡è¯•æ—¶çš„æ¦‚å¿µ ID
- `content_type`: å• Concept é‡è¯•æ—¶çš„å†…å®¹ç±»å‹

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```sql
-- æŸ¥è¯¢è·¯çº¿å›¾çš„æ‰€æœ‰æ´»è·ƒä»»åŠ¡
SELECT * FROM roadmap_tasks 
WHERE roadmap_id = 'xxx' 
AND status IN ('pending', 'processing', 'human_review_pending')
ORDER BY created_at DESC;

-- æŸ¥è¯¢ç‰¹å®šæ¦‚å¿µçš„é‡è¯•ä»»åŠ¡
SELECT * FROM roadmap_tasks 
WHERE roadmap_id = 'xxx' 
AND concept_id = 'yyy'
AND content_type = 'tutorial'
ORDER BY created_at DESC;
```

#### 2. `roadmap_metadata` è¡¨æ¸…ç†

```sql
-- âœ… åˆ é™¤ task_id å­—æ®µï¼ˆä¸å†éœ€è¦ï¼‰
ALTER TABLE roadmap_metadata DROP COLUMN task_id;
```

**å½±å“è¯„ä¼°**ï¼šå·²æ£€æŸ¥æ‰€æœ‰ä½¿ç”¨ `metadata.task_id` çš„ä»£ç ï¼Œè§ä¸‹æ–‡ä¿®å¤æ–¹æ¡ˆã€‚

---

## ğŸ” ä»£ç å½±å“åˆ†æ

### ä½¿ç”¨ `metadata.task_id` çš„åœ°æ–¹

| æ–‡ä»¶ | è¡Œå· | ç”¨é€” | ä¿®å¤æ–¹æ¡ˆ |
|------|------|------|----------|
| `backend/app/api/v1/roadmap.py` | 246 | `get_roadmap_active_task` - è·å–æ´»è·ƒä»»åŠ¡ | æ”¹ä¸ºé€šè¿‡ `roadmap_id` æŸ¥è¯¢ |
| `backend/app/api/v1/roadmap.py` | 366 | `check_roadmap_status_quick` - æ£€æµ‹åƒµå°¸çŠ¶æ€ | æ”¹ä¸ºé€šè¿‡ `roadmap_id` æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒä»»åŠ¡ |
| `backend/app/api/v1/roadmap.py` | 1630 | `save_roadmap_metadata` è°ƒç”¨ | ç§»é™¤ `task_id` å‚æ•° |
| `backend/app/api/v1/endpoints/generation.py` | 395 | `save_roadmap` è°ƒç”¨ | ç§»é™¤ `task_id` å‚æ•° |
| `backend/app/api/v1/endpoints/retrieval.py` | 119 | `get_active_task` - è·å–æ´»è·ƒä»»åŠ¡ | æ”¹ä¸ºé€šè¿‡ `roadmap_id` æŸ¥è¯¢ |
| `backend/scripts/generate_tutorials_for_roadmap.py` | å¤šå¤„ | è„šæœ¬ä½¿ç”¨ | æ”¹ä¸ºé€šè¿‡ `roadmap_id` æŸ¥è¯¢ |

---

## ğŸ”§ å®æ–½æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šæ•°æ®åº“è¿ç§»

**æ–‡ä»¶**: `backend/alembic/versions/XXXX_refactor_roadmap_task_structure.py`

```python
"""é‡æ„è·¯çº¿å›¾ä»»åŠ¡æ¶æ„ï¼šæ‰©å±• roadmap_tasks è¡¨ï¼Œç§»é™¤ roadmap_metadata.task_id

Revision ID: XXXX
Revises: YYYY
Create Date: 2025-12-12
"""
from alembic import op
import sqlalchemy as sa

def upgrade():
    # 1. åœ¨ roadmap_tasks è¡¨ä¸Šæ·»åŠ æ–°å­—æ®µ
    op.add_column('roadmap_tasks', sa.Column('task_type', sa.String(), nullable=True))
    op.add_column('roadmap_tasks', sa.Column('concept_id', sa.String(), nullable=True))
    op.add_column('roadmap_tasks', sa.Column('content_type', sa.String(), nullable=True))
    
    # 2. ä¸ºç°æœ‰è®°å½•è®¾ç½®é»˜è®¤å€¼ï¼ˆæ‰€æœ‰ç°æœ‰ä»»åŠ¡éƒ½æ˜¯åˆ›å»ºä»»åŠ¡ï¼‰
    op.execute("""
        UPDATE roadmap_tasks 
        SET task_type = 'creation' 
        WHERE task_type IS NULL
    """)
    
    # 3. åˆ›å»ºç´¢å¼•ä»¥æå‡æŸ¥è¯¢æ€§èƒ½
    op.create_index('idx_roadmap_tasks_roadmap_id_status', 'roadmap_tasks', ['roadmap_id', 'status'])
    op.create_index('idx_roadmap_tasks_roadmap_id_created_at', 'roadmap_tasks', ['roadmap_id', 'created_at'], postgresql_using='btree', postgresql_order_by=['created_at DESC'])
    
    # 4. åˆ é™¤ roadmap_metadata.task_id å­—æ®µ
    op.drop_column('roadmap_metadata', 'task_id')

def downgrade():
    # æ¢å¤ roadmap_metadata.task_id
    op.add_column('roadmap_metadata', sa.Column('task_id', sa.String(), nullable=True))
    
    # ä» roadmap_tasks æ¢å¤æ•°æ®ï¼ˆæ¯ä¸ª roadmap å–æœ€æ—©çš„åˆ›å»ºä»»åŠ¡ï¼‰
    op.execute("""
        UPDATE roadmap_metadata m
        SET task_id = (
            SELECT t.task_id
            FROM roadmap_tasks t
            WHERE t.roadmap_id = m.roadmap_id
            AND t.task_type = 'creation'
            ORDER BY t.created_at ASC
            LIMIT 1
        )
    """)
    
    # åˆ é™¤ç´¢å¼•
    op.drop_index('idx_roadmap_tasks_roadmap_id_created_at', 'roadmap_tasks')
    op.drop_index('idx_roadmap_tasks_roadmap_id_status', 'roadmap_tasks')
    
    # åˆ é™¤æ–°å¢å­—æ®µ
    op.drop_column('roadmap_tasks', 'content_type')
    op.drop_column('roadmap_tasks', 'concept_id')
    op.drop_column('roadmap_tasks', 'task_type')
```

### ç¬¬ 2 æ­¥ï¼šæ›´æ–°æ•°æ®æ¨¡å‹

**æ–‡ä»¶**: `backend/app/models/database.py`

```python
class RoadmapTask(SQLModel, table=True):
    """è·¯çº¿å›¾ç”Ÿæˆä»»åŠ¡è¡¨"""
    __tablename__ = "roadmap_tasks"
    
    task_id: str = Field(primary_key=True)
    user_id: str = Field(index=True)
    
    # çŠ¶æ€è·Ÿè¸ª
    status: str = Field(default="pending")
    current_step: str = Field(default="init")
    
    # è¾“å…¥/è¾“å‡º
    user_request: dict = Field(sa_column=Column(JSON))
    roadmap_id: Optional[str] = Field(default=None, index=True)  # âœ… å·²æœ‰å­—æ®µ
    
    # âœ… æ–°å¢å­—æ®µ
    task_type: Optional[str] = Field(default=None)  # 'creation', 'retry_tutorial', 'retry_resources', 'retry_quiz', 'retry_batch'
    concept_id: Optional[str] = Field(default=None)  # å• Concept é‡è¯•æ—¶çš„æ¦‚å¿µ ID
    content_type: Optional[str] = Field(default=None)  # 'tutorial', 'resources', 'quiz'
    
    # æ—¶é—´æˆ³
    created_at: datetime = Field(default_factory=beijing_now, ...)
    updated_at: Optional[datetime] = Field(default=None, ...)


class RoadmapMetadata(SQLModel, table=True):
    """è·¯çº¿å›¾å…ƒæ•°æ®è¡¨"""
    __tablename__ = "roadmap_metadata"
    
    roadmap_id: str = Field(primary_key=True)
    user_id: str = Field(index=True)
    # âŒ åˆ é™¤ï¼štask_id: str = Field(index=True)
    
    title: str
    total_estimated_hours: float
    recommended_completion_weeks: int
    framework_data: dict = Field(sa_column=Column(JSON))
    
    created_at: datetime = Field(default_factory=beijing_now, ...)
    updated_at: Optional[datetime] = Field(default=None, ...)
```

### ç¬¬ 3 æ­¥ï¼šæ›´æ–° Repository æ–¹æ³•

**æ–‡ä»¶**: `backend/app/db/repositories/roadmap_repo.py`

```python
class RoadmapRepository:
    
    # âœ… æ›´æ–°ï¼šcreate_task æ–¹æ³•å¢åŠ æ–°å‚æ•°
    async def create_task(
        self,
        task_id: str,
        user_id: str,
        user_request: dict,
        task_type: str = "creation",  # âœ… æ–°å¢
        concept_id: str | None = None,  # âœ… æ–°å¢
        content_type: str | None = None,  # âœ… æ–°å¢
    ) -> RoadmapTask:
        """
        åˆ›å»ºè·¯çº¿å›¾ç”Ÿæˆä»»åŠ¡
        
        Args:
            task_id: ä»»åŠ¡ ID
            user_id: ç”¨æˆ· ID
            user_request: ç”¨æˆ·è¯·æ±‚ï¼ˆå­—å…¸æ ¼å¼ï¼‰
            task_type: ä»»åŠ¡ç±»å‹ï¼ˆ'creation', 'retry_tutorial', ...ï¼‰
            concept_id: æ¦‚å¿µ IDï¼ˆé‡è¯•ä»»åŠ¡éœ€è¦ï¼‰
            content_type: å†…å®¹ç±»å‹ï¼ˆé‡è¯•ä»»åŠ¡éœ€è¦ï¼‰
            
        Returns:
            åˆ›å»ºçš„ä»»åŠ¡è®°å½•
        """
        task = RoadmapTask(
            task_id=task_id,
            user_id=user_id,
            user_request=user_request,
            status="pending",
            current_step="init",
            task_type=task_type,  # âœ… æ–°å¢
            concept_id=concept_id,  # âœ… æ–°å¢
            content_type=content_type,  # âœ… æ–°å¢
        )
        self.session.add(task)
        await self.session.flush()
        
        logger.info("roadmap_task_created", 
                   task_id=task_id, 
                   user_id=user_id,
                   task_type=task_type)
        return task
    
    # âœ… æ–°å¢ï¼šè·å–è·¯çº¿å›¾çš„æ‰€æœ‰æ´»è·ƒä»»åŠ¡
    async def get_active_tasks_by_roadmap_id(
        self, 
        roadmap_id: str
    ) -> list[RoadmapTask]:
        """
        è·å–è·¯çº¿å›¾çš„æ‰€æœ‰æ´»è·ƒä»»åŠ¡ï¼ˆåŒ…æ‹¬åˆ›å»ºä»»åŠ¡å’Œé‡è¯•ä»»åŠ¡ï¼‰
        
        Args:
            roadmap_id: è·¯çº¿å›¾ ID
            
        Returns:
            æ´»è·ƒä»»åŠ¡åˆ—è¡¨ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´é™åºï¼‰
        """
        result = await self.session.execute(
            select(RoadmapTask)
            .where(
                RoadmapTask.roadmap_id == roadmap_id,
                RoadmapTask.status.in_(["pending", "processing", "human_review_pending"])
            )
            .order_by(RoadmapTask.created_at.desc())
        )
        return list(result.scalars().all())
    
    # âœ… æ›´æ–°ï¼šsave_roadmap_metadata ç§»é™¤ task_id å‚æ•°
    async def save_roadmap_metadata(
        self,
        roadmap_id: str,
        user_id: str,
        # âŒ åˆ é™¤ï¼štask_id: str,
        framework: RoadmapFramework,
    ) -> RoadmapMetadata:
        """
        ä¿å­˜è·¯çº¿å›¾å…ƒæ•°æ®
        
        Args:
            roadmap_id: è·¯çº¿å›¾ ID
            user_id: ç”¨æˆ· ID
            framework: è·¯çº¿å›¾æ¡†æ¶
            
        Returns:
            ä¿å­˜çš„è·¯çº¿å›¾å…ƒæ•°æ®
        """
        metadata = RoadmapMetadata(
            roadmap_id=roadmap_id,
            user_id=user_id,
            # âŒ åˆ é™¤ï¼štask_id=task_id,
            title=framework.title,
            total_estimated_hours=framework.total_estimated_hours,
            recommended_completion_weeks=framework.recommended_completion_weeks,
            framework_data=framework.model_dump(mode='json'),
            created_at=beijing_now(),
        )
        
        self.session.add(metadata)
        await self.session.flush()
        
        logger.info(
            "roadmap_metadata_saved",
            roadmap_id=roadmap_id,
            # âŒ åˆ é™¤ï¼štask_id=task_id,
        )
        
        return metadata
```

### ç¬¬ 4 æ­¥ï¼šä¿®å¤ API ç«¯ç‚¹

#### ä¿®å¤ 1: `backend/app/api/v1/roadmap.py`

```python
@router.get("/{roadmap_id}/active-task")
async def get_roadmap_active_task(
    roadmap_id: str,
    db: AsyncSession = Depends(get_db),
):
    """è·å–è·¯çº¿å›¾çš„æ´»è·ƒä»»åŠ¡"""
    repo = RoadmapRepository(db)
    
    # âœ… ä¿®å¤ï¼šä¸å†ä» metadata è·å– task_id
    # âŒ æ—§ä»£ç ï¼š
    # metadata = await repo.get_roadmap_metadata(roadmap_id)
    # task = await repo.get_task(metadata.task_id) if metadata.task_id else None
    
    # âœ… æ–°ä»£ç ï¼šç›´æ¥é€šè¿‡ roadmap_id æŸ¥è¯¢æ´»è·ƒä»»åŠ¡
    task = await repo.get_active_task_by_roadmap_id(roadmap_id)
    
    if not task:
        return {
            "roadmap_id": roadmap_id,
            "has_active_task": False,
            "task_id": None,
            "status": None,
        }
    
    return {
        "roadmap_id": roadmap_id,
        "has_active_task": True,
        "task_id": task.task_id,
        "status": task.status,
        "current_step": task.current_step,
        "task_type": task.task_type,  # âœ… æ–°å¢
        "concept_id": task.concept_id,  # âœ… æ–°å¢
        "content_type": task.content_type,  # âœ… æ–°å¢
    }


@router.get("/{roadmap_id}/status-check")
async def check_roadmap_status_quick(
    roadmap_id: str,
    db: AsyncSession = Depends(get_db),
):
    """
    å¿«é€Ÿæ£€æŸ¥è·¯çº¿å›¾çŠ¶æ€ï¼Œæ£€æµ‹åƒµå°¸çŠ¶æ€
    """
    repo = RoadmapRepository(db)
    
    metadata = await repo.get_roadmap_metadata(roadmap_id)
    if not metadata:
        raise HTTPException(status_code=404, detail="è·¯çº¿å›¾ä¸å­˜åœ¨")
    
    # âœ… ä¿®å¤ï¼šæ£€æŸ¥æ‰€æœ‰æ´»è·ƒä»»åŠ¡ï¼ˆä¸åªæ˜¯ metadata.task_idï¼‰
    # âŒ æ—§ä»£ç ï¼š
    # task = await repo.get_task(metadata.task_id) if metadata.task_id else None
    # has_active_task = task and task.status in ['pending', 'processing', 'human_review_pending']
    
    # âœ… æ–°ä»£ç ï¼š
    active_tasks = await repo.get_active_tasks_by_roadmap_id(roadmap_id)
    has_active_task = len(active_tasks) > 0
    
    if has_active_task:
        return {
            "roadmap_id": roadmap_id,
            "has_active_task": True,
            "active_tasks": [
                {
                    "task_id": task.task_id,
                    "task_type": task.task_type,
                    "status": task.status,
                    "current_step": task.current_step,
                    "concept_id": task.concept_id,
                    "content_type": task.content_type,
                }
                for task in active_tasks
            ],
            "stale_concepts": [],
        }
    
    # æ²¡æœ‰æ´»è·ƒä»»åŠ¡ï¼Œæ£€æŸ¥åƒµå°¸æ¦‚å¿µ
    framework_data = metadata.framework_data
    stale_concepts = []
    
    for stage in framework_data.get("stages", []):
        for module in stage.get("modules", []):
            for concept in module.get("concepts", []):
                for content_type, status_key in [
                    ("tutorial", "content_status"),
                    ("resources", "resources_status"),
                    ("quiz", "quiz_status"),
                ]:
                    status = concept.get(status_key)
                    if status in ["pending", "generating"]:
                        stale_concepts.append({
                            "concept_id": concept.get("concept_id"),
                            "concept_name": concept.get("name"),
                            "content_type": content_type,
                            "current_status": status,
                        })
    
    return {
        "roadmap_id": roadmap_id,
        "has_active_task": False,
        "active_tasks": [],
        "stale_concepts": stale_concepts,
    }


# âœ… ä¿®å¤ï¼šsave_roadmap_metadata è°ƒç”¨ï¼ˆç§»é™¤ task_id å‚æ•°ï¼‰
# ç¤ºä¾‹ï¼šåœ¨è·¯çº¿å›¾æ›´æ–°ç«¯ç‚¹ä¸­
await repo.save_roadmap_metadata(
    roadmap_id=roadmap_id,
    user_id=roadmap_metadata.user_id,
    # âŒ åˆ é™¤ï¼štask_id=roadmap_metadata.task_id,
    framework=updated_framework,
)
```

#### ä¿®å¤ 2: `backend/app/api/v1/endpoints/retrieval.py`

```python
@router.get("/{roadmap_id}/active-task")
async def get_active_task(
    roadmap_id: str,
    db: AsyncSession = Depends(get_db),
):
    """è·å–è·¯çº¿å›¾çš„æ´»è·ƒä»»åŠ¡"""
    repo = RoadmapRepository(db)
    
    # âœ… ä¿®å¤ï¼šä¸å†ä» metadata è·å–
    # âŒ æ—§ä»£ç ï¼š
    # metadata = await repo.get_roadmap_metadata(roadmap_id)
    # task = await repo.get_task(metadata.task_id) if metadata.task_id else None
    
    # âœ… æ–°ä»£ç ï¼š
    task = await repo.get_active_task_by_roadmap_id(roadmap_id)
    
    # ... rest of code
```

#### ä¿®å¤ 3: `backend/app/api/v1/endpoints/generation.py`

```python
# âœ… ä¿®å¤ï¼šsave_roadmap è°ƒç”¨ï¼ˆç§»é™¤ task_id å‚æ•°ï¼‰
await roadmap_repo.save_roadmap_metadata(
    roadmap_id=roadmap_id,
    user_id=roadmap_metadata.user_id,
    # âŒ åˆ é™¤ï¼štask_id=roadmap_metadata.task_id,
    framework=updated_framework,
)
```

### ç¬¬ 5 æ­¥ï¼šä¿®å¤é‡è¯•ç«¯ç‚¹

**æ–‡ä»¶**: `backend/app/api/v1/endpoints/generation.py`

```python
@router.post("/{roadmap_id}/concepts/{concept_id}/tutorial/retry")
async def retry_tutorial(...):
    task_id = _generate_retry_task_id(roadmap_id, concept_id, "tutorial")
    
    # âœ… ä¿®å¤ 1ï¼šåˆ›å»ºä»»åŠ¡è®°å½•ï¼ˆå¢åŠ æ–°å­—æ®µï¼‰
    async with repo_factory.create_session() as session:
        task_repo = repo_factory.create_task_repo(session)
        await task_repo.create_task(
            task_id=task_id,
            user_id=roadmap_metadata.user_id,  # ä» roadmap_metadata è·å–
            user_request={
                "type": "retry_tutorial",
                "roadmap_id": roadmap_id,
                "concept_id": concept_id,
                "preferences": request.preferences.model_dump(mode='json'),
            },
            task_type="retry_tutorial",  # âœ… æ–°å¢
            concept_id=concept_id,  # âœ… æ–°å¢
            content_type="tutorial",  # âœ… æ–°å¢
        )
        await task_repo.update_task_status(
            task_id=task_id,
            status="processing",
            current_step="tutorial_generation",
            roadmap_id=roadmap_id,
        )
        await session.commit()
    
    try:
        # ç”Ÿæˆæ•™ç¨‹...
        
        # âœ… ä¿®å¤ 2ï¼šå®Œæˆæ—¶æ›´æ–°ä»»åŠ¡çŠ¶æ€
        async with repo_factory.create_session() as session:
            task_repo = repo_factory.create_task_repo(session)
            await task_repo.update_task_status(
                task_id=task_id,
                status="completed",
                current_step="completed",
            )
            await session.commit()
            
    except Exception as e:
        # âœ… ä¿®å¤ 3ï¼šå¤±è´¥æ—¶æ›´æ–°ä»»åŠ¡çŠ¶æ€
        async with repo_factory.create_session() as session:
            task_repo = repo_factory.create_task_repo(session)
            await task_repo.update_task_status(
                task_id=task_id,
                status="failed",
                current_step="failed",
                error_message=str(e),
            )
            await session.commit()
        raise


# å¯¹ retry_resources å’Œ retry_quiz åšåŒæ ·çš„ä¿®å¤
@router.post("/{roadmap_id}/concepts/{concept_id}/resources/retry")
async def retry_resources(...):
    # ... åŒä¸Šï¼Œtask_type="retry_resources", content_type="resources"


@router.post("/{roadmap_id}/concepts/{concept_id}/quiz/retry")
async def retry_quiz(...):
    # ... åŒä¸Šï¼Œtask_type="retry_quiz", content_type="quiz"
```

### ç¬¬ 6 æ­¥ï¼šæ›´æ–°è·¯çº¿å›¾åˆ›å»ºæµç¨‹

**æ–‡ä»¶**: `backend/app/core/orchestrator/node_runners/curriculum_runner.py`

```python
async def _save_roadmap_framework(self, state: RoadmapState, framework):
    """ä¿å­˜è·¯çº¿å›¾æ¡†æ¶åˆ°æ•°æ®åº“"""
    task_id = state["task_id"]
    
    async with AsyncSessionLocal() as session:
        repo = RoadmapRepository(session)
        
        # âœ… ä¿®å¤ï¼šç§»é™¤ task_id å‚æ•°
        await repo.save_roadmap_metadata(
            roadmap_id=framework.roadmap_id,
            user_id=state["user_request"].user_id,
            # âŒ åˆ é™¤ï¼štask_id=task_id,
            framework=framework,
        )
        
        await session.commit()
```

---

## ğŸ“Š æ”¹è¿›å¯¹æ¯”

| æ–¹é¢ | æ”¹è¿›å‰ | æ”¹è¿›å |
|------|-------|--------|
| **è¡¨ç»“æ„** | 2 ä¸ªè¡¨ + task_id å†—ä½™ | 1 ä¸ªè¡¨ï¼ˆroadmap_tasksï¼‰âœ… |
| **Roadmap-Task å…³ç³»** | 1:1ï¼ˆåªæœ‰åˆ›å»ºä»»åŠ¡ï¼‰ | 1:Nï¼ˆåˆ›å»º + å¤šæ¬¡é‡è¯•ï¼‰âœ… |
| **é‡è¯•ä»»åŠ¡æŒä¹…åŒ–** | âŒ æœªä¿å­˜åˆ°æ•°æ®åº“ | âœ… ä¿å­˜åˆ° roadmap_tasks |
| **åƒµå°¸çŠ¶æ€æ£€æµ‹** | âŒ è¯¯æŠ¥ | âœ… å‡†ç¡®ï¼ˆæ£€æŸ¥æ‰€æœ‰ä»»åŠ¡ï¼‰ |
| **å®¡è®¡è¿½è¸ª** | âŒ ç¼ºå°‘é‡è¯•å†å² | âœ… å®Œæ•´å†å² |
| **æ•°æ®æ¨¡å‹** | âš ï¸ æœ‰å†—ä½™ | âœ… ç®€æ´å¹²å‡€ |
| **æŸ¥è¯¢å¤æ‚åº¦** | éœ€è¦ JOIN | å•è¡¨æŸ¥è¯¢ âœ… |

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### æ•°æ®åº“è¿ç§»
- [ ] è¿ç§»æ­£ç¡®æ·»åŠ æ–°å­—æ®µ
- [ ] ç°æœ‰æ•°æ®æ­£ç¡®è®¾ç½® task_type='creation'
- [ ] ç´¢å¼•æ­£ç¡®åˆ›å»º
- [ ] roadmap_metadata.task_id å­—æ®µæˆåŠŸåˆ é™¤
- [ ] å›æ»šåŠŸèƒ½æ­£å¸¸

### Repository å±‚
- [ ] `create_task()` æ­£ç¡®ä¿å­˜æ–°å­—æ®µ
- [ ] `get_active_tasks_by_roadmap_id()` è¿”å›æ‰€æœ‰æ´»è·ƒä»»åŠ¡
- [ ] `save_roadmap_metadata()` ä¸å†éœ€è¦ task_id å‚æ•°

### API ç«¯ç‚¹ä¿®å¤
- [ ] `get_roadmap_active_task` é€šè¿‡ roadmap_id æŸ¥è¯¢
- [ ] `check_roadmap_status_quick` æ£€æŸ¥æ‰€æœ‰æ´»è·ƒä»»åŠ¡
- [ ] æ‰€æœ‰ `save_roadmap_metadata` è°ƒç”¨å·²ç§»é™¤ task_id å‚æ•°

### é‡è¯•ç«¯ç‚¹
- [ ] `retry_tutorial` åˆ›å»ºä»»åŠ¡å¹¶å¡«å……æ–°å­—æ®µ
- [ ] `retry_resources` åˆ›å»ºä»»åŠ¡å¹¶å¡«å……æ–°å­—æ®µ
- [ ] `retry_quiz` åˆ›å»ºä»»åŠ¡å¹¶å¡«å……æ–°å­—æ®µ
- [ ] ä»»åŠ¡å®Œæˆæ—¶çŠ¶æ€æ›´æ–°
- [ ] ä»»åŠ¡å¤±è´¥æ—¶çŠ¶æ€æ›´æ–°

### åƒµå°¸çŠ¶æ€æ£€æµ‹
- [ ] é‡è¯•ä»»åŠ¡æ´»è·ƒæ—¶æ— è¯¯æŠ¥
- [ ] æ— ä»»åŠ¡æ´»è·ƒæ—¶æ­£ç¡®è¯†åˆ«åƒµå°¸æ¦‚å¿µ
- [ ] å“åº”ä¸­è¿”å›æ‰€æœ‰æ´»è·ƒä»»åŠ¡åŠç±»å‹ä¿¡æ¯

### ç«¯åˆ°ç«¯
- [ ] åˆ›å»ºè·¯çº¿å›¾ â†’ task_type='creation'
- [ ] é‡è¯•æ•™ç¨‹ â†’ æ–°ä»»åŠ¡åˆ›å»ºï¼Œtask_type='retry_tutorial'
- [ ] é‡è¯•æœŸé—´æ£€æŸ¥çŠ¶æ€ â†’ æ— è¯¯æŠ¥
- [ ] åˆ‡æ¢ tab åè¿”å› â†’ çŠ¶æ€å‡†ç¡®
- [ ] ä»»åŠ¡è¢« kill â†’ åƒµå°¸çŠ¶æ€æ­£ç¡®æ£€æµ‹
- [ ] roadmap_metadata æ—  task_id å­—æ®µï¼ŒåŠŸèƒ½æ­£å¸¸

---

## ğŸ“ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### æ•°æ®åº“å±‚
- [ ] `backend/alembic/versions/XXXX_refactor_roadmap_task_structure.py` - æ–°å»ºè¿ç§»
- [ ] `backend/app/models/database.py` - æ›´æ–°æ¨¡å‹

### Repository å±‚
- [ ] `backend/app/db/repositories/roadmap_repo.py` - æ›´æ–°æ–¹æ³•

### API å±‚
- [ ] `backend/app/api/v1/roadmap.py` - ä¿®å¤ 3 å¤„
- [ ] `backend/app/api/v1/endpoints/generation.py` - ä¿®å¤é‡è¯•ç«¯ç‚¹ + save è°ƒç”¨
- [ ] `backend/app/api/v1/endpoints/retrieval.py` - ä¿®å¤ 1 å¤„
- [ ] `backend/app/api/v1/endpoints/modification.py` - æ£€æŸ¥ save è°ƒç”¨
- [ ] `backend/app/api/v1/endpoints/retry.py` - æ£€æŸ¥æ‰¹é‡é‡è¯•

### Orchestrator å±‚
- [ ] `backend/app/core/orchestrator/node_runners/curriculum_runner.py` - ä¿®å¤ save è°ƒç”¨

### è„šæœ¬ï¼ˆå¯é€‰ï¼‰
- [ ] `backend/scripts/generate_tutorials_for_roadmap.py` - ä¿®å¤è„šæœ¬

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **âœ… æ•°æ®æ¨¡å‹æ›´ç®€æ´**ï¼šåªéœ€æ‰©å±•ç°æœ‰è¡¨ï¼Œæ— éœ€æ–°å»ºå…³è”è¡¨
2. **âœ… å®Œå…¨è§£è€¦**ï¼šroadmap_metadata ä¸å†ä¾èµ– task_id
3. **âœ… æŸ¥è¯¢æ›´é«˜æ•ˆ**ï¼šå•è¡¨æŸ¥è¯¢ï¼Œæ— éœ€ JOIN
4. **âœ… ä¸å‘åå…¼å®¹**ï¼šç›´æ¥æ”¹æˆæ­£ç¡®çš„é€»è¾‘ï¼Œå½»åº•è§£å†³é—®é¢˜

### å®æ–½å»ºè®®

1. **å…ˆè¿è¡Œè¿ç§»**ï¼Œç¡®ä¿æ•°æ®ç»“æ„æ­£ç¡®
2. **æ›´æ–° Repository å±‚**ï¼Œæä¾›æ–°çš„æŸ¥è¯¢æ–¹æ³•
3. **ä¿®å¤æ‰€æœ‰ API ç«¯ç‚¹**ï¼Œä½¿ç”¨æ–°çš„æŸ¥è¯¢é€»è¾‘
4. **å…¨é¢æµ‹è¯•**ï¼Œç¡®ä¿æ— é—æ¼

### è¿ç§»é£é™©

- âš ï¸ **åˆ é™¤ roadmap_metadata.task_id æ˜¯ä¸å¯é€†æ“ä½œ**
- âœ… ä½†è¿ç§»æ–‡ä»¶æä¾›äº† downgrade æ–¹æ¡ˆ
- âœ… å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯åå†åº”ç”¨åˆ°ç”Ÿäº§

---

**çŠ¶æ€**: âœ… **æ–¹æ¡ˆå°±ç»ªï¼Œå¯å¼€å§‹å®æ–½**

