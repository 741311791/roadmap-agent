# 前后端步骤枚举对照表

## 概述

本文档记录前后端工作流步骤枚举的完整对应关系，确保前后端状态同步的准确性。

## 核心概念区分

### 1. 工作流步骤 (WorkflowStep / current_step)

**用途**：表示工作流当前执行到哪个节点

**后端定义**：`backend/app/models/constants.py` - `WorkflowStep`  
**前端使用**：`frontend-next/components/task/workflow-topology.tsx` - `MAIN_STAGES` + `VALIDATION_BRANCH` + `REVIEW_BRANCH`

### 2. 任务状态 (TaskStatus / status)

**用途**：表示任务的整体状态

**后端定义**：`backend/app/models/constants.py` - `TaskStatus`  
**前端使用**：任务列表、详情页的状态显示

## 完整步骤对照表

| 后端 WorkflowStep 枚举值 | 前端节点映射 | 节点类型 | 说明 |
|-------------------------|------------|---------|------|
| `init` | Analysis | 主路 | 初始化 |
| `queued` | Analysis | 主路 | 已入队 |
| `starting` | Analysis | 主路 | 启动中 |
| `intent_analysis` | Analysis | 主路 | 需求分析 |
| `curriculum_design` | Design | 主路 | 课程设计 |
| `structure_validation` | Validate | 主路 | 结构验证 |
| `validation_edit_plan_analysis` | Plan (验证分支) | 分支 | 验证失败后的修改计划分析 |
| `roadmap_edit` + `editSource=validation_failed` | Edit (验证分支) | 分支 | 修复验证问题 |
| `human_review` | Review | 主路 | 人工审核 |
| `edit_plan_analysis` | Plan (审核分支) | 分支 | 用户反馈的修改计划分析 |
| `roadmap_edit` + `editSource=human_review` | Edit (审核分支) | 分支 | 应用用户反馈 |
| `content_generation_queued` | Content | 主路 | 内容生成已入队 |
| `content_generation` | Content | 主路 | 内容生成中 |
| `tutorial_generation` | Content | 主路 | 教程生成 |
| `resource_recommendation` | Content | 主路 | 资源推荐 |
| `quiz_generation` | Content | 主路 | 测验生成 |
| `finalizing` | Content | 主路 | 收尾中 |
| `completed` | - | 状态 | 通过任务状态判断 |
| `failed` | - | 状态 | 通过任务状态判断 |

## 前端节点定义

### 主路节点 (MAIN_STAGES)

```typescript
const MAIN_STAGES: WorkflowNode[] = [
  {
    id: 'analysis',
    label: 'Intent Analysis',
    steps: ['init', 'queued', 'starting', 'intent_analysis'],
  },
  {
    id: 'design',
    label: 'Curriculum Design',
    steps: ['curriculum_design'],
  },
  {
    id: 'validate',
    label: 'Structure Validation',
    steps: ['structure_validation'],
  },
  {
    id: 'review',
    label: 'Human Review',
    steps: ['human_review'],
  },
  {
    id: 'content',
    label: 'Content Generation',
    steps: [
      'content_generation_queued',
      'content_generation',
      'tutorial_generation',
      'resource_recommendation',
      'quiz_generation',
      'finalizing'  // 可选添加
    ],
  },
];
```

### 验证分支 (VALIDATION_BRANCH)

```typescript
const VALIDATION_BRANCH: WorkflowBranch = {
  id: 'validation_branch',
  triggerNode: 'validate',
  returnNode: 'validate',
  editSource: 'validation_failed',
  position: 'bottom',
  nodes: [
    {
      id: 'plan1',
      label: 'Edit Plan Analysis',
      steps: ['validation_edit_plan_analysis'],
    },
    {
      id: 'edit1',
      label: 'Roadmap Edit',
      steps: ['roadmap_edit'],  // 需要 editSource='validation_failed'
    },
  ],
};
```

### 审核分支 (REVIEW_BRANCH)

```typescript
const REVIEW_BRANCH: WorkflowBranch = {
  id: 'review_branch',
  triggerNode: 'review',
  returnNode: 'review',
  editSource: 'human_review',
  position: 'top',
  nodes: [
    {
      id: 'plan2',
      label: 'Edit Plan Analysis',
      steps: ['edit_plan_analysis'],
    },
    {
      id: 'edit2',
      label: 'Roadmap Edit',
      steps: ['roadmap_edit'],  // 需要 editSource='human_review'
    },
  ],
};
```

## 特殊处理逻辑

### 1. roadmap_edit 步骤的分支判断

`roadmap_edit` 步骤同时出现在两个分支中，需要通过 `editSource` 区分：

```typescript
function getStepLocation(currentStep: string, editSource?: EditSource) {
  if (currentStep === 'roadmap_edit') {
    if (editSource === 'validation_failed') {
      return { stageId: 'edit1', isOnBranch: true, branchType: 'validation' };
    }
    if (editSource === 'human_review') {
      return { stageId: 'edit2', isOnBranch: true, branchType: 'review' };
    }
  }
  // ... 其他逻辑
}
```

### 2. editSource 的传递机制

**后端发送**：
```python
# workflow_brain.py
extra_data = {}
edit_source = state.get("edit_source")
if edit_source:
    extra_data["edit_source"] = edit_source

await notification_service.publish_progress(
    task_id=task_id,
    step=node_name,
    status="processing",
    extra_data=extra_data,
)
```

**前端接收**：
```typescript
// page.tsx
if (event.data?.edit_source) {
  setEditSource(event.data.edit_source);
}
```

## 任务状态 vs 工作流步骤

### TaskStatus (status 字段)

| 枚举值 | 含义 | 使用场景 |
|--------|------|---------|
| `pending` | 待处理 | 任务创建但未开始 |
| `processing` | 处理中 | 工作流正在执行 |
| `human_review_pending` | 等待人工审核 | 工作流暂停，等待用户操作 |
| `completed` | 已完成 | 工作流成功完成 |
| `partial_failure` | 部分失败 | 部分内容生成失败 |
| `failed` | 失败 | 工作流执行失败 |
| `cancelled` | 已取消 | 用户取消任务 |

### 状态与步骤的关系示例

**场景1：人工审核阶段**
- `status = "human_review_pending"` （任务状态）
- `current_step = "human_review"` （工作流步骤）

**场景2：内容生成阶段**
- `status = "processing"` （任务状态）
- `current_step = "content_generation"` （工作流步骤）

**场景3：任务完成**
- `status = "completed"` （任务状态）
- `current_step = "completed"` （工作流步骤）

## 验证清单

### 后端检查
- [ ] `WorkflowStep` 枚举包含所有实际使用的步骤
- [ ] 代码中使用枚举值而非字符串字面量
- [ ] WebSocket 推送包含 `edit_source` 字段（当 `current_step = roadmap_edit` 时）

### 前端检查
- [ ] 所有后端步骤在前端节点定义中有映射
- [ ] `getStepLocation()` 能正确识别所有步骤
- [ ] `roadmap_edit` 步骤能根据 `editSource` 正确区分分支
- [ ] 不再出现 "Unrecognized currentStep" 警告

## 常见问题

### Q1: 为什么 human_review_pending 不在 WorkflowStep 中？

**A**: `human_review_pending` 是**任务状态**（TaskStatus），不是工作流步骤。工作流步骤是 `human_review`。

### Q2: content_generation_queued 是什么时候使用的？

**A**: 当内容生成任务提交到 Celery 队列后，在实际开始生成前的状态。表示任务已排队但尚未开始执行。

### Q3: 如何判断当前在哪个分支？

**A**: 通过 `editSource` 字段：
- `editSource = 'validation_failed'` → 验证分支
- `editSource = 'human_review'` → 审核分支
- `editSource = null` → 主路

## 修复历史

- **2025-01-01**: 添加 `content_generation_queued` 到 `WorkflowStep` 枚举
- **2025-01-01**: 修复 Intent Analysis 显示逻辑，包含 `intent_analysis` 步骤
- **2025-01-01**: 修复 Concept 节点状态更新延迟（乐观更新）
- **2025-01-01**: 修复重试任务导入路径错误

## 维护建议

1. **枚举同步**：修改步骤枚举时，同时更新前后端
2. **类型生成**：考虑使用代码生成工具自动同步类型
3. **E2E 测试**：添加测试验证所有步骤的显示正确性
4. **文档更新**：新增步骤时更新本对照表

