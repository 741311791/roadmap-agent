# WebSocket è¿žæŽ¥å¾ªçŽ¯é”™è¯¯è¯Šæ–­æŠ¥å‘Š

## é—®é¢˜çŽ°è±¡

**å‰ç«¯**ï¼šç–¯ç‹‚åˆ·æ–° WebSocket connect/close æ—¥å¿—ï¼ˆæ¯ 100ms ä¸€æ¬¡ï¼‰
**åŽç«¯**ï¼šæŒç»­æŠ¥é”™ï¼š
```
websocket_get_status_error error= task_id=f7415597-5828-480b-9691-5cc0265a6eb5
websocket_error error='Cannot call "send" once a close message has been sent.' 
                error_type=RuntimeError task_id=f7415597-5828-480b-9691-5cc0265a6eb5
```

## æ ¹æœ¬åŽŸå› åˆ†æž

### 1. **å‰ç«¯ URL æž„é€ é”™è¯¯** âš ï¸ ä¸»è¦åŽŸå› 

**ä½ç½®**ï¼š`frontend-next/lib/hooks/websocket/use-roadmap-generation-ws.ts:215`

```typescript
// âŒ é”™è¯¯çš„ URL æž„é€ 
const url = `${wsUrl}/ws/${taskId}?include_history=true`;
```

**é—®é¢˜**ï¼šç¼ºå°‘ `/api/v1` è·¯å¾„å‰ç¼€

**æ­£ç¡® URL**ï¼šåº”è¯¥æ˜¯ `ws://localhost:8000/api/v1/ws/{taskId}`

**å½±å“**ï¼š
- è¿žæŽ¥åˆ°é”™è¯¯çš„ç«¯ç‚¹
- æœåŠ¡å™¨ç«‹å³æ‹’ç»è¿žæŽ¥
- WebSocket è¿žæŽ¥åœ¨æ¡æ‰‹é˜¶æ®µå°±å¤±è´¥

### 2. **åŽç«¯å¼‚å¸¸å¤„ç†ç¼ºé™·** âš ï¸ æ¬¡è¦åŽŸå› 

**ä½ç½®**ï¼š`backend/app/api/v1/websocket.py:202-212`

```python
async def _send_current_status(websocket: WebSocket, task_id: str):
    try:
        # ... æ•°æ®åº“æŸ¥è¯¢ ...
    except Exception as e:
        logger.error(...)
        # âŒ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥ WebSocket æ˜¯å¦ä»ç„¶æ‰“å¼€
        await websocket.send_json({
            "type": "error",
            "task_id": task_id,
            "message": f"èŽ·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥: {str(e)}",
        })
```

**é—®é¢˜**ï¼š
- åœ¨ exception handler ä¸­å°è¯•å‘é€é”™è¯¯æ¶ˆæ¯
- ä½†æ­¤æ—¶ WebSocket å¯èƒ½å·²ç»å…³é—­
- å¯¼è‡´äºŒæ¬¡é”™è¯¯ï¼š`RuntimeError: Cannot call "send" once a close message has been sent.`

### 3. **å‰ç«¯é‡è¿žå¾ªçŽ¯** ðŸ”„

**ä½ç½®**ï¼š`frontend-next/lib/hooks/websocket/use-roadmap-generation-ws.ts:248-258`

```typescript
ws.onclose = (event) => {
  // ...
  if (!event.wasClean && reconnectAttemptsRef.current < maxReconnectAttempts) {
    reconnectAttemptsRef.current++;
    const delay = Math.min(
      1000 * Math.pow(2, reconnectAttemptsRef.current),
      30000
    );
    console.log(`[WS] Reconnecting in ${delay}ms...`);
    setTimeout(connect, delay);  // âŒ ä½¿ç”¨ç›¸åŒçš„é”™è¯¯ URL é‡è¿ž
  }
}
```

**é—®é¢˜**ï¼š
- æ£€æµ‹åˆ°å…³é—­åŽè‡ªåŠ¨é‡è¿ž
- ä½†é‡è¿žä½¿ç”¨çš„ä»æ˜¯é”™è¯¯çš„ URL
- å½¢æˆæ— é™é‡è¿žå¾ªçŽ¯

## é”™è¯¯è°ƒç”¨é“¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‰ç«¯å‘èµ·è¿žæŽ¥                                                     â”‚
â”‚    URL: ws://localhost:8000/ws/{taskId} âŒ (é”™è¯¯ - ç¼ºå°‘ /api/v1)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åŽç«¯æŽ¥æ”¶è¿žæŽ¥                                                     â”‚
â”‚    - è·¯ç”±ä¸åŒ¹é…ï¼Œæ¡æ‰‹å¤±è´¥                                            â”‚
â”‚    - WebSocket ç«‹å³å…³é—­                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åŽç«¯å°è¯•å‘é€åˆå§‹çŠ¶æ€ (_send_current_status)                      â”‚
â”‚    - ä½†è¿žæŽ¥å·²å…³é—­                                                   â”‚
â”‚    - æŠ›å‡º RuntimeError: Cannot call "send" ...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‰ç«¯æ£€æµ‹åˆ°å…³é—­äº‹ä»¶                                               â”‚
â”‚    - event.wasClean = false                                      â”‚
â”‚    - è§¦å‘è‡ªåŠ¨é‡è¿žé€»è¾‘                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å‰ç«¯é‡è¿žï¼ˆä½¿ç”¨ç›¸åŒçš„é”™è¯¯ URLï¼‰                                    â”‚
â”‚    - è¿”å›žæ­¥éª¤ 1                                                    â”‚
â”‚    - å½¢æˆæ— é™å¾ªçŽ¯ ðŸ”„                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ—¥å¿—è¯æ®

ä»ŽåŽç«¯æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š
```
INFO:     127.0.0.1:52540 - "WebSocket /ws/f7415597-5828-480b-9691-5cc0265a6eb5?include_history=true" [accepted]
2025-12-07 12:27:10 [info] websocket_connected task_id=... total_connections=1
INFO:     connection open
INFO:     connection closed  â† ç«‹å³å…³é—­ï¼
2025-12-07 12:27:10 [error] websocket_get_status_error error= task_id=...
2025-12-07 12:27:10 [error] websocket_error error='Cannot call "send" once...'
```

**æ—¶åº**ï¼š
- è¿žæŽ¥å»ºç«‹ â†’ ç«‹å³å…³é—­ï¼ˆ< 20msï¼‰
- å°è¯•å‘é€çŠ¶æ€ â†’ å¤±è´¥ï¼ˆè¿žæŽ¥å·²å…³é—­ï¼‰
- æ¯ 100ms é‡å¤ä¸€æ¬¡

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šå‰ç«¯ URL æž„é€  âœ… å¿…é¡»

**æ–‡ä»¶**ï¼š`frontend-next/lib/hooks/websocket/use-roadmap-generation-ws.ts`

```typescript
// ä¿®æ”¹ line 215
- const url = `${wsUrl}/ws/${taskId}?include_history=true`;
+ const url = `${wsUrl}/api/v1/ws/${taskId}?include_history=true`;
```

### ä¿®å¤ 2ï¼šåŽç«¯å¼‚å¸¸å¤„ç† âœ… æŽ¨è

**æ–‡ä»¶**ï¼š`backend/app/api/v1/websocket.py`

```python
async def _send_current_status(websocket: WebSocket, task_id: str):
    """å‘é€ä»»åŠ¡çš„å½“å‰çŠ¶æ€"""
    try:
        async with AsyncSessionLocal() as session:
            repo = RoadmapRepository(session)
            task = await repo.get_task(task_id)
            
            if task:
                await websocket.send_json({...})
            else:
                await websocket.send_json({...})
    
    except Exception as e:
        logger.error("websocket_get_status_error", task_id=task_id, error=str(e))
        
        # âœ… ä¿®å¤ï¼šå‘é€å‰æ£€æŸ¥è¿žæŽ¥çŠ¶æ€
        try:
            if websocket.client_state == WebSocketState.CONNECTED:
                await websocket.send_json({
                    "type": "error",
                    "task_id": task_id,
                    "message": f"èŽ·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥: {str(e)}",
                })
        except Exception as send_error:
            logger.debug(
                "websocket_already_closed",
                task_id=task_id,
                error=str(send_error)
            )
```

### ä¿®å¤ 3ï¼šå‰ç«¯é‡è¿žé€€é¿ç­–ç•¥ âœ… å·²å®žçŽ°ï¼ˆä½†ä½¿ç”¨é”™è¯¯çš„URLï¼‰

å‰ç«¯å·²ç»å®žçŽ°äº†æŒ‡æ•°é€€é¿ï¼ˆexponential backoffï¼‰ï¼Œä½†ç”±äºŽ URL é”™è¯¯ï¼Œé‡è¿žæ°¸è¿œä¸ä¼šæˆåŠŸã€‚
ä¿®å¤ URL åŽï¼ŒçŽ°æœ‰çš„é‡è¿žé€»è¾‘å°±èƒ½æ­£å¸¸å·¥ä½œã€‚

## æµ‹è¯•éªŒè¯

ä¿®å¤åŽæµ‹è¯•ï¼š

```bash
# 1. æ¸…é™¤æ—§ä»»åŠ¡æ•°æ®
cd backend
python scripts/clear_all_data.py

# 2. é‡å¯åŽç«¯ï¼ˆåº”ç”¨ä¿®å¤ï¼‰
# Ctrl+C åœæ­¢ï¼Œç„¶åŽé‡æ–°è¿è¡Œ
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 3. é‡å¯å‰ç«¯ï¼ˆåº”ç”¨ä¿®å¤ï¼‰
cd ../frontend-next
npm run dev

# 4. æµ‹è¯•è·¯çº¿å›¾ç”Ÿæˆ
# è®¿é—® http://localhost:3000/app/new
# æäº¤è¡¨å•ï¼Œè§‚å¯Ÿæµè§ˆå™¨æŽ§åˆ¶å°å’ŒåŽç«¯æ—¥å¿—

# âœ… æœŸæœ›ç»“æžœï¼š
# - å‰ç«¯ï¼š[WS] Connected
# - å‰ç«¯ï¼š[WS] Message: connected
# - åŽç«¯ï¼šwebsocket_connected task_id=...
# - æ— é”™è¯¯æ—¥å¿—
```

## æ€»ç»“

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|------|---------|------|
| å‰ç«¯ URL æž„é€ é”™è¯¯ | ðŸ”´ Critical | å¾…ä¿®å¤ |
| åŽç«¯å¼‚å¸¸å¤„ç†ç¼ºé™· | ðŸŸ¡ Medium | å¾…ä¿®å¤ |
| æ— é™é‡è¿žå¾ªçŽ¯ | ðŸ”´ Critical | URL ä¿®å¤åŽè‡ªåŠ¨è§£å†³ |

**é¢„è®¡ä¿®å¤æ—¶é—´**ï¼š15 åˆ†é’Ÿ
**å½±å“èŒƒå›´**ï¼šæ‰€æœ‰ä½¿ç”¨ WebSocket çš„è·¯çº¿å›¾ç”ŸæˆåŠŸèƒ½
**ä¿®å¤ä¼˜å…ˆçº§**ï¼šðŸ”¥ æœ€é«˜

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-12-07  
**ä»»åŠ¡ ID**ï¼šf7415597-5828-480b-9691-5cc0265a6eb5

